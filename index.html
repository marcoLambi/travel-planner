<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Planner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SHEETJS FOR EXCEL -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        .loader {
            border: 3px solid #fff7ed; /* orange-50 */
            border-top: 3px solid #fb923c; /* orange-400 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #fff7ed; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #fb923c; }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Safe area utility for modern phones */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Car Icon Animation */
        .car-icon-div {
            transition: transform 0.1s linear; /* Smooth rotation if implemented, or position updates */
            z-index: 1000 !important;
        }
        /* Map Button Background Pattern */
        .bg-map-pattern {
            background-color: #e5e7eb;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239ca3af' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-700 font-sans h-screen overflow-hidden flex flex-col">

    <!-- App Container (Full Width) -->
    <div class="w-full h-full bg-white shadow-2xl relative flex flex-col">
        
        <!-- Header -->
        <header class="bg-orange-400 text-white p-4 shadow-md z-20 flex items-center justify-between transition-colors duration-300" id="main-header">
            <div class="flex items-center gap-3 overflow-hidden">
                <button id="back-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors flex-shrink-0">
                    <i class="ph ph-arrow-left text-xl"></i>
                </button>
                <div class="flex flex-col overflow-hidden">
                    <h1 id="header-title" class="text-xl font-bold truncate flex items-center gap-2">
                        <i class="ph-fill ph-airplane-tilt"></i> Travel Planner
                    </h1>
                    <span id="header-subtitle" class="text-xs text-orange-50 truncate hidden"></span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- LOGS BUTTON -->
                <button id="logs-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors" title="Registro Accessi">
                    <i class="ph-fill ph-eye text-xl"></i>
                </button>
                <!-- IMPORT BUTTON -->
                <button id="import-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors" title="Importa Excel">
                    <i class="ph ph-upload-simple text-xl"></i>
                </button>
                <input type="file" id="import-input" accept=".xlsx, .xls" class="hidden">
                
                <button id="export-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors" title="Scarica Excel">
                    <i class="ph ph-download-simple text-xl"></i>
                </button>
                <button id="logout-btn" class="hidden text-xs bg-orange-600/30 hover:bg-orange-600/50 px-3 py-1 rounded transition-colors flex items-center gap-1">
                    <i class="ph ph-sign-out"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow relative overflow-hidden bg-stone-50">
            
            <!-- VIEW 1: Login -->
            <div id="login-view" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-50 p-6 text-center">
                <div class="p-5 bg-orange-50 rounded-full mb-6 text-orange-400">
                    <i class="ph ph-map-trifold text-6xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-stone-800">Travel Planner</h2>
                <p class="text-stone-500 mb-6 text-sm">Accedi con la tua chiave segreta.</p>
                
                <div class="w-full max-w-xs mb-4 relative mx-auto">
                    <input type="text" id="secret-key-input" class="w-full p-4 pl-12 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-orange-400 outline-none font-bold text-stone-700 tracking-wide placeholder-stone-400" placeholder="es. USA2025">
                    <i class="ph ph-key absolute left-4 top-1/2 transform -translate-y-1/2 text-stone-400 text-xl"></i>
                </div>
                
                <button id="login-btn" class="bg-orange-400 hover:bg-orange-500 text-white w-full max-w-xs py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 mb-4 transition-transform active:scale-95 mx-auto">
                    <span>Entra</span> <i class="ph ph-arrow-right"></i>
                </button>

                <div id="auth-loader" class="hidden loader border-t-orange-400 mt-4 mx-auto"></div>
                <p id="login-error" class="hidden text-red-500 text-sm mt-2"></p>
            </div>

            <!-- VIEW 2: Lista Giorni -->
            <div id="days-view" class="absolute inset-0 flex flex-col hidden overflow-hidden">
                <div class="bg-orange-50 p-2 text-center text-xs text-orange-800 font-medium border-b border-orange-100 flex justify-between px-4 items-center flex-shrink-0">
                    <span>Viaggio: <span id="current-key-display" class="font-bold">...</span></span>
                    <span class="text-[10px] text-orange-400">ID: <span id="app-id-display">...</span></span>
                </div>
                
                <!-- Lista scrollabile -->
                <div class="flex-grow overflow-y-auto p-4 pb-32 custom-scroll" id="days-list-container">
                    <div id="loading-days" class="flex justify-center mt-10"><div class="loader border-t-orange-400"></div></div>
                    <div id="empty-days" class="hidden flex flex-col items-center justify-center mt-20 text-stone-400">
                        <i class="ph ph-road-horizon text-5xl mb-3 text-stone-300"></i>
                        <p>Nessun giorno pianificato.</p>
                    </div>
                    <!-- NEW: Riga conteggio giorni/notti nel diario -->
                    <div id="diary-duration-line" class="text-xs text-stone-400 font-bold text-center mb-3 hidden"></div>
                    <div id="days-list" class="space-y-3 max-w-3xl mx-auto"></div>
                </div>

                <!-- Pulsante flottante -->
                <button id="floating-plus-btn" onclick="openModal(null)" class="absolute bottom-20 right-6 bg-orange-400 hover:bg-orange-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-20 border-2 border-white">
                    <i class="ph ph-plus text-2xl font-bold"></i>
                </button>
            </div>

            <!-- VIEW 3: Riepilogo Totale (Stats) -->
            <div id="summary-view" class="absolute inset-0 flex flex-col hidden overflow-hidden pb-0 bg-stone-100">
                <div class="flex-grow overflow-y-auto custom-scroll p-4 pb-28"> 
                    <div class="max-w-4xl mx-auto">
                        <!-- NEW GLOBAL SETTINGS TOGGLES -->
                        <div class="grid grid-cols-2 gap-2 mb-6">
                            <!-- Miles Toggle -->
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-200 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <i class="ph-bold ph-gear text-stone-400"></i>
                                    <span class="text-sm font-bold text-stone-700">Abilita unità Miglia (USA/UK)</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="global-miles-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                                </label>
                            </div>

                            <!-- USD Toggle -->
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-200 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <i class="ph-bold ph-currency-dollar text-stone-400"></i>
                                    <span class="text-sm font-bold text-stone-700">Abilita valuta USD</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="global-usd-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                </label>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6 border border-stone-200 w-full mb-6">
                            <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-stone-800">Riepilogo Viaggio</h2>
                                    <p class="text-sm text-stone-400">Statistiche generali</p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-full text-orange-500">
                                    <i class="ph-fill ph-chart-pie-slice text-2xl"></i>
                                </div>
                            </div>

                            <!-- NEW ROW: Counts (Updated grid to 3 cols or just added one more) -->
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                                <!-- Card Durata (NEW) -->
                                <div class="bg-orange-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-orange-100 col-span-2 sm:col-span-1">
                                    <div class="bg-orange-100 p-2 rounded-full text-orange-600 mb-2"><i class="ph-bold ph-calendar text-xl"></i></div>
                                    <span class="text-[10px] font-bold text-stone-500 uppercase">Durata Totale</span>
                                    <span class="text-lg font-black text-orange-600" id="summ-view-duration">0gg / 0nt</span>
                                </div>
                                <!-- Card Stati -->
                                <div class="bg-purple-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-purple-100">
                                    <div class="bg-purple-100 p-2 rounded-full text-purple-600 mb-2"><i class="ph-bold ph-flag text-xl"></i></div>
                                    <span class="text-[10px] font-bold text-stone-500 uppercase">Stati Visitati</span>
                                    <span class="text-2xl font-black text-purple-600" id="summ-view-states">0</span>
                                </div>
                                <!-- Card Tappe Visitate -->
                                <div class="bg-pink-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-pink-100">
                                    <div class="bg-pink-100 p-2 rounded-full text-pink-600 mb-2"><i class="ph-bold ph-map-pin text-xl"></i></div>
                                    <span class="text-[10px] font-bold text-stone-500 uppercase">Tappe Visitate</span>
                                    <span class="text-2xl font-black text-pink-600" id="summ-view-stages">0</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <!-- Card Auto -->
                                <div class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                    <div class="bg-amber-100 p-3 rounded-full text-amber-600 mb-2"><i class="ph-bold ph-car text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Ore Guida</span>
                                    <span class="text-2xl font-bold text-amber-500" id="summ-view-drive">--</span>
                                </div>
                                <!-- Card Miglia (CONDITIONAL) -->
                                <div id="card-miles-container" class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                    <div class="bg-blue-100 p-3 rounded-full text-blue-600 mb-2"><i class="ph-bold ph-signpost text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Miglia Totali</span>
                                    <span class="text-2xl font-bold text-stone-700" id="summ-view-miles">--</span>
                                </div>
                                <!-- Card Km -->
                                <div class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border-l-4 border-green-500">
                                    <div class="bg-green-100 p-3 rounded-full text-green-600 mb-2"><i class="ph-bold ph-globe text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Km Totali</span>
                                    <span class="text-3xl font-black text-green-600" id="summ-view-km">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Riepilogo Tappe (Moved from Totali) -->
                        <div class="bg-white rounded-2xl shadow-xl p-4 border border-stone-200 w-full mb-6">
                            <h3 class="text-sm font-bold text-stone-600 mb-4 uppercase flex items-center gap-2 pl-2 border-l-4 border-orange-400">
                                <i class="ph-bold ph-list-numbers text-orange-500"></i> Riepilogo Tappe Visitate
                            </h3>
                            <div id="all-stages-summary" class="space-y-4">
                                <!-- Popolato da JS -->
                            </div>
                        </div>

                        <!-- CHART SECTION -->
                        <div class="bg-white rounded-2xl shadow-xl p-4 border border-stone-200 w-full mb-6">
                            <h3 class="text-sm font-bold text-stone-600 uppercase mb-4 pl-2 border-l-4 border-orange-400">Analisi Giornaliera</h3>
                            <div class="h-96 w-full">
                                <canvas id="activityChart"></canvas>
                            </div>
                            <p class="text-[10px] text-center text-stone-400 mt-2">
                                <span class="inline-block w-2 h-2 rounded-full bg-orange-400 mr-1"></span>% Ore Guida
                                <span class="inline-block w-2 h-2 rounded-full bg-stone-300 ml-3 mr-1"></span>% Resto della Giornata
                            </p>
                        </div>

                        <!-- HIGHLIGHTS SECTION -->
                        <div class="grid grid-cols-2 gap-4 w-full mb-6">
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex flex-col items-center text-center shadow-sm">
                                <div class="bg-red-100 text-red-500 p-2 rounded-full mb-2"><i class="ph-fill ph-fire text-xl"></i></div>
                                <span class="text-[10px] font-bold text-stone-500 uppercase">Giorno Più Intenso</span>
                                <div class="font-bold text-red-600 text-lg mt-1" id="high-intense-day">--</div>
                                <div class="text-xs text-stone-400 font-mono" id="high-intense-val">--</div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl border border-amber-100 flex flex-col items-center text-center shadow-sm">
                                <div class="bg-amber-100 text-amber-500 p-2 rounded-full mb-2"><i class="ph-fill ph-steering-wheel text-xl"></i></div>
                                <span class="text-[10px] font-bold text-stone-500 uppercase">Più Ore Auto</span>
                                <div class="font-bold text-amber-600 text-lg mt-1" id="high-drive-day">--</div>
                                <div class="text-xs text-stone-400 font-mono" id="high-drive-val">--</div>
                            </div>
                        </div>

                        <!-- TRAVEL REEL / VIDEO SECTION -->
                        <div class="bg-gradient-to-r from-orange-400 to-amber-500 rounded-2xl shadow-xl p-6 text-white w-full mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i class="ph-fill ph-video-camera text-9xl"></i>
                            </div>
                            <div class="relative z-10">
                                <h3 class="text-xl font-bold flex items-center gap-2 mb-2"><i class="ph-fill ph-film-strip"></i> Travel Reel</h3>
                                <p class="text-sm text-orange-50 mb-4 pr-10">Rivivi il tuo viaggio! Guarda l'animazione del percorso sulla mappa.</p>
                                
                                <div id="map-video-container" class="w-full h-64 bg-white rounded-xl shadow-inner mb-4 hidden overflow-hidden relative group">
                                    <div id="travel-video-map" class="w-full h-full z-0"></div>
                                    
                                    <!-- Controlli Video -->
                                    <div id="video-controls" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-30 flex items-center gap-4 bg-black/60 backdrop-blur-md px-4 py-2 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                        <div class="flex gap-1 bg-white/20 rounded-lg p-1">
                                            <button onclick="setVideoSpeed(0.5)" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-white/30 transition-colors speed-btn" id="btn-speed-05">0.5x</button>
                                            <button onclick="setVideoSpeed(1)" class="text-[10px] font-bold px-2 py-1 rounded bg-white text-black transition-colors speed-btn" id="btn-speed-1">1x</button>
                                            <button onclick="setVideoSpeed(2)" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-white/30 transition-colors speed-btn" id="btn-speed-2">2x</button>
                                        </div>
                                        <div class="w-px h-6 bg-white/30"></div>
                                        <button onclick="toggleVideoFullscreen()" class="hover:text-orange-300 transition-colors" title="Schermo Intero">
                                            <i class="ph-bold ph-arrows-out text-xl"></i>
                                        </button>
                                    </div>

                                    <div id="video-overlay-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-black/50 z-20 hidden">
                                        <div class="text-white font-bold text-lg" id="video-status-text">Caricamento mappa...</div>
                                    </div>
                                </div>

                                <button onclick="playTravelVideo()" id="play-video-btn" class="bg-white text-orange-500 hover:bg-orange-50 font-bold py-2 px-6 rounded-xl shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                                    <i class="ph-fill ph-play-circle text-2xl"></i> Avvia Animazione
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 5: SPESE LISTA (Tab 3) -->
            <div id="expenses-view" class="absolute inset-0 flex flex-col hidden bg-stone-50 z-10">
                <!-- Header Colonne Lista - ADDED ID -->
                <div id="expenses-header" class="bg-white p-3 shadow-sm border-b border-stone-200 z-20 flex justify-between text-[10px] uppercase font-bold text-stone-400 max-w-4xl mx-auto w-full">
                    <span class="w-1/3">Voce</span>
                    <div class="flex gap-4 w-2/3 justify-end pr-14">
                        <span>Euro (€)</span>
                        <span id="expenses-header-usd">USD ($)</span> <!-- ADDED ID -->
                    </div>
                </div>

                <!-- Lista Spese -->
                <div class="flex-grow overflow-y-auto p-4 custom-scroll pb-52 w-full" id="expenses-list-container">
                    <div id="loading-expenses" class="hidden flex justify-center mt-10"><div class="loader border-t-emerald-400"></div></div>
                    <div id="empty-expenses" class="hidden flex flex-col items-center justify-center mt-10 text-stone-400">
                        <i class="ph ph-receipt text-5xl mb-3 text-stone-300"></i>
                        <p class="text-sm">Nessuna spesa registrata.</p>
                    </div>
                    <div id="expenses-list" class="space-y-2 max-w-4xl mx-auto"></div>
                </div>

                <!-- Input Bar (Fixed Bottom) - ADIACENTE alla navigazione -->
                <div class="fixed bottom-[calc(3rem+env(safe-area-inset-bottom,0px))] left-0 w-full bg-white p-2 border-t border-stone-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-30">
                    <div class="max-w-4xl mx-auto flex flex-col gap-2">
                        <!-- Row 1: Inputs -->
                        <div class="flex gap-2 items-center">
                            <div class="flex-grow flex gap-1">
                                <input type="text" id="expense-name-input" class="w-1/2 p-2 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs" placeholder="Voce spesa..." autocomplete="off">
                                <input type="text" id="expense-link-input" class="w-1/2 p-2 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs" placeholder="Link (opz.)" autocomplete="off">
                            </div>
                            
                            <!-- Moltiplicatore (Qtà) -->
                            <div class="relative w-12 flex-shrink-0">
                                <label class="absolute -top-2 left-1 text-[8px] text-stone-400 font-bold bg-white px-1">Qtà</label>
                                <input type="number" id="expense-qty-input" min="1" max="20" value="1" class="w-full p-2 text-center rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-bold text-stone-600">
                            </div>

                            <div class="relative w-16 flex-shrink-0">
                                <input type="number" step="0.01" id="expense-amount-input" class="w-full p-2 pl-5 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-mono" placeholder="0">
                                <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">€</span>
                            </div>

                            <div id="expenses-input-usd" class="relative w-16 flex-shrink-0"> <!-- ADDED ID -->
                                <input type="number" step="0.01" id="expense-amount-usd-input" class="w-full p-2 pl-5 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-mono bg-stone-50" placeholder="0">
                                <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">$</span>
                            </div>

                            <button id="add-expense-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-lg shadow-md active:scale-95 transition-transform flex-shrink-0">
                                <i class="ph ph-plus text-lg font-bold"></i>
                            </button>
                        </div>
                        
                        <!-- Row 2: Categories -->
                        <div class="flex flex-wrap gap-2 text-[10px] font-bold text-stone-500 pb-1">
                             <label class="flex items-center gap-1 cursor-pointer flex-shrink-0"><input type="radio" name="new-expense-cat" value="Pernottamenti" class="accent-emerald-500"> Pernottamenti</label>
                             <label class="flex items-center gap-1 cursor-pointer flex-shrink-0"><input type="radio" name="new-expense-cat" value="Pasti" class="accent-emerald-500"> Pasti</label>
                             <label class="flex items-center gap-1 cursor-pointer flex-shrink-0"><input type="radio" name="new-expense-cat" value="Carburante" class="accent-emerald-500"> Carburante</label>
                             <label class="flex items-center gap-1 cursor-pointer flex-shrink-0"><input type="radio" name="new-expense-cat" value="Attrazioni" class="accent-emerald-500"> Attrazioni</label>
                             <label class="flex items-center gap-1 cursor-pointer flex-shrink-0"><input type="radio" name="new-expense-cat" value="Pass e Tasse" class="accent-emerald-500"> Pass e Tasse</label>
                             <label class="flex items-center gap-1 cursor-pointer flex-shrink-0"><input type="radio" name="new-expense-cat" value="Altro" class="accent-emerald-500" checked> Altro</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: BUDGET / TOTALI (Tab 4) -->
            <div id="budget-view" class="absolute inset-0 flex flex-col hidden bg-stone-50 z-10 p-6 overflow-y-auto pb-24">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-stone-200 max-w-4xl mx-auto w-full">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-emerald-100 rounded-full text-emerald-600"><i class="ph-fill ph-wallet text-2xl"></i></div>
                        <div>
                            <h2 class="text-2xl font-bold text-stone-800">Totale Spese</h2>
                            <p class="text-xs text-stone-400">Riepilogo finanziario</p>
                        </div>
                    </div>

                    <!-- Totale Euro -->
                    <div class="mb-4">
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-wider">Totale in Euro</span>
                        <div class="text-4xl font-black text-emerald-600 mt-1" id="total-expenses">0.00 <span class="text-2xl">€</span></div>
                    </div>

                    <!-- Totale Dollari (CONDITIONAL) -->
                    <div id="budget-total-usd" class="mb-6 pb-6 border-b border-stone-100"> <!-- ADDED ID -->
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-wider">Totale in Dollari</span>
                        <div class="text-2xl font-bold text-stone-600 mt-1 font-mono" id="total-expenses-usd">0.00 $</div>
                    </div>

                    <!-- Dettaglio Categorie (Updated) -->
                    <div class="mb-6 border-b border-stone-100 pb-6">
                        <h3 class="text-sm font-bold text-stone-600 mb-3 uppercase">Spese per Categoria</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Pernottamenti</span><span id="cat-total-Pernottamenti" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Pasti</span><span id="cat-total-Pasti" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Carburante</span><span id="cat-total-Carburante" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Attrazioni</span><span id="cat-total-Attrazioni" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Pass e Tasse</span><span id="cat-total-Pass e Tasse" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Altro</span><span id="cat-total-Altro" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                        </div>
                    </div>

                    <!-- Tasso Cambio (CONDITIONAL) -->
                    <div id="budget-exchange-rate" class="mb-6 pb-6 border-b border-stone-100"> <!-- ADDED ID -->
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-2">Tasso di Cambio Attuale</label>
                        <div class="flex items-center gap-3 bg-stone-50 p-3 rounded-xl border border-stone-200">
                            <span class="font-bold text-stone-700">1 € = </span>
                            <input type="number" step="0.01" id="global-exchange-rate" class="w-24 p-2 text-center font-mono font-bold text-lg border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400" value="1.05">
                            <span class="font-bold text-stone-700">$</span>
                        </div>
                        <p class="text-[10px] text-stone-400 mt-2 text-center">Modifica il tasso per aggiornare tutti i valori in $.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 7: TO-DO (Tab 5) -->
            <div id="todo-view" class="absolute inset-0 flex flex-col hidden bg-stone-50 z-10">
                <div class="bg-white p-3 shadow-sm border-b border-stone-200 z-20 flex justify-between text-[10px] uppercase font-bold text-stone-400 max-w-4xl mx-auto w-full">
                    <span>Lista Cose da Fare / Portare</span>
                </div>
                
                <div class="flex-grow overflow-y-auto p-4 custom-scroll pb-52 w-full" id="todo-list-container">
                    <div id="loading-todo" class="hidden flex justify-center mt-10"><div class="loader border-t-orange-400"></div></div>
                    <div id="empty-todo" class="hidden flex flex-col items-center justify-center mt-10 text-stone-400 text-center">
                        <i class="ph ph-list-checks text-5xl mb-3 text-stone-300"></i>
                        <p class="text-sm px-10">La tua lista è vuota. Aggiungi qualcosa da non dimenticare!</p>
                    </div>
                    <div id="todo-list" class="space-y-2 max-w-4xl mx-auto"></div>
                </div>

                <!-- Input Bar (Fixed Bottom) - ADIACENTE alla navigazione -->
                <div class="fixed bottom-[calc(3rem+env(safe-area-inset-bottom,0px))] left-0 w-full bg-white p-2 border-t border-stone-200 shadow-2xl z-30">
                    <div class="max-w-4xl mx-auto flex gap-2 items-center">
                        <!-- Quantità -->
                        <div class="relative w-16 flex-shrink-0">
                            <label class="absolute -top-2 left-1 text-[8px] text-stone-400 font-bold bg-white px-1">QTÀ</label>
                            <input type="number" id="todo-qty-input" min="1" value="1" class="w-full p-2 text-center rounded-lg border border-stone-200 focus:ring-1 focus:ring-orange-400 outline-none text-xs font-bold text-stone-600">
                        </div>
                        <!-- Voce -->
                        <input type="text" id="todo-item-input" class="flex-grow p-2 rounded-lg border border-stone-200 focus:ring-1 focus:ring-orange-400 outline-none text-xs" placeholder="Cosa aggiungere..." autocomplete="off">
                        
                        <button id="add-todo-btn" class="bg-orange-400 hover:bg-orange-500 text-white p-2 rounded-lg shadow-md active:scale-95 transition-transform flex-shrink-0">
                            <i class="ph ph-plus text-lg font-bold"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: Dettaglio Giorno -->
            <div id="notes-view" class="absolute inset-0 flex flex-col hidden bg-white z-30">
                <div class="flex-grow overflow-y-auto custom-scroll" id="notes-list-container">
                    <div id="day-detail-content" class="p-4 bg-white border-b border-stone-100 shadow-sm pb-24 max-w-4xl mx-auto"></div>
                </div>
                <!-- Input bar (Fixed Bottom) - ADIACENTE al bordo inferiore (nav nascosta) -->
                <div class="fixed bottom-0 left-0 w-full p-3 pb-safe bg-stone-100 border-t border-stone-200 flex gap-2 items-center z-40">
                    <div class="max-w-4xl mx-auto w-full flex gap-2">
                        <input type="text" id="note-input" class="flex-grow p-3 rounded-xl border-none focus:ring-2 focus:ring-orange-400 shadow-sm text-stone-700" placeholder="Aggiungi una nota..." autocomplete="off">
                        <button id="add-note-btn" class="bg-orange-400 hover:bg-orange-500 text-white p-3 rounded-xl shadow-md active:scale-95 transition-transform">
                            <i class="ph ph-paper-plane-right text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM TAB BAR (Navigation) -->
        <nav id="bottom-nav" class="bg-white border-t border-stone-200 fixed bottom-0 w-full z-20 flex justify-center items-center h-auto min-h-[3rem] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] hidden pb-safe">
            <div class="flex w-full">
                <button onclick="switchTab('days')" id="tab-days" class="flex flex-col items-center justify-center w-1/5 py-1 text-orange-500 transition-colors">
                    <i class="ph-fill ph-calendar-blank text-xl mb-0.5"></i>
                    <span class="text-[8px] font-bold uppercase tracking-wider">Diario</span>
                </button>
                
                <button onclick="switchTab('summary')" id="tab-summary" class="flex flex-col items-center justify-center w-1/5 py-1 text-stone-400 hover:text-stone-600 transition-colors">
                    <i class="ph-bold ph-chart-pie-slice text-xl mb-0.5"></i>
                    <span class="text-[8px] font-bold uppercase tracking-wider">Dati</span>
                </button>

                <button onclick="switchTab('expenses')" id="tab-expenses" class="flex flex-col items-center justify-center w-1/5 py-1 text-stone-400 hover:text-emerald-600 transition-colors">
                    <i class="ph-bold ph-receipt text-xl mb-0.5"></i>
                    <span class="text-[8px] font-bold uppercase tracking-wider">Spese</span>
                </button>

                <button onclick="switchTab('budget')" id="tab-budget" class="flex flex-col items-center justify-center w-1/5 py-1 text-stone-400 hover:text-emerald-600 transition-colors">
                    <i class="ph-bold ph-wallet text-xl mb-0.5"></i>
                    <span class="text-[8px] font-bold uppercase tracking-wider">Totali</span>
                </button>

                <button onclick="switchTab('todo')" id="tab-todo" class="flex flex-col items-center justify-center w-1/5 py-1 text-stone-400 hover:text-orange-600 transition-colors">
                    <i class="ph-bold ph-list-checks text-xl mb-0.5"></i>
                    <span class="text-[8px] font-bold uppercase tracking-wider">TO-DO</span>
                </button>
            </div>
        </nav>

        <!-- Debug Footer -->
        <footer class="bg-stone-50 text-[10px] text-stone-400 p-1 text-center border-t select-all">
            App ID: <span id="debug-app-id" class="font-mono">loading...</span>
        </footer>

        <!-- MODAL LOGS -->
        <div id="logs-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl flex flex-col overflow-hidden h-[70vh]">
                <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                    <h3 class="text-lg font-bold text-stone-800 flex items-center gap-2"><i class="ph-fill ph-shield-check text-green-500"></i> Registro Accessi</h3>
                    <button onclick="document.getElementById('logs-modal').classList.add('hidden')" class="p-2 hover:bg-stone-200 rounded-full text-stone-500"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-4" id="logs-list">
                    <div class="text-center text-stone-400 text-sm mt-10">Caricamento...</div>
                </div>
            </div>
        </div>

        <!-- MODALE UNICO -->
        <div id="day-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm sm:p-4">
            <div class="bg-white w-full h-[95vh] sm:h-auto sm:max-h-[90vh] sm:max-w-2xl sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col overflow-hidden mx-auto">
                <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                    <h3 id="modal-title" class="text-lg font-bold text-stone-800">Pianifica Giornata</h3>
                    <button onclick="closeModal()" class="p-2 hover:bg-stone-200 rounded-full text-stone-500"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-4 custom-scroll" id="modal-body">
                    <div class="space-y-3 mb-6">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Data</label>
                                <input type="date" id="day-date-input" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg focus:ring-1 focus:ring-orange-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Stato</label>
                                <input type="text" id="day-name-input" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg focus:ring-1 focus:ring-orange-400 outline-none" placeholder="Es. California">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Descrizione Generale</label>
                            <textarea id="day-desc-input" rows="2" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg resize-none focus:ring-1 focus:ring-orange-400 outline-none" placeholder="Obiettivi della giornata..."></textarea>
                        </div>
                        <!-- NEW LINK INPUT -->
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Link (es. Hotel/Info)</label>
                            <div class="relative">
                                <i class="ph ph-link absolute left-3 top-1/2 -translate-y-1/2 text-stone-400"></i>
                                <input type="text" id="day-link-input" class="w-full p-2 pl-9 bg-stone-50 border border-stone-200 rounded-lg focus:ring-1 focus:ring-orange-400 outline-none text-xs text-blue-600" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-orange-500 uppercase flex items-center gap-1"><i class="ph ph-flag-checkered"></i> Tappe & Percorso</label>
                            <!-- NEW TOGGLE -->
                            <label class="flex items-center gap-1 cursor-pointer">
                                <span class="text-[10px] font-bold text-stone-400">USA MIGLIA</span>
                                <input type="checkbox" id="use-miles-toggle" class="form-checkbox h-4 w-4 text-orange-500 rounded border-gray-300 focus:ring-orange-500" checked>
                            </label>
                        </div>
                        <div id="stages-container" class="space-y-4 mb-4"></div>
                        <button onclick="addStageUI()" class="w-full py-3 bg-orange-50 border-2 border-dashed border-orange-200 rounded-xl text-orange-500 font-bold hover:bg-orange-100 transition-colors flex items-center justify-center gap-2">
                            <i class="ph ph-plus-circle text-xl"></i> Aggiungi Tappa
                        </button>
                    </div>

                    <div class="bg-stone-800 text-white rounded-xl p-4 shadow-lg">
                        <h4 class="text-xs font-bold text-stone-400 uppercase mb-3 border-b border-stone-700 pb-1">Riepilogo Stimato</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><p class="text-stone-400 text-xs">Ore Auto Totali</p><p id="sum-drive-time" class="font-mono text-lg font-bold text-amber-400">0h 00m</p></div>
                            <div><p class="text-stone-400 text-xs">Durata Giornata</p><p id="sum-day-time" class="font-mono text-lg font-bold">0h 00m</p></div>
                            <div id="sum-miles-container"><p class="text-stone-400 text-xs">Totale Miglia</p><p id="sum-miles" class="font-mono font-bold">0 mi</p></div>
                            <div><p class="text-stone-400 text-xs">Totale Km</p><p id="sum-km" class="font-mono font-bold text-green-400">0 km</p></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-stone-100 bg-white flex justify-end gap-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-stone-500 hover:bg-stone-100 rounded-lg transition-colors">Annulla</button>
                    <button id="confirm-save-btn" class="px-6 py-2 bg-orange-400 text-white rounded-lg font-bold shadow-md hover:bg-orange-500 flex items-center gap-2 transition-transform active:scale-95">
                        <i class="ph ph-floppy-disk"></i> Salva Tutto
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, query, where, getDocs, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // CONFIGURAZIONE PERSONALE
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCGKOOLOXRU5-kKlROBjBt3n9QLOoh0pEA",
            authDomain: "mio-diario-viaggi.firebaseapp.com",
            projectId: "mio-diario-viaggi",
            storageBucket: "mio-diario-viaggi.firebasestorage.app",
            messagingSenderId: "826682465160",
            appId: "1:826682465160:web:f92ba804c99ad3e651b83d"
        };
        const appId = 'travel-planner-v1'; 
        // =================================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Update Debug Footer safely
        const debugAppIdEl = document.getElementById('debug-app-id');
        if(debugAppIdEl) debugAppIdEl.textContent = appId;

        // --- State ---
        let currentAuthUser = null;
        let activeSecretKey = null;
        let daysColName = null;
        let notesColName = null;
        let logsColName = null; 
        let expensesColName = null; 
        let todoColName = null; // NEW: Todo collection
        let currentDayId = null;
        let editingDayId = null;
        let unsubscribeDays = null;
        let unsubscribeNotes = null;
        let unsubscribeAllNotes = null;
        let unsubscribeExpenses = null; 
        let unsubscribeTodo = null; // NEW: Todo listener
        let currentStages = []; 
        let cachedDays = []; 
        let cachedGlobalNotes = []; 
        let cachedExpenses = []; 
        let cachedTodos = []; // NEW: Todo cache
        let activityChart = null; 
        let currentExchangeRate = 1.05; 
        let globalShowMiles = true; 
        let globalShowUSD = true; 
        let lastListScroll = 0; 
        let currentTabName = 'days'; 

        // --- Helpers ---
        const generateColNames = (key) => {
            const safe = key.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            return safe.length < 3 ? null : { 
                days: `days_${safe}`, 
                notes: `notes_${safe}`, 
                logs: `logs_${safe}`, 
                expenses: `expenses_${safe}`,
                todo: `todo_${safe}`,
                display: key.trim().toUpperCase() 
            };
        };

        const timeToMins = (t) => {
            if(!t) return 0;
            const [h, m] = t.split(':').map(Number);
            return (h * 60) + m;
        };

        const minsToHHMM = (m) => {
            let mins = m % 1440;
            if (mins < 0) mins += 1440;
            const h = Math.floor(mins / 60);
            const min = mins % 60;
            return `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
        };

        const minsToTimeStr = (m) => {
            if(m < 0) return "--";
            const h = Math.floor(m / 60);
            const min = m % 60;
            return `${h}h ${min.toString().padStart(2, '0')}m`;
        };

        const getMapsUrl = (input) => {
            if (!input) return '';
            let text = input.trim();
            if (/^https?:\/\//i.test(text)) return text;
            if (/^(www\.|maps\.)/i.test(text) || text.includes('google.com/maps')) {
                return 'https://' + text;
            }
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(text)}`;
        };
        
        // --- LOGS LOGIC ---
        const getDeviceType = () => {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "Tablet";
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated/.test(ua)) return "Mobile";
            return "Desktop/Laptop";
        };

        const logAccess = async () => {
             if(!logsColName) return;
             let locationStr = "Posizione non disponibile";
             try {
                 const res = await fetch('https://ipapi.co/json/');
                 if(res.ok) {
                     const data = await res.json();
                     if(data.city) locationStr = `${data.city}, ${data.country_name}`;
                 }
             } catch(e) {}
             try {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', logsColName), {
                     timestamp: serverTimestamp(),
                     device: getDeviceType(),
                     userAgent: navigator.userAgent,
                     location: locationStr 
                 });
             } catch(e) {}
        };

        const showLogs = () => {
            if(!logsColName) return;
            const modal = document.getElementById('logs-modal');
            const list = document.getElementById('logs-list');
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="flex justify-center p-4"><div class="loader w-6 h-6 border-t-orange-500"></div></div>';
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', logsColName), orderBy('timestamp', 'desc'), limit(20));
            getDocs(q).then(snap => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p class="text-center text-stone-400 text-sm">Nessun accesso.</p>'; return; }
                snap.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate() : new Date();
                    const formattedDate = date.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center py-3 border-b border-stone-100 last:border-0";
                    item.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-stone-700">${data.device || 'N/D'} <span class="text-[10px] text-stone-400 ml-1">${data.location || ''}</span></span>
                            <span class="text-[10px] text-stone-400 truncate w-40">${data.userAgent}</span>
                        </div>
                        <span class="text-xs font-mono text-orange-500 bg-orange-50 px-2 py-1 rounded">${formattedDate}</span>
                    `;
                    list.appendChild(item);
                });
            });
        };
        document.getElementById('logs-btn').onclick = showLogs;

        // --- EXPORT TO EXCEL ---
        document.getElementById('export-btn').onclick = async () => {
            if (!daysColName || !expensesColName) return;
            const exportBtn = document.getElementById('export-btn');
            exportBtn.innerHTML = '<div class="loader w-4 h-4 border-t-white border-white"></div>';
            try {
                const daysSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', daysColName));
                let daysData = daysSnap.docs.map(d => ({ ...d.data(), _id: d.id }));
                daysData.sort((a,b) => (a.dateString || '9999').localeCompare(b.dateString || '9999'));
                const wb = XLSX.utils.book_new();
                const daysSheetData = [["Index", "Data", "Stato", "Descrizione", "Link"]];
                daysData.forEach((day, index) => {
                    daysSheetData.push([index + 1, day.dateString || '', day.title || '', day.description || '', day.dayLink || '']);
                });
                const wsDays = XLSX.utils.aoa_to_sheet(daysSheetData);
                XLSX.utils.book_append_sheet(wb, wsDays, "Giorni");
                XLSX.writeFile(wb, `TravelPlan_${activeSecretKey}.xlsx`);
            } catch (error) { alert("Errore durante l'export."); } 
            finally { exportBtn.innerHTML = '<i class="ph ph-download-simple text-xl"></i>'; }
        };

        // --- CHART LOGIC ---
        const updateSummaryChart = () => {
            if (!cachedDays || cachedDays.length === 0) return;
            const labels = [], driveData = [], restData = [], metaData = [];
            let maxDriveVal = 0, maxDriveLabel = '--', maxIntenseVal = 0, maxIntenseLabel = '--';
            const sortedDays = [...cachedDays].sort((a,b) => a.chronoId - b.chronoId);
            sortedDays.forEach(day => {
                labels.push(`G${day.chronoId}`);
                let dayDriveMins = 0, dayDurationMins = 0;
                if (day.stages && day.stages.length > 0) {
                    day.stages.forEach(s => { if (!s.isVisit) dayDriveMins += parseInt(s.driveTime || 0); });
                    const sortedStages = [...day.stages].sort((a,b) => timeToMins(a.start) - timeToMins(b.start));
                    const start = timeToMins(sortedStages[0].start);
                    let end = 0;
                    const lastStage = sortedStages[sortedStages.length - 1];
                    end = lastStage.isVisit ? (timeToMins(lastStage.start) + timeToMins(lastStage.pause)) : timeToMins(lastStage.end);
                    if (end < start) end += 1440;
                    dayDurationMins = end - start;
                }
                if (dayDriveMins > maxDriveVal) { maxDriveVal = dayDriveMins; maxDriveLabel = `Giorno ${day.chronoId}`; }
                if (dayDurationMins > maxIntenseVal) { maxIntenseVal = dayDurationMins; maxIntenseLabel = `Giorno ${day.chronoId}`; }
                const driveP = dayDurationMins > 0 ? (dayDriveMins / dayDurationMins) * 100 : (dayDriveMins > 0 ? 100 : 0);
                driveData.push(driveP);
                restData.push(100 - driveP);
                metaData.push({ drive: (dayDriveMins/60).toFixed(1), total: (dayDurationMins/60).toFixed(1), pct: Math.round(driveP) });
            });
            document.getElementById('high-intense-day').textContent = maxIntenseLabel;
            document.getElementById('high-intense-val').textContent = minsToTimeStr(maxIntenseVal);
            document.getElementById('high-drive-day').textContent = maxDriveLabel;
            document.getElementById('high-drive-val').textContent = minsToTimeStr(maxDriveVal);
            const canvas = document.getElementById('activityChart');
            if(!canvas) return; 
            if (activityChart) activityChart.destroy();
            activityChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Guida', data: driveData, backgroundColor: '#fb923c', borderRadius: 4 },
                        { label: 'Altro', data: restData, backgroundColor: '#d6d3d1', borderRadius: 4 }
                    ]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { stacked: true, min: 0, max: 100, ticks: { callback: v => v + "%" } }, y: { stacked: true } }
                }
            });
        };

        // --- SETTINGS TOGGLES ---
        document.getElementById('global-miles-toggle').addEventListener('change', (e) => {
            globalShowMiles = e.target.checked;
            localStorage.setItem(`showMiles_${activeSecretKey}`, globalShowMiles);
            updateGlobalVisibility();
            if(cachedDays.length > 0) renderDaysUI(); 
        });
        document.getElementById('global-usd-toggle').addEventListener('change', (e) => {
            globalShowUSD = e.target.checked;
            localStorage.setItem(`showUSD_${activeSecretKey}`, globalShowUSD);
            updateGlobalVisibility();
            if(cachedExpenses.length > 0) renderExpensesList();
        });
        const updateGlobalVisibility = () => {
            document.getElementById('card-miles-container').style.display = globalShowMiles ? 'flex' : 'none';
            document.getElementById('expenses-header-usd').style.display = globalShowUSD ? 'block' : 'none';
            document.getElementById('expenses-input-usd').style.display = globalShowUSD ? 'block' : 'none';
            document.getElementById('budget-total-usd').style.display = globalShowUSD ? 'block' : 'none';
            document.getElementById('budget-exchange-rate').style.display = globalShowUSD ? 'block' : 'none';
        }

        // --- EXPENSES LOGIC ---
        document.getElementById('global-exchange-rate').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if(!isNaN(val) && val > 0) { currentExchangeRate = val; localStorage.setItem(`rate_${activeSecretKey}`, val); renderExpensesList(); }
        });
        const loadExpenses = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', expensesColName), orderBy('createdAt', 'desc'));
            unsubscribeExpenses = onSnapshot(q, (snapshot) => {
                cachedExpenses = [];
                snapshot.forEach(docSnap => cachedExpenses.push({ id: docSnap.id, ...docSnap.data() }));
                document.getElementById('loading-expenses').classList.add('hidden');
                if(cachedExpenses.length === 0) { document.getElementById('empty-expenses').classList.remove('hidden'); document.getElementById('expenses-header').classList.add('hidden'); renderExpensesList(); return; }
                document.getElementById('empty-expenses').classList.add('hidden');
                document.getElementById('expenses-header').classList.remove('hidden');
                renderExpensesList();
            });
        };
        const renderExpensesList = () => {
            const list = document.getElementById('expenses-list');
            list.innerHTML = '';
            let totalEur = 0;
            const catSums = { 'Pernottamenti': 0, 'Pasti': 0, 'Carburante': 0, 'Attrazioni': 0, 'Pass e Tasse': 0, 'Altro': 0 };
            cachedExpenses.forEach((data) => { 
                const qty = data.qty || 1, amountEur = parseFloat(data.amount || 0);
                totalEur += (amountEur * qty);
                const cat = data.category || 'Altro';
                if(catSums[cat] !== undefined) catSums[cat] += (amountEur * qty);
                const row = document.createElement('div');
                row.className = "flex items-center justify-between p-3 bg-white border border-stone-200 rounded-xl shadow-sm";
                row.innerHTML = `
                    <div class="flex-grow pr-2"><div class="font-bold text-stone-700 text-sm">${data.name} <span class="text-[10px] text-stone-400 bg-stone-100 px-1 rounded ml-1">${cat}</span></div></div>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <span class="font-mono font-bold text-emerald-600 text-sm">${(amountEur*qty).toFixed(2)}€</span>
                            ${globalShowUSD ? `<div class="text-[10px] text-stone-400">${(amountEur*qty*currentExchangeRate).toFixed(2)}$</div>` : ''}
                        </div>
                        <button onclick="deleteExpense('${data.id}')" class="p-1.5 text-stone-300 hover:text-red-500"><i class="ph ph-trash"></i></button>
                    </div>
                `;
                list.appendChild(row);
            });
            updateTotalExpenses(totalEur, catSums);
        };
        const updateTotalExpenses = (totalEur, catSums) => {
            document.getElementById('total-expenses').innerHTML = `${totalEur.toFixed(2)} <span class="text-2xl">€</span>`;
            document.getElementById('total-expenses-usd').textContent = `${(totalEur * currentExchangeRate).toFixed(2)} $`;
            if (catSums) { for (const [key, val] of Object.entries(catSums)) { const el = document.getElementById(`cat-total-${key}`); if (el) el.textContent = `${val.toFixed(2)} €`; } }
        };
        document.getElementById('expense-amount-input').addEventListener('input', (e) => {
             const eur = parseFloat(e.target.value);
             if(!isNaN(eur)) document.getElementById('expense-amount-usd-input').value = (eur * currentExchangeRate).toFixed(2);
        });
        document.getElementById('expense-amount-usd-input').addEventListener('input', (e) => {
             const usd = parseFloat(e.target.value);
             if(!isNaN(usd)) document.getElementById('expense-amount-input').value = (usd / currentExchangeRate).toFixed(2);
        });
        document.getElementById('add-expense-btn').onclick = async () => {
            const nameIn = document.getElementById('expense-name-input'), linkIn = document.getElementById('expense-link-input'), qtyIn = document.getElementById('expense-qty-input'), eurIn = document.getElementById('expense-amount-input');
            const catIn = document.querySelector('input[name="new-expense-cat"]:checked');
            const name = nameIn.value.trim(), amount = parseFloat(eurIn.value), qty = parseInt(qtyIn.value) || 1;
            if(!name || isNaN(amount)) return;
            nameIn.value = ''; linkIn.value = ''; eurIn.value = ''; document.getElementById('expense-amount-usd-input').value = '';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', expensesColName), { name, link: linkIn.value, amount, qty, category: catIn ? catIn.value : 'Altro', createdAt: serverTimestamp() });
        };
        window.deleteExpense = (id) => { if(confirm("Eliminare?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', expensesColName, id)); };

        // --- NEW: TO-DO LOGIC ---
        const loadTodo = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', todoColName), orderBy('createdAt', 'desc'));
            unsubscribeTodo = onSnapshot(q, (snapshot) => {
                cachedTodos = [];
                snapshot.forEach(docSnap => cachedTodos.push({ id: docSnap.id, ...docSnap.data() }));
                document.getElementById('loading-todo').classList.add('hidden');
                if(cachedTodos.length === 0) { document.getElementById('empty-todo').classList.remove('hidden'); renderTodoList(); return; }
                document.getElementById('empty-todo').classList.add('hidden');
                renderTodoList();
            });
        };
        const renderTodoList = () => {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            cachedTodos.forEach(item => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 bg-white border border-stone-200 rounded-xl shadow-sm group transition-all ${item.done ? 'opacity-60' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleTodoStatus('${item.id}', this.checked)" class="w-5 h-5 accent-orange-500 rounded border-stone-300">
                        <span class="bg-stone-100 text-stone-500 font-bold px-2 py-0.5 rounded text-xs">x${item.qty || 1}</span>
                        <span class="text-sm font-bold text-stone-700 ${item.done ? 'line-through text-stone-400 font-normal' : ''}">${item.text}</span>
                    </div>
                    <button onclick="deleteTodo('${item.id}')" class="text-stone-300 hover:text-red-500 p-1.5"><i class="ph ph-trash"></i></button>
                `;
                list.appendChild(div);
            });
        };
        window.toggleTodoStatus = async (id, isDone) => {
            try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', todoColName, id), { done: isDone }); } catch(e) {}
        };
        document.getElementById('add-todo-btn').onclick = async () => {
            const qtyIn = document.getElementById('todo-qty-input'), itemIn = document.getElementById('todo-item-input');
            const qty = parseInt(qtyIn.value) || 1, text = itemIn.value.trim();
            if(!text) return;
            itemIn.value = ''; qtyIn.value = '1';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', todoColName), { qty, text, done: false, createdAt: serverTimestamp() });
        };
        window.deleteTodo = (id) => { if(confirm("Rimuovere dalla lista?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', todoColName, id)); };

        // --- TAB NAVIGATION LOGIC ---
        window.switchTab = (tabName) => {
            currentTabName = tabName;
            ['days', 'summary', 'expenses', 'budget', 'todo'].forEach(t => {
                document.getElementById(`${t}-view`).classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.add('text-stone-400');
                btn.classList.remove('text-orange-500', 'text-emerald-600');
                btn.querySelector('i').classList.replace('ph-fill', 'ph-bold');
            });
            document.getElementById(`${tabName}-view`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${tabName}`);
            const activeColor = (tabName === 'expenses' || tabName === 'budget') ? 'text-emerald-600' : 'text-orange-500';
            activeTab.classList.remove('text-stone-400');
            activeTab.classList.add(activeColor);
            activeTab.querySelector('i').classList.replace('ph-bold', 'ph-fill');
            
            if (tabName === 'summary') setTimeout(updateSummaryChart, 100);
            if ((tabName === 'expenses' || tabName === 'budget') && !unsubscribeExpenses) loadExpenses();
            if (tabName === 'todo' && !unsubscribeTodo) loadTodo();
        };

        // --- LOGIN & AUTH ---
        const login = async () => {
            const key = document.getElementById('secret-key-input').value;
            const names = generateColNames(key);
            if(!names) { alert("Chiave non valida."); return; }
            document.getElementById('login-btn').classList.add('hidden');
            document.getElementById('auth-loader').classList.remove('hidden');
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                activeSecretKey = names.display;
                daysColName = names.days; notesColName = names.notes; logsColName = names.logs; expensesColName = names.expenses;
                todoColName = names.todo; 
                document.getElementById('app-id-display').textContent = appId.substring(0, 8); 
                document.getElementById('current-key-display').textContent = activeSecretKey;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('days-view').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden'); 
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('export-btn').classList.remove('hidden');
                const savedRate = localStorage.getItem(`rate_${activeSecretKey}`);
                if(savedRate) { currentExchangeRate = parseFloat(savedRate); document.getElementById('global-exchange-rate').value = currentExchangeRate; }
                updateGlobalVisibility(); logAccess(); loadDays();
            } catch(e) { alert("Errore di accesso."); } 
            finally { document.getElementById('login-btn').classList.remove('hidden'); document.getElementById('auth-loader').classList.add('hidden'); }
        };
        document.getElementById('login-btn').onclick = login;
        document.getElementById('logout-btn').onclick = () => location.reload();

        const loadDays = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', daysColName), (snapshot) => {
                document.getElementById('loading-days').classList.add('hidden'); 
                if(snapshot.empty) { document.getElementById('empty-days').classList.remove('hidden'); document.getElementById('days-list').innerHTML = ''; return; }
                document.getElementById('empty-days').classList.add('hidden');
                const days = [];
                snapshot.forEach(d => days.push({id: d.id, ...d.data()}));
                days.sort((a, b) => (a.dateString || '').localeCompare(b.dateString || ''));
                cachedDays = days; 
                renderDaysUI(); 
            });
        };

        const renderDaysUI = () => {
            const list = document.getElementById('days-list');
            list.innerHTML = '';
            cachedDays.forEach((day, i) => {
                day.chronoId = i + 1;
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-stone-200 active:scale-95 transition-transform cursor-pointer";
                let dateStr = day.dateString ? new Date(day.dateString).toLocaleDateString('it-IT', {day: 'numeric', month: 'short'}) : 'N/D';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="pr-2">
                            <span class="text-[9px] font-black text-orange-500 uppercase tracking-widest">GIORNO ${day.chronoId}</span>
                            <h3 class="font-bold text-stone-800 text-lg leading-tight">${day.title || 'In viaggio'}</h3>
                        </div>
                        <div class="bg-stone-100 text-stone-600 px-2 py-1 rounded text-xs font-bold">${dateStr}</div>
                    </div>
                `;
                card.onclick = () => openDayDetail(day);
                list.appendChild(card);
            });
            updateSummaryChart();
        };

        const openDayDetail = (day) => {
            currentDayId = day.id;
            lastListScroll = document.getElementById('days-list-container').scrollTop;
            document.getElementById('days-view').classList.add('hidden');
            document.getElementById('notes-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.add('hidden'); 
            document.getElementById('header-title').textContent = `Giorno ${day.chronoId}`;
            const detailContainer = document.getElementById('day-detail-content');
            detailContainer.innerHTML = `
                <div class="mb-4"><h2 class="text-2xl font-black text-stone-800">${day.title || ''}</h2><p class="text-stone-500 text-sm mt-2 italic">${day.description || ''}</p></div>
                <div id="notes-list" class="space-y-2 mb-4"></div>
            `;
            loadNotes(day.id);
        };
        const loadNotes = (dayId) => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', notesColName), where('dayId', '==', dayId));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('notes-list');
                if(!list) return;
                list.innerHTML = '<h4 class="text-xs font-bold text-stone-400 uppercase mb-2">Note</h4>';
                snap.forEach(d => {
                    const div = document.createElement('div');
                    div.className = "bg-yellow-50 p-3 rounded-lg text-sm border border-yellow-100 flex justify-between";
                    div.innerHTML = `<span>${d.data().text}</span><button onclick="deleteNote('${d.id}')" class="text-stone-300 ml-2"><i class="ph ph-trash"></i></button>`;
                    list.appendChild(div);
                });
            });
        };
        window.deleteNote = (id) => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', notesColName, id));
        document.getElementById('back-btn').onclick = () => {
            document.getElementById('days-view').classList.remove('hidden');
            document.getElementById('notes-view').classList.add('hidden');
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden'); 
            document.getElementById('header-title').textContent = "Travel Planner";
        };

        // --- SWIPE GESTURES ---
        let touchStartX = 0, touchStartY = 0;
        document.querySelector('main').addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, { passive: true });
        document.querySelector('main').addEventListener('touchend', (e) => {
            const deltaX = e.changedTouches[0].screenX - touchStartX;
            if (Math.abs(deltaX) > 70 && document.getElementById('notes-view').classList.contains('hidden')) {
                const tabs = ['days', 'summary', 'expenses', 'budget', 'todo'];
                let idx = tabs.indexOf(currentTabName);
                if (deltaX > 0 && idx > 0) switchTab(tabs[idx - 1]);
                else if (deltaX < 0 && idx < tabs.length - 1) switchTab(tabs[idx + 1]);
            }
        }, { passive: true });

        window.openModal = (dayData) => {
            editingDayId = dayData?.id || null;
            document.getElementById('day-modal').classList.remove('hidden');
            document.getElementById('day-name-input').value = dayData?.title || '';
            document.getElementById('day-date-input').value = dayData?.dateString || '';
        };
        window.closeModal = () => document.getElementById('day-modal').classList.add('hidden');
        document.getElementById('confirm-save-btn').onclick = async () => {
            const payload = { title: document.getElementById('day-name-input').value, dateString: document.getElementById('day-date-input').value, updatedAt: serverTimestamp() };
            if(editingDayId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', daysColName, editingDayId), payload);
            else { payload.createdAt = serverTimestamp(); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', daysColName), payload); }
            closeModal();
        };

    </script>
</body>
</html>
