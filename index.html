<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Planner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        .loader {
            border: 3px solid #fff7ed; /* orange-50 */
            border-top: 3px solid #fb923c; /* orange-400 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #fff7ed; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #fb923c; }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Safe area utility for modern phones */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Car Icon Animation */
        .car-icon-div {
            transition: transform 0.1s linear; /* Smooth rotation if implemented, or position updates */
            z-index: 1000 !important;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-700 font-sans h-screen overflow-hidden flex flex-col">

    <!-- App Container (Full Width) -->
    <div class="w-full h-full bg-white shadow-2xl relative flex flex-col">
        
        <!-- Header -->
        <header class="bg-orange-400 text-white p-4 shadow-md z-20 flex items-center justify-between transition-colors duration-300" id="main-header">
            <div class="flex items-center gap-3 overflow-hidden">
                <button id="back-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors flex-shrink-0">
                    <i class="ph ph-arrow-left text-xl"></i>
                </button>
                <div class="flex flex-col overflow-hidden">
                    <h1 id="header-title" class="text-xl font-bold truncate flex items-center gap-2">
                        <i class="ph-fill ph-airplane-tilt"></i> Travel Planner
                    </h1>
                    <span id="header-subtitle" class="text-xs text-orange-50 truncate hidden"></span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- LOGS BUTTON -->
                <button id="logs-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors" title="Registro Accessi">
                    <i class="ph-fill ph-eye text-xl"></i>
                </button>
                <button id="export-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors" title="Scarica Backup">
                    <i class="ph ph-download-simple text-xl"></i>
                </button>
                <button id="logout-btn" class="hidden text-xs bg-orange-600/30 hover:bg-orange-600/50 px-3 py-1 rounded transition-colors flex items-center gap-1">
                    <i class="ph ph-sign-out"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow relative overflow-hidden bg-stone-50">
            
            <!-- VIEW 1: Login -->
            <div id="login-view" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-50 p-6 text-center">
                <div class="p-5 bg-orange-50 rounded-full mb-6 text-orange-400">
                    <i class="ph ph-map-trifold text-6xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-stone-800">Travel Planner</h2>
                <p class="text-stone-500 mb-6 text-sm">Accedi con la tua chiave segreta.</p>
                
                <div class="w-full max-w-xs mb-4 relative mx-auto">
                    <input type="text" id="secret-key-input" class="w-full p-4 pl-12 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-orange-400 outline-none font-bold text-stone-700 tracking-wide placeholder-stone-400" placeholder="es. USA2025">
                    <i class="ph ph-key absolute left-4 top-1/2 transform -translate-y-1/2 text-stone-400 text-xl"></i>
                </div>
                
                <button id="login-btn" class="bg-orange-400 hover:bg-orange-500 text-white w-full max-w-xs py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 mb-4 transition-transform active:scale-95 mx-auto">
                    <span>Entra</span> <i class="ph ph-arrow-right"></i>
                </button>

                <div id="auth-loader" class="hidden loader border-t-orange-400 mt-4 mx-auto"></div>
                <p id="login-error" class="hidden text-red-500 text-sm mt-2"></p>
            </div>

            <!-- VIEW 2: Lista Giorni -->
            <div id="days-view" class="absolute inset-0 flex flex-col hidden overflow-hidden">
                <div class="bg-orange-50 p-2 text-center text-xs text-orange-800 font-medium border-b border-orange-100 flex justify-between px-4 items-center flex-shrink-0">
                    <span>Viaggio: <span id="current-key-display" class="font-bold">...</span></span>
                    <span class="text-[10px] text-orange-400">ID: <span id="app-id-display">...</span></span>
                </div>
                
                <!-- Lista scrollabile -->
                <div class="flex-grow overflow-y-auto p-4 pb-32 custom-scroll" id="days-list-container">
                    <div id="loading-days" class="flex justify-center mt-10"><div class="loader border-t-orange-400"></div></div>
                    <div id="empty-days" class="hidden flex flex-col items-center justify-center mt-20 text-stone-400">
                        <i class="ph ph-road-horizon text-5xl mb-3 text-stone-300"></i>
                        <p>Nessun giorno pianificato.</p>
                    </div>
                    <div id="days-list" class="space-y-3 max-w-3xl mx-auto"></div>
                </div>

                <!-- Pulsante flottante -->
                <button onclick="openModal(null)" class="absolute bottom-20 right-6 bg-orange-400 hover:bg-orange-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-20 border-2 border-white">
                    <i class="ph ph-plus text-2xl font-bold"></i>
                </button>
            </div>

            <!-- VIEW 3: Riepilogo Totale (Stats) -->
            <div id="summary-view" class="absolute inset-0 flex flex-col hidden overflow-hidden pb-0 bg-stone-100">
                <div class="flex-grow overflow-y-auto custom-scroll p-4 pb-28"> 
                    <div class="max-w-4xl mx-auto">
                        <!-- NEW GLOBAL SETTINGS TOGGLES -->
                        <div class="grid grid-cols-2 gap-2 mb-6">
                            <!-- Miles Toggle -->
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-200 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <i class="ph-bold ph-gear text-stone-400"></i>
                                    <span class="text-sm font-bold text-stone-700">Abilita unità Miglia (USA/UK)</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="global-miles-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                                </label>
                            </div>

                            <!-- USD Toggle -->
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-200 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <i class="ph-bold ph-currency-dollar text-stone-400"></i>
                                    <span class="text-sm font-bold text-stone-700">Abilita valuta USD</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="global-usd-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                </label>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6 border border-stone-200 w-full mb-6">
                            <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-stone-800">Riepilogo Viaggio</h2>
                                    <p class="text-sm text-stone-400">Statistiche generali</p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-full text-orange-500">
                                    <i class="ph-fill ph-chart-pie-slice text-2xl"></i>
                                </div>
                            </div>

                            <!-- NEW ROW: Counts -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <!-- Card Stati -->
                                <div class="bg-purple-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-purple-100">
                                    <div class="bg-purple-100 p-2 rounded-full text-purple-600 mb-2"><i class="ph-bold ph-flag text-xl"></i></div>
                                    <span class="text-[10px] font-bold text-stone-500 uppercase">Stati Visitati</span>
                                    <span class="text-2xl font-black text-purple-600" id="summ-view-states">0</span>
                                </div>
                                <!-- Card Tappe Uniche (RENAMED TO TAPPE VISITATE) -->
                                <div class="bg-pink-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-pink-100">
                                    <div class="bg-pink-100 p-2 rounded-full text-pink-600 mb-2"><i class="ph-bold ph-map-pin text-xl"></i></div>
                                    <span class="text-[10px] font-bold text-stone-500 uppercase">Tappe Visitate</span>
                                    <span class="text-2xl font-black text-pink-600" id="summ-view-stages">0</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <!-- Card Auto -->
                                <div class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                    <div class="bg-amber-100 p-3 rounded-full text-amber-600 mb-2"><i class="ph-bold ph-car text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Ore Guida</span>
                                    <span class="text-2xl font-bold text-amber-500" id="summ-view-drive">--</span>
                                </div>
                                <!-- Card Miglia (CONDITIONAL) -->
                                <div id="card-miles-container" class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                    <div class="bg-blue-100 p-3 rounded-full text-blue-600 mb-2"><i class="ph-bold ph-signpost text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Miglia Totali</span>
                                    <span class="text-2xl font-bold text-stone-700" id="summ-view-miles">--</span>
                                </div>
                                <!-- Card Km -->
                                <div class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border-l-4 border-green-500">
                                    <div class="bg-green-100 p-3 rounded-full text-green-600 mb-2"><i class="ph-bold ph-globe text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Km Totali</span>
                                    <span class="text-3xl font-black text-green-600" id="summ-view-km">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- CHART SECTION -->
                        <div class="bg-white rounded-2xl shadow-xl p-4 border border-stone-200 w-full mb-6">
                            <h3 class="text-sm font-bold text-stone-600 uppercase mb-4 pl-2 border-l-4 border-orange-400">Analisi Giornaliera</h3>
                            <div class="h-96 w-full">
                                <canvas id="activityChart"></canvas>
                            </div>
                            <p class="text-[10px] text-center text-stone-400 mt-2">
                                <span class="inline-block w-2 h-2 rounded-full bg-orange-400 mr-1"></span>% Ore Guida
                                <span class="inline-block w-2 h-2 rounded-full bg-stone-300 ml-3 mr-1"></span>% Resto della Giornata
                            </p>
                        </div>

                        <!-- HIGHLIGHTS SECTION -->
                        <div class="grid grid-cols-2 gap-4 w-full mb-6">
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex flex-col items-center text-center shadow-sm">
                                <div class="bg-red-100 text-red-500 p-2 rounded-full mb-2"><i class="ph-fill ph-fire text-xl"></i></div>
                                <span class="text-[10px] font-bold text-stone-500 uppercase">Giorno Più Intenso</span>
                                <div class="font-bold text-red-600 text-lg mt-1" id="high-intense-day">--</div>
                                <div class="text-xs text-stone-400 font-mono" id="high-intense-val">--</div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl border border-amber-100 flex flex-col items-center text-center shadow-sm">
                                <div class="bg-amber-100 text-amber-500 p-2 rounded-full mb-2"><i class="ph-fill ph-steering-wheel text-xl"></i></div>
                                <span class="text-[10px] font-bold text-stone-500 uppercase">Più Ore Auto</span>
                                <div class="font-bold text-amber-600 text-lg mt-1" id="high-drive-day">--</div>
                                <div class="text-xs text-stone-400 font-mono" id="high-drive-val">--</div>
                            </div>
                        </div>

                        <!-- TRAVEL REEL / VIDEO SECTION -->
                        <div class="bg-gradient-to-r from-orange-400 to-amber-500 rounded-2xl shadow-xl p-6 text-white w-full mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i class="ph-fill ph-video-camera text-9xl"></i>
                            </div>
                            <div class="relative z-10">
                                <h3 class="text-xl font-bold flex items-center gap-2 mb-2"><i class="ph-fill ph-film-strip"></i> Travel Reel</h3>
                                <p class="text-sm text-orange-50 mb-4 pr-10">Rivivi il tuo viaggio! Guarda l'animazione del percorso sulla mappa.</p>
                                
                                <div id="map-video-container" class="w-full h-64 bg-white rounded-xl shadow-inner mb-4 hidden overflow-hidden relative group">
                                    <div id="travel-video-map" class="w-full h-full z-0"></div>
                                    
                                    <!-- Controlli Video -->
                                    <div id="video-controls" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-30 flex items-center gap-4 bg-black/60 backdrop-blur-md px-4 py-2 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                        <div class="flex gap-1 bg-white/20 rounded-lg p-1">
                                            <button onclick="setVideoSpeed(0.5)" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-white/30 transition-colors speed-btn" id="btn-speed-05">0.5x</button>
                                            <button onclick="setVideoSpeed(1)" class="text-[10px] font-bold px-2 py-1 rounded bg-white text-black transition-colors speed-btn" id="btn-speed-1">1x</button>
                                            <button onclick="setVideoSpeed(2)" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-white/30 transition-colors speed-btn" id="btn-speed-2">2x</button>
                                        </div>
                                        <div class="w-px h-6 bg-white/30"></div>
                                        <button onclick="toggleVideoFullscreen()" class="hover:text-orange-300 transition-colors" title="Schermo Intero">
                                            <i class="ph-bold ph-arrows-out text-xl"></i>
                                        </button>
                                    </div>

                                    <div id="video-overlay-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-black/50 z-20 hidden">
                                        <div class="text-white font-bold text-lg" id="video-status-text">Caricamento mappa...</div>
                                    </div>
                                </div>

                                <button onclick="playTravelVideo()" id="play-video-btn" class="bg-white text-orange-500 hover:bg-orange-50 font-bold py-2 px-6 rounded-xl shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                                    <i class="ph-fill ph-play-circle text-2xl"></i> Avvia Animazione
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 5: SPESE LISTA (Tab 3) -->
            <div id="expenses-view" class="absolute inset-0 flex flex-col hidden bg-stone-50 z-10">
                <!-- Header Colonne Lista - ADDED ID -->
                <div id="expenses-header" class="bg-white p-3 shadow-sm border-b border-stone-200 z-20 flex justify-between text-[10px] uppercase font-bold text-stone-400 max-w-4xl mx-auto w-full">
                    <span class="w-1/3">Voce</span>
                    <div class="flex gap-4 w-2/3 justify-end pr-14">
                        <span>Euro (€)</span>
                        <span id="expenses-header-usd">USD ($)</span> <!-- ADDED ID -->
                    </div>
                </div>

                <!-- Lista Spese -->
                <div class="flex-grow overflow-y-auto p-4 custom-scroll pb-48 w-full" id="expenses-list-container">
                    <div id="loading-expenses" class="hidden flex justify-center mt-10"><div class="loader border-t-emerald-400"></div></div>
                    <div id="empty-expenses" class="hidden flex flex-col items-center justify-center mt-10 text-stone-400">
                        <i class="ph ph-receipt text-5xl mb-3 text-stone-300"></i>
                        <p class="text-sm">Nessuna spesa registrata.</p>
                    </div>
                    <div id="expenses-list" class="space-y-2 max-w-4xl mx-auto"></div>
                </div>

                <!-- Input Bar (Fixed Bottom) -->
                <div class="absolute bottom-12 left-0 w-full bg-white p-2 border-t border-stone-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 flex flex-col gap-2">
                    <!-- CATEGORY SELECTOR -->
                    <div class="flex justify-center gap-2 sm:gap-4 overflow-x-auto pb-1 max-w-4xl mx-auto w-full">
                        <label class="cursor-pointer group">
                            <input type="radio" name="expense-cat" value="hotel" class="peer sr-only">
                            <span class="block px-3 py-1.5 rounded-full text-[10px] font-bold bg-stone-100 text-stone-400 peer-checked:bg-indigo-100 peer-checked:text-indigo-600 peer-checked:ring-1 peer-checked:ring-indigo-300 transition-all flex items-center gap-1 group-hover:bg-stone-200"><i class="ph-fill ph-bed text-sm"></i> HOTEL</span>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="expense-cat" value="attraction" class="peer sr-only">
                            <span class="block px-3 py-1.5 rounded-full text-[10px] font-bold bg-stone-100 text-stone-400 peer-checked:bg-pink-100 peer-checked:text-pink-600 peer-checked:ring-1 peer-checked:ring-pink-300 transition-all flex items-center gap-1 group-hover:bg-stone-200"><i class="ph-fill ph-ticket text-sm"></i> ATTRAZIONE</span>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="expense-cat" value="transport" class="peer sr-only">
                            <span class="block px-3 py-1.5 rounded-full text-[10px] font-bold bg-stone-100 text-stone-400 peer-checked:bg-blue-100 peer-checked:text-blue-600 peer-checked:ring-1 peer-checked:ring-blue-300 transition-all flex items-center gap-1 group-hover:bg-stone-200"><i class="ph-fill ph-bus text-sm"></i> BIGLIETTI MEZZI</span>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="expense-cat" value="other" class="peer sr-only" checked>
                            <span class="block px-3 py-1.5 rounded-full text-[10px] font-bold bg-stone-100 text-stone-400 peer-checked:bg-stone-200 peer-checked:text-stone-600 peer-checked:ring-1 peer-checked:ring-stone-300 transition-all flex items-center gap-1 group-hover:bg-stone-200"><i class="ph-fill ph-dots-three text-sm"></i> ALTRO</span>
                        </label>
                    </div>

                    <div class="max-w-4xl mx-auto flex gap-2 items-center w-full">
                        <div class="flex-grow flex gap-1">
                            <input type="text" id="expense-name-input" class="w-1/2 p-2 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs" placeholder="Voce spesa..." autocomplete="off">
                            <input type="text" id="expense-link-input" class="w-1/2 p-2 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs" placeholder="Link (opz.)" autocomplete="off">
                        </div>
                        
                        <!-- Moltiplicatore (Qtà) -->
                        <div class="relative w-12 flex-shrink-0">
                            <label class="absolute -top-2 left-1 text-[8px] text-stone-400 font-bold bg-white px-1">Qtà</label>
                            <input type="number" id="expense-qty-input" min="1" max="20" value="1" class="w-full p-2 text-center rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-bold text-stone-600">
                        </div>

                        <div class="relative w-16 flex-shrink-0">
                            <input type="number" step="0.01" id="expense-amount-input" class="w-full p-2 pl-5 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-mono" placeholder="0">
                            <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">€</span>
                        </div>

                        <div id="expenses-input-usd" class="relative w-16 flex-shrink-0"> <!-- ADDED ID -->
                            <input type="number" step="0.01" id="expense-amount-usd-input" class="w-full p-2 pl-5 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-mono bg-stone-50" placeholder="0">
                            <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">$</span>
                        </div>

                        <button id="add-expense-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-lg shadow-md active:scale-95 transition-transform flex-shrink-0">
                            <i class="ph ph-plus text-lg font-bold"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: BUDGET / TOTALI (Tab 4) -->
            <div id="budget-view" class="absolute inset-0 flex flex-col hidden bg-stone-50 z-10 p-6 overflow-y-auto pb-24">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-stone-200 max-w-4xl mx-auto w-full">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-emerald-100 rounded-full text-emerald-600"><i class="ph-fill ph-wallet text-2xl"></i></div>
                        <div>
                            <h2 class="text-2xl font-bold text-stone-800">Totale Spese</h2>
                            <p class="text-xs text-stone-400">Riepilogo finanziario</p>
                        </div>
                    </div>

                    <!-- Totale Euro -->
                    <div class="mb-4">
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-wider">Totale in Euro</span>
                        <div class="text-4xl font-black text-emerald-600 mt-1" id="total-expenses">0.00 <span class="text-2xl">€</span></div>
                    </div>

                    <!-- Totale Dollari (CONDITIONAL) -->
                    <div id="budget-total-usd" class="mb-6 pb-6 border-b border-stone-100"> <!-- ADDED ID -->
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-wider">Totale in Dollari</span>
                        <div class="text-2xl font-bold text-stone-600 mt-1 font-mono" id="total-expenses-usd">0.00 $</div>
                    </div>

                    <!-- CATEGORY BREAKDOWN -->
                    <div id="budget-category-breakdown" class="mb-6 pb-6 border-b border-stone-100">
                        <h3 class="text-xs font-bold text-stone-500 uppercase mb-3">Dettaglio per Categoria</h3>
                        <div class="space-y-3" id="budget-cat-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Tasso Cambio (CONDITIONAL) -->
                    <div id="budget-exchange-rate"> <!-- ADDED ID -->
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-2">Tasso di Cambio Attuale</label>
                        <div class="flex items-center gap-3 bg-stone-50 p-3 rounded-xl border border-stone-200">
                            <span class="font-bold text-stone-700">1 € = </span>
                            <input type="number" step="0.01" id="global-exchange-rate" class="w-24 p-2 text-center font-mono font-bold text-lg border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400" value="1.05">
                            <span class="font-bold text-stone-700">$</span>
                        </div>
                        <p class="text-[10px] text-stone-400 mt-2 text-center">Modifica il tasso per aggiornare tutti i valori in $.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: Dettaglio Giorno -->
            <div id="notes-view" class="absolute inset-0 flex flex-col hidden bg-white z-30">
                <div class="flex-grow overflow-y-auto custom-scroll" id="notes-list-container">
                    <div id="day-detail-content" class="p-4 bg-white border-b border-stone-100 shadow-sm pb-24 max-w-4xl mx-auto"></div>
                </div>
                <div class="p-3 bg-stone-100 border-t border-stone-200 flex gap-2 items-center z-20">
                    <div class="max-w-4xl mx-auto w-full flex gap-2">
                        <input type="text" id="note-input" class="flex-grow p-3 rounded-xl border-none focus:ring-2 focus:ring-orange-400 shadow-sm text-stone-700" placeholder="Aggiungi una nota..." autocomplete="off">
                        <button id="add-note-btn" class="bg-orange-400 hover:bg-orange-500 text-white p-3 rounded-xl shadow-md active:scale-95 transition-transform">
                            <i class="ph ph-paper-plane-right text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM TAB BAR (Navigation) -->
        <nav id="bottom-nav" class="bg-white border-t border-stone-200 fixed bottom-0 w-full z-20 flex justify-center items-center h-auto min-h-[3rem] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] hidden pb-safe">
            <div class="flex w-full">
                <button onclick="switchTab('days')" id="tab-days" class="flex flex-col items-center justify-center w-1/4 py-1 text-orange-500 transition-colors">
                    <i class="ph-fill ph-calendar-blank text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Diario</span>
                </button>
                
                <button onclick="switchTab('summary')" id="tab-summary" class="flex flex-col items-center justify-center w-1/4 py-1 text-stone-400 hover:text-stone-600 transition-colors">
                    <i class="ph-bold ph-chart-pie-slice text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Riepilogo</span>
                </button>

                <button onclick="switchTab('expenses')" id="tab-expenses" class="flex flex-col items-center justify-center w-1/4 py-1 text-stone-400 hover:text-emerald-600 transition-colors">
                    <i class="ph-bold ph-receipt text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Spese</span>
                </button>

                <button onclick="switchTab('budget')" id="tab-budget" class="flex flex-col items-center justify-center w-1/4 py-1 text-stone-400 hover:text-emerald-600 transition-colors">
                    <i class="ph-bold ph-wallet text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Totali</span>
                </button>
            </div>
        </nav>

        <!-- Debug Footer -->
        <footer class="bg-stone-50 text-[10px] text-stone-400 p-1 text-center border-t select-all">
            App ID: <span id="debug-app-id" class="font-mono">loading...</span>
        </footer>

        <!-- MODAL LOGS -->
        <div id="logs-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl flex flex-col overflow-hidden h-[70vh]">
                <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                    <h3 class="text-lg font-bold text-stone-800 flex items-center gap-2"><i class="ph-fill ph-shield-check text-green-500"></i> Registro Accessi</h3>
                    <button onclick="document.getElementById('logs-modal').classList.add('hidden')" class="p-2 hover:bg-stone-200 rounded-full text-stone-500"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-4" id="logs-list">
                    <div class="text-center text-stone-400 text-sm mt-10">Caricamento...</div>
                </div>
            </div>
        </div>

        <!-- MODALE UNICO -->
        <div id="day-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm sm:p-4">
            <div class="bg-white w-full h-[95vh] sm:h-auto sm:max-h-[90vh] sm:max-w-2xl sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col overflow-hidden mx-auto">
                <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                    <h3 id="modal-title" class="text-lg font-bold text-stone-800">Pianifica Giornata</h3>
                    <button onclick="closeModal()" class="p-2 hover:bg-stone-200 rounded-full text-stone-500"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-4 custom-scroll" id="modal-body">
                    <div class="space-y-3 mb-6">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Data</label>
                                <input type="date" id="day-date-input" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg focus:ring-1 focus:ring-orange-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Stato</label>
                                <input type="text" id="day-name-input" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg focus:ring-1 focus:ring-orange-400 outline-none" placeholder="Es. California">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Descrizione Generale</label>
                            <textarea id="day-desc-input" rows="2" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg resize-none focus:ring-1 focus:ring-orange-400 outline-none" placeholder="Obiettivi della giornata..."></textarea>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-orange-500 uppercase flex items-center gap-1"><i class="ph ph-flag-checkered"></i> Tappe & Percorso</label>
                            <!-- NEW TOGGLE -->
                            <label class="flex items-center gap-1 cursor-pointer">
                                <span class="text-[10px] font-bold text-stone-400">USA MIGLIA</span>
                                <input type="checkbox" id="use-miles-toggle" class="form-checkbox h-4 w-4 text-orange-500 rounded border-gray-300 focus:ring-orange-500" checked>
                            </label>
                        </div>
                        <div id="stages-container" class="space-y-4 mb-4"></div>
                        <button onclick="addStageUI()" class="w-full py-3 bg-orange-50 border-2 border-dashed border-orange-200 rounded-xl text-orange-500 font-bold hover:bg-orange-100 transition-colors flex items-center justify-center gap-2">
                            <i class="ph ph-plus-circle text-xl"></i> Aggiungi Tappa
                        </button>
                    </div>

                    <div class="bg-stone-800 text-white rounded-xl p-4 shadow-lg">
                        <h4 class="text-xs font-bold text-stone-400 uppercase mb-3 border-b border-stone-700 pb-1">Riepilogo Stimato</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><p class="text-stone-400 text-xs">Ore Auto Totali</p><p id="sum-drive-time" class="font-mono text-lg font-bold text-amber-400">0h 00m</p></div>
                            <div><p class="text-stone-400 text-xs">Durata Giornata</p><p id="sum-day-time" class="font-mono text-lg font-bold">0h 00m</p></div>
                            <div id="sum-miles-container"><p class="text-stone-400 text-xs">Totale Miglia</p><p id="sum-miles" class="font-mono font-bold">0 mi</p></div>
                            <div><p class="text-stone-400 text-xs">Totale Km</p><p id="sum-km" class="font-mono font-bold text-green-400">0 km</p></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-stone-100 bg-white flex justify-end gap-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-stone-500 hover:bg-stone-100 rounded-lg transition-colors">Annulla</button>
                    <button id="confirm-save-btn" class="px-6 py-2 bg-orange-400 text-white rounded-lg font-bold shadow-md hover:bg-orange-500 flex items-center gap-2 transition-transform active:scale-95">
                        <i class="ph ph-floppy-disk"></i> Salva Tutto
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, query, where, getDocs, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // CONFIGURAZIONE PERSONALE
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCGKOOLOXRU5-kKlROBjBt3n9QLOoh0pEA",
            authDomain: "mio-diario-viaggi.firebaseapp.com",
            projectId: "mio-diario-viaggi",
            storageBucket: "mio-diario-viaggi.firebasestorage.app",
            messagingSenderId: "826682465160",
            appId: "1:826682465160:web:f92ba804c99ad3e651b83d"
        };
        const appId = 'travel-planner-v1'; 
        // =================================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Update Debug Footer safely
        const debugAppIdEl = document.getElementById('debug-app-id');
        if(debugAppIdEl) debugAppIdEl.textContent = appId;

        // --- State ---
        let currentAuthUser = null;
        let activeSecretKey = null;
        let daysColName = null;
        let notesColName = null;
        let logsColName = null; 
        let expensesColName = null; 
        let currentDayId = null;
        let editingDayId = null;
        let unsubscribeDays = null;
        let unsubscribeNotes = null;
        let unsubscribeExpenses = null; 
        let currentStages = []; 
        let cachedDays = []; 
        let cachedExpenses = []; 
        let activityChart = null; 
        let currentExchangeRate = 1.05; // Default
        let globalShowMiles = true; 
        let globalShowUSD = true; // NEW STATE

        // --- Helpers ---
        const generateColNames = (key) => {
            const safe = key.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            return safe.length < 3 ? null : { 
                days: `days_${safe}`, 
                notes: `notes_${safe}`, 
                logs: `logs_${safe}`, 
                expenses: `expenses_${safe}`, 
                display: key.trim().toUpperCase() 
            };
        };

        const timeToMins = (t) => {
            if(!t) return 0;
            const [h, m] = t.split(':').map(Number);
            return (h * 60) + m;
        };

        const minsToHHMM = (m) => {
            let mins = m % 1440;
            if (mins < 0) mins += 1440;
            const h = Math.floor(mins / 60);
            const min = mins % 60;
            return `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
        };

        const minsToTimeStr = (m) => {
            if(m < 0) return "--";
            const h = Math.floor(m / 60);
            const min = m % 60;
            return `${h}h ${min.toString().padStart(2, '0')}m`;
        };

        const getMapsUrl = (input) => {
            if (!input) return '';
            let text = input.trim();
            if (/^https?:\/\//i.test(text)) return text;
            if (/^(www\.|maps\.)/i.test(text) || text.includes('google.com/maps')) {
                return 'https://' + text;
            }
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(text)}`;
        };
        
        // --- LOGS LOGIC ---
        const getDeviceType = () => {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "Tablet";
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated/.test(ua)) return "Mobile";
            return "Desktop/Laptop";
        };

        const logAccess = async () => {
             if(!logsColName) return;
             try {
                 const res = await fetch('https://ipapi.co/json/');
                 let locationStr = "Posizione non disponibile";
                 if(res.ok) {
                     const data = await res.json();
                     if(data.city) locationStr = `${data.city}, ${data.country_name}`;
                 }
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', logsColName), {
                     timestamp: serverTimestamp(),
                     device: getDeviceType(),
                     userAgent: navigator.userAgent,
                     location: locationStr 
                 });
             } catch(e) { console.error("Logging failed", e); }
        };

        const showLogs = () => {
            if(!logsColName) return;
            const modal = document.getElementById('logs-modal');
            const list = document.getElementById('logs-list');
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="flex justify-center p-4"><div class="loader w-6 h-6 border-t-orange-500"></div></div>';

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', logsColName), orderBy('timestamp', 'desc'), limit(20));
            getDocs(q).then(snap => {
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p class="text-center text-stone-400 text-sm">Nessun accesso registrato.</p>';
                    return;
                }
                snap.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate() : new Date();
                    const formattedDate = date.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    
                    const locationDisplay = data.location || 'N/D';

                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center py-3 border-b border-stone-100 last:border-0";
                    item.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-stone-700 flex items-center gap-1">
                                ${data.device || 'Sconosciuto'} 
                                <span class="text-[10px] font-normal text-stone-500 bg-stone-100 px-1 rounded ml-1 flex items-center gap-0.5"><i class="ph-bold ph-map-pin"></i> ${data.location || 'N/D'}</span>
                            </span>
                            <span class="text-[10px] text-stone-400 truncate w-40">${data.userAgent}</span>
                        </div>
                        <span class="text-xs font-mono text-orange-500 bg-orange-50 px-2 py-1 rounded">${formattedDate}</span>
                    `;
                    list.appendChild(item);
                });
            });
        };

        if(document.getElementById('logs-btn')) document.getElementById('logs-btn').onclick = showLogs;


        // --- CHART LOGIC ---
        const updateSummaryChart = () => {
            if (!cachedDays || cachedDays.length === 0) return;

            const labels = [];
            const driveData = []; // Pure numbers for chart
            const restData = [];  // Pure numbers for chart
            const metaData = [];  // Stores raw hours for tooltip

            let maxDriveVal = 0;
            let maxDriveLabel = '--';
            let maxIntenseVal = 0;
            let maxIntenseLabel = '--';

            const sortedDays = [...cachedDays].sort((a,b) => a.chronoId - b.chronoId);

            sortedDays.forEach(day => {
                labels.push(`Giorno ${day.chronoId}`);
                
                let dayDriveMins = 0;
                let dayDurationMins = 0;

                if (day.stages && day.stages.length > 0) {
                    day.stages.forEach(s => {
                        if (!s.isVisit) dayDriveMins += parseInt(s.driveTime || 0);
                    });

                    const sortedStages = [...day.stages].sort((a,b) => timeToMins(a.start) - timeToMins(b.start));
                    const start = timeToMins(sortedStages[0].start);
                    let end = 0;
                    
                    // FIXED: Logic for last stage end time calculation
                    const lastStage = sortedStages[sortedStages.length - 1];
                    if (lastStage.isVisit) {
                         // If last is visit, end = start + pause
                         end = timeToMins(lastStage.start) + timeToMins(lastStage.pause);
                    } else {
                         // If driving, use end time
                         end = timeToMins(lastStage.end);
                    }
                    
                    if (end < start) end += 1440; // Handle midnight crossing

                    dayDurationMins = end - start;
                }

                // Check Highlights
                if (dayDriveMins > maxDriveVal) {
                    maxDriveVal = dayDriveMins;
                    maxDriveLabel = `Giorno ${day.chronoId}`;
                }
                if (dayDurationMins > maxIntenseVal) {
                    maxIntenseVal = dayDurationMins;
                    maxIntenseLabel = `Giorno ${day.chronoId}`;
                }

                // Calculate proportions for 100% stacked chart
                const driveHours = (dayDriveMins / 60).toFixed(1);
                const totalHours = (dayDurationMins / 60).toFixed(1);
                
                let driveP = 0;
                if (dayDurationMins > 0) {
                    driveP = (dayDriveMins / dayDurationMins) * 100;
                } else if (dayDriveMins > 0) {
                    driveP = 100; // Edge case
                }
                
                if (driveP > 100) driveP = 100;
                if (driveP < 0) driveP = 0;
                
                const restP = 100 - driveP;

                driveData.push(driveP);
                restData.push(restP);
                metaData.push({ drive: driveHours, total: totalHours, pct: Math.round(driveP) });
            });

            // Update Highlights DOM (Safe Checks)
            const highIntenseDay = document.getElementById('high-intense-day');
            const highIntenseVal = document.getElementById('high-intense-val');
            const highDriveDay = document.getElementById('high-drive-day');
            const highDriveVal = document.getElementById('high-drive-val');

            if(highIntenseDay) highIntenseDay.textContent = maxIntenseLabel;
            if(highIntenseVal) highIntenseVal.textContent = minsToTimeStr(maxIntenseVal);
            if(highDriveDay) highDriveDay.textContent = maxDriveLabel;
            if(highDriveVal) highDriveVal.textContent = minsToTimeStr(maxDriveVal);

            const canvas = document.getElementById('activityChart');
            if(!canvas) return; 

            const ctx = canvas.getContext('2d');

            if (activityChart) {
                activityChart.destroy();
            }

            activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ore Guida',
                            data: driveData,
                            backgroundColor: '#fb923c', // orange-400
                            borderRadius: 4,
                            stack: 'Stack 0',
                            barPercentage: 0.6,
                            categoryPercentage: 0.9
                        },
                        {
                            label: 'Resto Giornata',
                            data: restData,
                            backgroundColor: '#d6d3d1', // stone-300
                            borderRadius: 4,
                            stack: 'Stack 0', 
                            barPercentage: 0.6,
                            categoryPercentage: 0.9
                        }
                    ]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', axis: 'y', intersect: false },
                    plugins: {
                        legend: { display: false }, 
                        tooltip: { 
                            mode: 'index', 
                            intersect: false, 
                            position: 'nearest',
                            callbacks: {
                                label: function(context) {
                                    const meta = metaData[context.dataIndex];
                                    if (!meta) return '';
                                    if (context.datasetIndex === 0) {
                                        return `Guida: ${meta.drive}h (${meta.pct}%)`;
                                    } else {
                                        return `Totale Giornata: ${meta.total}h`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true, 
                            min: 0, 
                            max: 100, 
                            title: { display: true, text: 'Percentuale Giornata (%)' }, 
                            grid: { color: '#f5f5f4' },
                            ticks: { callback: function(value) { return value + "%" } }
                        },
                        y: { 
                            stacked: true, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        };

        // --- GLOBAL SETTINGS TOGGLE LOGIC ---
        const milesToggle = document.getElementById('global-miles-toggle');
        if(milesToggle) {
            milesToggle.addEventListener('change', (e) => {
                globalShowMiles = e.target.checked;
                localStorage.setItem(`showMiles_${activeSecretKey}`, globalShowMiles);
                updateGlobalVisibility();
                if(cachedDays.length > 0) loadDays(); 
            });
        }

        const usdToggle = document.getElementById('global-usd-toggle');
        if(usdToggle) {
            usdToggle.addEventListener('change', (e) => {
                globalShowUSD = e.target.checked;
                localStorage.setItem(`showUSD_${activeSecretKey}`, globalShowUSD);
                updateGlobalVisibility();
                if(cachedExpenses.length > 0) renderExpensesList();
            });
        }

        const updateGlobalVisibility = () => {
            // Miles visibility
            const milesCard = document.getElementById('card-miles-container');
            if(milesCard) milesCard.style.display = globalShowMiles ? 'flex' : 'none';
            const sumMilesContainer = document.getElementById('sum-miles-container');
            if(sumMilesContainer) sumMilesContainer.style.display = globalShowMiles ? 'block' : 'none';

            // USD visibility
            const expensesHeaderUsd = document.getElementById('expenses-header-usd');
            if(expensesHeaderUsd) expensesHeaderUsd.style.display = globalShowUSD ? 'block' : 'none';

            const expensesInputUsd = document.getElementById('expenses-input-usd');
            if(expensesInputUsd) expensesInputUsd.style.display = globalShowUSD ? 'block' : 'none';

            const budgetTotalUsd = document.getElementById('budget-total-usd');
            if(budgetTotalUsd) budgetTotalUsd.style.display = globalShowUSD ? 'block' : 'none';

            const budgetRate = document.getElementById('budget-exchange-rate');
            if(budgetRate) budgetRate.style.display = globalShowUSD ? 'block' : 'none';
        }

        // --- EXPENSES LOGIC ---
        const rateInput = document.getElementById('global-exchange-rate');
        rateInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if(!isNaN(val) && val > 0) {
                currentExchangeRate = val;
                localStorage.setItem(`rate_${activeSecretKey}`, val);
                renderExpensesList();
            }
        });

        const loadExpenses = () => {
            const list = document.getElementById('expenses-list');
            const loading = document.getElementById('loading-expenses');
            const empty = document.getElementById('empty-expenses');
            const header = document.getElementById('expenses-header');
            
            loading.classList.remove('hidden'); list.innerHTML = '';
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', expensesColName), orderBy('createdAt', 'desc'));
            
            unsubscribeExpenses = onSnapshot(q, (snapshot) => {
                loading.classList.add('hidden');
                
                cachedExpenses = [];
                snapshot.forEach(docSnap => {
                    cachedExpenses.push({ id: docSnap.id, ...docSnap.data() });
                });

                if(cachedExpenses.length === 0) { 
                    empty.classList.remove('hidden'); 
                    if(header) header.classList.add('hidden');
                    updateTotalExpenses(0);
                    list.innerHTML = '';
                    return; 
                }
                
                empty.classList.add('hidden');
                if(header) header.classList.remove('hidden');
                renderExpensesList();

            }, (err) => { console.error(err); loading.classList.add('hidden'); });
        };

        const renderExpensesList = () => {
            const list = document.getElementById('expenses-list');
            const breakdownList = document.getElementById('budget-cat-list');
            list.innerHTML = '';
            
            let totalEur = 0;
            // Initialize sums for categories
            const sums = { hotel: 0, attraction: 0, transport: 0, other: 0 };
            const catLabels = { 
                hotel: { name: 'Hotel', icon: 'ph-bed', color: 'text-indigo-600', bg: 'bg-indigo-50' },
                attraction: { name: 'Attrazione', icon: 'ph-ticket', color: 'text-pink-600', bg: 'bg-pink-50' },
                transport: { name: 'Mezzi', icon: 'ph-bus', color: 'text-blue-600', bg: 'bg-blue-50' },
                other: { name: 'Altro', icon: 'ph-dots-three', color: 'text-stone-600', bg: 'bg-stone-50' }
            };

            cachedExpenses.forEach(data => {
                const qty = data.qty || 1; 
                const amountEur = parseFloat(data.amount || 0);
                const amountUsd = amountEur * currentExchangeRate;
                totalEur += (amountEur * qty);

                // Add to category sum
                const cat = data.category || 'other';
                if (sums[cat] !== undefined) {
                    sums[cat] += (amountEur * qty);
                } else {
                    sums['other'] += (amountEur * qty);
                }

                const qtyBadge = qty > 1 
                    ? `<span class="text-[10px] bg-stone-100 text-stone-500 font-bold px-1.5 py-0.5 rounded ml-1 border border-stone-200">x${qty}</span>` 
                    : '';

                const usdDisplay = globalShowUSD 
                    ? `<span class="font-mono text-stone-400 w-16 text-xs flex items-center justify-end">${amountUsd.toFixed(2)} $</span>` 
                    : '';

                // Link icon
                let linkHtml = '';
                if (data.link) {
                    let safeLink = data.link.trim();
                    if (!/^https?:\/\//i.test(safeLink)) {
                        safeLink = 'http://' + safeLink;
                    }
                    linkHtml = `<a href="${safeLink}" target="_blank" class="text-stone-400 hover:text-blue-500 ml-1" title="Apri link"><i class="ph-bold ph-link"></i></a>`;
                }

                // Category Icon for List Item
                const category = catLabels[cat] || catLabels['other'];
                const catIconHtml = `<span class="${category.color} ${category.bg} p-1 rounded-md mr-2 text-xs"><i class="ph-fill ${category.icon}"></i></span>`;

                const row = document.createElement('div');
                row.className = "flex items-center justify-between p-3 bg-white border border-stone-200 rounded-xl shadow-sm hover:shadow-md transition-shadow group";
                row.id = `row-${data.id}`;
                row.innerHTML = `
                    <div class="flex-grow pr-2 flex items-center">
                        ${catIconHtml}
                        <div class="font-bold text-stone-700 text-sm break-words leading-snug">
                            ${data.name}
                            ${linkHtml}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex gap-4 text-right">
                            <span class="font-mono font-bold text-emerald-600 w-16 flex justify-end items-center">${amountEur.toFixed(2)} € ${qtyBadge}</span>
                            ${usdDisplay}
                        </div>
                        <div class="flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                            <button onclick="enableEditMode('${data.id}', '${data.name.replace(/'/g, "\\'")}', ${amountEur}, ${qty}, '${data.link ? data.link.replace(/'/g, "\\'") : ''}', '${cat}')" class="p-1.5 text-stone-400 hover:text-emerald-500 rounded hover:bg-emerald-50"><i class="ph-bold ph-pencil-simple"></i></button>
                            <button onclick="deleteExpense('${data.id}')" class="p-1.5 text-stone-400 hover:text-red-500 rounded hover:bg-red-50"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
            updateTotalExpenses(totalEur);

            // Render Breakdown
            if(breakdownList) {
                breakdownList.innerHTML = '';
                Object.keys(sums).forEach(key => {
                    const val = sums[key];
                    if (val > 0) {
                        const meta = catLabels[key];
                        const pct = totalEur > 0 ? ((val / totalEur) * 100).toFixed(0) : 0;
                        const item = document.createElement('div');
                        item.className = "flex justify-between items-center bg-white p-2 rounded-lg border border-stone-100";
                        item.innerHTML = `
                            <div class="flex items-center gap-2">
                                <div class="${meta.bg} ${meta.color} p-1.5 rounded-md"><i class="ph-fill ${meta.icon}"></i></div>
                                <span class="text-xs font-bold text-stone-600">${meta.name}</span>
                            </div>
                            <div class="text-right">
                                <span class="font-mono font-bold text-stone-700 text-sm">${val.toFixed(2)} €</span>
                                <span class="text-[10px] text-stone-400 ml-1">(${pct}%)</span>
                            </div>
                        `;
                        breakdownList.appendChild(item);
                    }
                });
                if (totalEur === 0) {
                    breakdownList.innerHTML = '<p class="text-center text-xs text-stone-300 italic">Nessun dato.</p>';
                }
            }
        };

        const updateTotalExpenses = (totalEur) => {
            const totalEl = document.getElementById('total-expenses');
            const totalElUsd = document.getElementById('total-expenses-usd');
            if(totalEl) totalEl.innerHTML = `${totalEur.toFixed(2)} <span class="text-2xl">€</span>`;
            if(totalElUsd) totalElUsd.textContent = `${(totalEur * currentExchangeRate).toFixed(2)} $`;
        };

        // Auto Conversion Logic for Input Bar
        const eurInput = document.getElementById('expense-amount-input');
        const usdInput = document.getElementById('expense-amount-usd-input');

        eurInput.addEventListener('input', () => {
            const eurVal = parseFloat(eurInput.value);
            if (!isNaN(eurVal)) {
                usdInput.value = (eurVal * currentExchangeRate).toFixed(2);
            } else {
                usdInput.value = '';
            }
        });

        usdInput.addEventListener('input', () => {
            const usdVal = parseFloat(usdInput.value);
            if (!isNaN(usdVal)) {
                eurInput.value = (usdVal / currentExchangeRate).toFixed(2);
            } else {
                eurInput.value = '';
            }
        });

        window.addExpense = async () => {
            const nameIn = document.getElementById('expense-name-input');
            const linkIn = document.getElementById('expense-link-input'); 
            const qtyIn = document.getElementById('expense-qty-input');
            const catIn = document.querySelector('input[name="expense-cat"]:checked'); // NEW
            
            const name = nameIn.value.trim();
            const link = linkIn.value.trim(); 
            const amount = parseFloat(eurInput.value); 
            const qty = parseInt(qtyIn.value) || 1;
            const category = catIn ? catIn.value : 'other'; // NEW

            if(!name || isNaN(amount)) return;
            
            nameIn.value = ''; 
            linkIn.value = ''; 
            eurInput.value = '';
            usdInput.value = '';
            qtyIn.value = '1'; 
            // Reset to default
            const defaultCat = document.querySelector('input[name="expense-cat"][value="other"]');
            if(defaultCat) defaultCat.checked = true;
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', expensesColName), {
                    name, link, amount, qty, category, createdAt: serverTimestamp() // Added category
                });
            } catch(e) { console.error(e); alert("Errore aggiunta spesa"); }
        };
        document.getElementById('add-expense-btn').addEventListener('click', window.addExpense);

        window.deleteExpense = (id) => {
            if(confirm("Eliminare questa spesa?")) {
                deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', expensesColName, id));
            }
        };

        // Modified enableEditMode to accept category
        window.enableEditMode = (id, currentName, currentAmountEur, currentQty, currentLink, currentCat) => {
            const row = document.getElementById(`row-${id}`);
            if(!row) return;
            
            const currentAmountUsd = (currentAmountEur * currentExchangeRate).toFixed(2);
            const usdInputDisplay = globalShowUSD ? 'block' : 'none';
            const cat = currentCat || 'other';

            row.innerHTML = `
                <div class="w-full bg-stone-50 p-2 rounded border border-stone-200">
                    <div class="flex justify-center gap-2 mb-2">
                         <label class="cursor-pointer group">
                            <input type="radio" name="edit-cat-${id}" value="hotel" ${cat === 'hotel' ? 'checked' : ''} class="peer sr-only">
                            <span class="block p-1.5 rounded-full text-stone-400 peer-checked:bg-indigo-100 peer-checked:text-indigo-600 hover:bg-stone-200"><i class="ph-fill ph-bed"></i></span>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="edit-cat-${id}" value="attraction" ${cat === 'attraction' ? 'checked' : ''} class="peer sr-only">
                            <span class="block p-1.5 rounded-full text-stone-400 peer-checked:bg-pink-100 peer-checked:text-pink-600 hover:bg-stone-200"><i class="ph-fill ph-ticket"></i></span>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="edit-cat-${id}" value="transport" ${cat === 'transport' ? 'checked' : ''} class="peer sr-only">
                            <span class="block p-1.5 rounded-full text-stone-400 peer-checked:bg-blue-100 peer-checked:text-blue-600 hover:bg-stone-200"><i class="ph-fill ph-bus"></i></span>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="edit-cat-${id}" value="other" ${cat === 'other' ? 'checked' : ''} class="peer sr-only">
                            <span class="block p-1.5 rounded-full text-stone-400 peer-checked:bg-stone-200 peer-checked:text-stone-600 hover:bg-stone-200"><i class="ph-fill ph-dots-three"></i></span>
                        </label>
                    </div>
                    <div class="flex gap-2 w-full items-center flex-wrap sm:flex-nowrap">
                        <div class="flex-grow flex gap-1 w-full sm:w-auto">
                            <input type="text" id="edit-name-${id}" value="${currentName}" class="w-1/2 p-2 rounded border border-stone-300 text-sm focus:border-emerald-400 focus:outline-none" placeholder="Voce">
                            <input type="text" id="edit-link-${id}" value="${currentLink || ''}" class="w-1/2 p-2 rounded border border-stone-300 text-sm focus:border-emerald-400 focus:outline-none" placeholder="Link">
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <div class="relative w-12 flex-shrink-0">
                                <input type="number" id="edit-qty-${id}" value="${currentQty}" min="1" class="w-full p-2 text-center rounded border border-stone-300 text-sm font-bold text-stone-600 focus:border-emerald-400 focus:outline-none">
                            </div>
                            <div class="relative w-20">
                                <input type="number" step="0.01" id="edit-eur-${id}" value="${currentAmountEur}" oninput="syncEditCurrency('${id}', 'eur')" class="w-full p-2 pl-5 rounded border border-stone-300 text-sm font-mono focus:border-emerald-400 focus:outline-none">
                                <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">€</span>
                            </div>
                            <div class="relative w-20" style="display: ${usdInputDisplay}">
                                <input type="number" step="0.01" id="edit-usd-${id}" value="${currentAmountUsd}" oninput="syncEditCurrency('${id}', 'usd')" class="w-full p-2 pl-5 rounded border border-stone-300 text-sm font-mono focus:border-emerald-400 focus:outline-none bg-stone-100">
                                <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">$</span>
                            </div>
                        </div>
                        <div class="flex gap-1 ml-auto">
                            <button onclick="saveExpenseEdit('${id}')" class="p-2 bg-emerald-500 text-white rounded hover:bg-emerald-600 shadow-sm"><i class="ph-bold ph-check"></i></button>
                            <button onclick="cancelExpenseEdit('${id}')" class="p-2 text-stone-400 hover:bg-stone-200 rounded"><i class="ph-bold ph-x"></i></button>
                        </div>
                    </div>
                </div>
            `;
        };

        window.syncEditCurrency = (id, source) => {
            const eurInput = document.getElementById(`edit-eur-${id}`);
            const usdInput = document.getElementById(`edit-usd-${id}`);
            
            if (source === 'eur') {
                const val = parseFloat(eurInput.value);
                if(!isNaN(val)) usdInput.value = (val * currentExchangeRate).toFixed(2);
                else usdInput.value = '';
            } else {
                const val = parseFloat(usdInput.value);
                if(!isNaN(val)) eurInput.value = (val / currentExchangeRate).toFixed(2);
                else eurInput.value = '';
            }
        };

        window.saveExpenseEdit = async (id) => {
            const newName = document.getElementById(`edit-name-${id}`).value.trim();
            const newLink = document.getElementById(`edit-link-${id}`).value.trim();
            const newAmountEur = parseFloat(document.getElementById(`edit-eur-${id}`).value);
            const newQty = parseInt(document.getElementById(`edit-qty-${id}`).value) || 1;
            const newCat = document.querySelector(`input[name="edit-cat-${id}"]:checked`)?.value || 'other'; // NEW
            
            if(!newName || isNaN(newAmountEur)) return;

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', expensesColName, id), {
                    name: newName, link: newLink, amount: newAmountEur, qty: newQty, category: newCat // NEW
                });
            } catch(e) { console.error(e); alert("Errore modifica"); }
        };
        
        window.cancelExpenseEdit = (id) => {
             // Simply reload the list to cancel, as we don't have all data readily available to rebuild the row perfectly without fetching
             // Or better: call renderExpensesList() but it rebuilds all. 
             // Since we have cachedExpenses, we can rebuild just one row or all. 
             renderExpensesList();
        };

        // ... rest of the code ...
        // ... (TAB LOGIC, EXPORT LOGIC, UI MODAL LOGIC, TRAVEL REEL LOGIC remain unchanged) ...
        
        // --- TRAVEL REEL (VIDEO) LOGIC ---
        let mapInstance = null;
        let carMarker = null;
        let routePolyline = null;
        let isPlaying = false;
        let animInterval = null; // Store interval ID globally for clearing
        let videoSpeed = 1; // Default speed
        
        // Icona Auto Custom
        const carIcon = L.divIcon({
            html: '<div class="bg-orange-500 text-white p-1 rounded-full shadow-lg border-2 border-white flex items-center justify-center w-8 h-8"><i class="ph-fill ph-car-profile text-lg"></i></div>',
            className: 'car-icon-div',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        // Delay helper
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        
        // Functions for UI controls
        window.setVideoSpeed = (speed) => {
            videoSpeed = speed;
            // Update UI
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-black');
                btn.classList.add('hover:bg-white/30', 'text-white'); // Reset active style
            });
            
            // Set active
            const btnId = speed === 0.5 ? 'btn-speed-05' : (speed === 2 ? 'btn-speed-2' : 'btn-speed-1');
            const activeBtn = document.getElementById(btnId);
            if(activeBtn) {
                activeBtn.classList.remove('hover:bg-white/30', 'text-white');
                activeBtn.classList.add('bg-white', 'text-black');
            }
        };
        
        window.toggleVideoFullscreen = () => {
            const container = document.getElementById('map-video-container');
            const isFakeFullscreen = container.classList.contains('fixed');

            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else if (isFakeFullscreen) {
                 // Exit Fake Fullscreen
                 container.classList.remove('fixed', 'inset-0', 'z-[60]', 'h-screen', 'w-screen', 'rounded-none');
                 container.classList.add('h-64', 'rounded-xl', 'mb-4');
                 if(mapInstance) setTimeout(() => { mapInstance.invalidateSize(); }, 100);
            } else {
                // Try Native Fullscreen
                container.requestFullscreen().catch(err => {
                    console.warn("Native fullscreen failed, using CSS fallback:", err);
                    // Enter Fake Fullscreen
                    container.classList.remove('h-64', 'rounded-xl', 'mb-4');
                    container.classList.add('fixed', 'inset-0', 'z-[60]', 'h-screen', 'w-screen', 'rounded-none');
                    if(mapInstance) setTimeout(() => { mapInstance.invalidateSize(); }, 100);
                });
            }
        };

        // Listen for fullscreen change to resize map
        document.addEventListener('fullscreenchange', () => {
             if(mapInstance) {
                 setTimeout(() => { mapInstance.invalidateSize(); }, 100);
             }
        });

        window.playTravelVideo = async () => {
            const container = document.getElementById('map-video-container');
            const overlay = document.getElementById('video-overlay-msg');
            const statusText = document.getElementById('video-status-text');
            const btn = document.getElementById('play-video-btn');

            if (isPlaying) return;
            isPlaying = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            container.classList.remove('hidden');
            
            // Init map if needed
            if (!mapInstance) {
                mapInstance = L.map('travel-video-map', { zoomControl: false }).setView([41.9028, 12.4964], 5);
                L.control.zoom({ position: 'bottomright' }).addTo(mapInstance); 
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(mapInstance);
            }

            // Reset
            if (carMarker) mapInstance.removeLayer(carMarker);
            if (routePolyline) mapInstance.removeLayer(routePolyline);
            overlay.classList.remove('hidden');
            statusText.textContent = "Analisi tappe...";

            // 1. Gather all locations sequentially
            const allStages = [];
            cachedDays.sort((a,b) => a.chronoId - b.chronoId).forEach(day => {
                 if(day.stages) day.stages.forEach(s => {
                     if (s.name) {
                         let query = s.name;
                         if (day.title) query += `, ${day.title}`;
                         allStages.push({ query: query, name: s.name });
                     }
                 });
            });

            if (allStages.length < 2) {
                statusText.textContent = "Aggiungi almeno 2 tappe per il video!";
                setTimeout(() => { overlay.classList.add('hidden'); isPlaying = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }, 2000);
                return;
            }

            // 2. Geocode (Nominatim) - Sequential to be polite
            const coords = [];
            statusText.textContent = `Geocoding 0/${allStages.length}...`;
            
            for (let i = 0; i < allStages.length; i++) {
                const stage = allStages[i];
                statusText.textContent = `Trovo: ${stage.name}...`;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(stage.query)}&limit=1`);
                    if(res.ok) {
                        const data = await res.json();
                        if(data && data.length > 0) {
                            coords.push([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
                        }
                    }
                } catch(e) { console.error(e); }
                await sleep(800); // Polite delay
            }

            if (coords.length < 2) {
                statusText.textContent = "Impossibile trovare coordinate sufficienti.";
                setTimeout(() => { overlay.classList.add('hidden'); isPlaying = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }, 2000);
                return;
            }

            // 3. Routing (OSRM) - Use road network
            statusText.textContent = "Calcolo percorso stradale...";
            let pathPoints = [];

            const osrmCoords = coords.map(c => `${c[1]},${c[0]}`).join(';');
            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${osrmCoords}?overview=full&geometries=geojson`;

            try {
                const routeRes = await fetch(osrmUrl);
                if (routeRes.ok) {
                    const routeData = await routeRes.json();
                    if (routeData.routes && routeData.routes.length > 0) {
                        pathPoints = routeData.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    }
                }
            } catch(e) {
                console.warn("OSRM failed, falling back to straight lines");
            }
            
            // Fallback to straight lines if OSRM fails or returns empty
            if (pathPoints.length === 0) {
                 if (coords.length > 1) {
                    for (let i = 0; i < coords.length - 1; i++) {
                        const start = coords[i];
                        const end = coords[i+1];
                        const steps = 100; 
                        for (let j = 0; j <= steps; j++) {
                            const lat = start[0] + (end[0] - start[0]) * (j / steps);
                            const lng = start[1] + (end[1] - start[1]) * (j / steps);
                            pathPoints.push([lat, lng]);
                        }
                    }
                } else if (coords.length === 1) {
                    pathPoints.push(coords[0]);
                }
            }

            // Pre-calculate cumulative distances for fluid animation
            let totalDist = 0;
            const dists = [0]; // Cumulative distances at each point
            for (let i = 0; i < pathPoints.length - 1; i++) {
                const p1 = L.latLng(pathPoints[i]);
                const p2 = L.latLng(pathPoints[i+1]);
                const d = p1.distanceTo(p2);
                totalDist += d;
                dists.push(totalDist);
            }

            // 4. Setup Map & Animation
            statusText.textContent = "Pronti a partire!";
            await sleep(500);
            overlay.classList.add('hidden');

            // Draw route
            routePolyline = L.polyline(pathPoints, { color: '#fb923c', weight: 4, opacity: 0.8 }).addTo(mapInstance);
            
            // Set initial view
            mapInstance.setView(pathPoints[0], 10); 
            
            // Init Car
            carMarker = L.marker(pathPoints[0], { icon: carIcon }).addTo(mapInstance);

            // AGGIUNTA PAUSA INIZIALE PER VISUALIZZARE PARTENZA
            await sleep(2000);

            // Animate using Distance interpolation for fluidity
            const duration = 80000; // 80 seconds
            const intervalTime = 20; // 50fps
            const baseDistPerStep = totalDist / (duration / intervalTime);
            let traveled = 0;

            if (animInterval) clearInterval(animInterval);

            animInterval = setInterval(() => {
                // Apply speed multiplier
                traveled += baseDistPerStep * videoSpeed;
                
                if (traveled >= totalDist) {
                    // End
                    carMarker.setLatLng(pathPoints[pathPoints.length - 1]);
                    clearInterval(animInterval);
                    isPlaying = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }

                // Find current segment index based on distance
                // Simple linear search is okay for this scale, can be optimized with binary search if needed
                let idx = 0;
                for (let i = 0; i < dists.length - 1; i++) {
                    if (traveled >= dists[i] && traveled < dists[i+1]) {
                        idx = i;
                        break;
                    }
                }

                // Interpolate within segment
                const segmentLen = dists[idx+1] - dists[idx];
                const segmentProgress = traveled - dists[idx];
                const percent = segmentLen === 0 ? 0 : segmentProgress / segmentLen;
                
                const p1 = pathPoints[idx];
                const p2 = pathPoints[idx+1];
                const lat = p1[0] + (p2[0] - p1[0]) * percent;
                const lng = p1[1] + (p2[1] - p1[1]) * percent;
                const pos = [lat, lng];

                carMarker.setLatLng(pos);
                
                // Update view without forcing zoom level (keeps user zoom)
                // Only pan if car is getting close to edge? Or just setView every frame?
                // setView every frame at 50fps might be heavy but usually smooth on modern browsers
                mapInstance.setView(pos, mapInstance.getZoom(), { animate: false }); 
            }, intervalTime);
        };
    </script>
</body>
</html>
