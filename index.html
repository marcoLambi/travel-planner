<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Planner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        .loader {
            border: 3px solid #fff7ed; /* orange-50 */
            border-top: 3px solid #fb923c; /* orange-400 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #fff7ed; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #fdba74; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #fb923c; }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Safe area utility for modern phones */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Car Icon Animation */
        .car-icon-div {
            transition: transform 0.1s linear; /* Smooth rotation if implemented, or position updates */
            z-index: 1000 !important;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-700 font-sans h-screen overflow-hidden flex flex-col">

    <!-- App Container (Full Width) -->
    <div class="w-full h-full bg-white shadow-2xl relative flex flex-col">
        
        <!-- Header -->
        <header class="bg-orange-400 text-white p-4 shadow-md z-20 flex items-center justify-between transition-colors duration-300" id="main-header">
            <div class="flex items-center gap-3 overflow-hidden">
                <button id="back-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors flex-shrink-0">
                    <i class="ph ph-arrow-left text-xl"></i>
                </button>
                <div class="flex flex-col overflow-hidden">
                    <h1 id="header-title" class="text-xl font-bold truncate flex items-center gap-2">
                        <i class="ph-fill ph-airplane-tilt"></i> Travel Planner
                    </h1>
                    <span id="header-subtitle" class="text-xs text-orange-50 truncate hidden"></span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- LOGS BUTTON -->
                <button id="logs-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors" title="Registro Accessi">
                    <i class="ph-fill ph-eye text-xl"></i>
                </button>
                <button id="export-btn" class="hidden p-2 hover:bg-white/20 rounded-full transition-colors" title="Scarica Backup">
                    <i class="ph ph-download-simple text-xl"></i>
                </button>
                <button id="logout-btn" class="hidden text-xs bg-orange-600/30 hover:bg-orange-600/50 px-3 py-1 rounded transition-colors flex items-center gap-1">
                    <i class="ph ph-sign-out"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow relative overflow-hidden bg-stone-50">
            
            <!-- VIEW 1: Login -->
            <div id="login-view" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-50 p-6 text-center">
                <div class="p-5 bg-orange-50 rounded-full mb-6 text-orange-400">
                    <i class="ph ph-map-trifold text-6xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-stone-800">Travel Planner</h2>
                <p class="text-stone-500 mb-6 text-sm">Accedi con la tua chiave segreta.</p>
                
                <div class="w-full max-w-xs mb-4 relative mx-auto">
                    <input type="text" id="secret-key-input" class="w-full p-4 pl-12 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-orange-400 outline-none font-bold text-stone-700 tracking-wide placeholder-stone-400" placeholder="es. USA2025">
                    <i class="ph ph-key absolute left-4 top-1/2 transform -translate-y-1/2 text-stone-400 text-xl"></i>
                </div>
                
                <button id="login-btn" class="bg-orange-400 hover:bg-orange-500 text-white w-full max-w-xs py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 mb-4 transition-transform active:scale-95 mx-auto">
                    <span>Entra</span> <i class="ph ph-arrow-right"></i>
                </button>

                <div id="auth-loader" class="hidden loader border-t-orange-400 mt-4 mx-auto"></div>
                <p id="login-error" class="hidden text-red-500 text-sm mt-2"></p>
            </div>

            <!-- VIEW 2: Lista Giorni -->
            <div id="days-view" class="absolute inset-0 flex flex-col hidden overflow-hidden">
                <div class="bg-orange-50 p-2 text-center text-xs text-orange-800 font-medium border-b border-orange-100 flex justify-between px-4 items-center flex-shrink-0">
                    <span>Viaggio: <span id="current-key-display" class="font-bold">...</span></span>
                    <span class="text-[10px] text-orange-400">ID: <span id="app-id-display">...</span></span>
                </div>
                
                <!-- Lista scrollabile -->
                <div class="flex-grow overflow-y-auto p-4 pb-32 custom-scroll" id="days-list-container">
                    <div id="loading-days" class="flex justify-center mt-10"><div class="loader border-t-orange-400"></div></div>
                    <div id="empty-days" class="hidden flex flex-col items-center justify-center mt-20 text-stone-400">
                        <i class="ph ph-road-horizon text-5xl mb-3 text-stone-300"></i>
                        <p>Nessun giorno pianificato.</p>
                    </div>
                    <div id="days-list" class="space-y-3 max-w-3xl mx-auto"></div>
                </div>

                <!-- Pulsante flottante -->
                <button onclick="openModal(null)" class="absolute bottom-20 right-6 bg-orange-400 hover:bg-orange-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-20 border-2 border-white">
                    <i class="ph ph-plus text-2xl font-bold"></i>
                </button>
            </div>

            <!-- VIEW 3: Riepilogo Totale (Stats) -->
            <div id="summary-view" class="absolute inset-0 flex flex-col hidden overflow-hidden pb-0 bg-stone-100">
                <div class="flex-grow overflow-y-auto custom-scroll p-4 pb-28"> 
                    <div class="max-w-4xl mx-auto">
                        <!-- NEW GLOBAL SETTINGS TOGGLES -->
                        <div class="grid grid-cols-2 gap-2 mb-6">
                            <!-- Miles Toggle -->
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-200 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <i class="ph-bold ph-gear text-stone-400"></i>
                                    <span class="text-sm font-bold text-stone-700">Abilita unità Miglia (USA/UK)</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="global-miles-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                                </label>
                            </div>

                            <!-- USD Toggle -->
                            <div class="bg-white rounded-xl p-3 shadow-sm border border-stone-200 flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <i class="ph-bold ph-currency-dollar text-stone-400"></i>
                                    <span class="text-sm font-bold text-stone-700">Abilita valuta USD</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="global-usd-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                </label>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6 border border-stone-200 w-full mb-6">
                            <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-stone-800">Riepilogo Viaggio</h2>
                                    <p class="text-sm text-stone-400">Statistiche generali</p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-full text-orange-500">
                                    <i class="ph-fill ph-chart-pie-slice text-2xl"></i>
                                </div>
                            </div>

                            <!-- NEW ROW: Counts -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <!-- Card Stati -->
                                <div class="bg-purple-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-purple-100">
                                    <div class="bg-purple-100 p-2 rounded-full text-purple-600 mb-2"><i class="ph-bold ph-flag text-xl"></i></div>
                                    <span class="text-[10px] font-bold text-stone-500 uppercase">Stati Visitati</span>
                                    <span class="text-2xl font-black text-purple-600" id="summ-view-states">0</span>
                                </div>
                                <!-- Card Tappe Uniche (RENAMED TO TAPPE VISITATE) -->
                                <div class="bg-pink-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-pink-100">
                                    <div class="bg-pink-100 p-2 rounded-full text-pink-600 mb-2"><i class="ph-bold ph-map-pin text-xl"></i></div>
                                    <span class="text-[10px] font-bold text-stone-500 uppercase">Tappe Visitate</span>
                                    <span class="text-2xl font-black text-pink-600" id="summ-view-stages">0</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <!-- Card Auto -->
                                <div class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                    <div class="bg-amber-100 p-3 rounded-full text-amber-600 mb-2"><i class="ph-bold ph-car text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Ore Guida</span>
                                    <span class="text-2xl font-bold text-amber-500" id="summ-view-drive">--</span>
                                </div>
                                <!-- Card Miglia (CONDITIONAL) -->
                                <div id="card-miles-container" class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                                    <div class="bg-blue-100 p-3 rounded-full text-blue-600 mb-2"><i class="ph-bold ph-signpost text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Miglia Totali</span>
                                    <span class="text-2xl font-bold text-stone-700" id="summ-view-miles">--</span>
                                </div>
                                <!-- Card Km -->
                                <div class="bg-stone-50 p-4 rounded-xl flex flex-col items-center justify-center text-center border-l-4 border-green-500">
                                    <div class="bg-green-100 p-3 rounded-full text-green-600 mb-2"><i class="ph-bold ph-globe text-2xl"></i></div>
                                    <span class="text-xs font-bold text-stone-500 uppercase">Km Totali</span>
                                    <span class="text-3xl font-black text-green-600" id="summ-view-km">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- CHART SECTION -->
                        <div class="bg-white rounded-2xl shadow-xl p-4 border border-stone-200 w-full mb-6">
                            <h3 class="text-sm font-bold text-stone-600 uppercase mb-4 pl-2 border-l-4 border-orange-400">Analisi Giornaliera</h3>
                            <div class="h-96 w-full">
                                <canvas id="activityChart"></canvas>
                            </div>
                            <p class="text-[10px] text-center text-stone-400 mt-2">
                                <span class="inline-block w-2 h-2 rounded-full bg-orange-400 mr-1"></span>% Ore Guida
                                <span class="inline-block w-2 h-2 rounded-full bg-stone-300 ml-3 mr-1"></span>% Resto della Giornata
                            </p>
                        </div>

                        <!-- HIGHLIGHTS SECTION -->
                        <div class="grid grid-cols-2 gap-4 w-full mb-6">
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex flex-col items-center text-center shadow-sm">
                                <div class="bg-red-100 text-red-500 p-2 rounded-full mb-2"><i class="ph-fill ph-fire text-xl"></i></div>
                                <span class="text-[10px] font-bold text-stone-500 uppercase">Giorno Più Intenso</span>
                                <div class="font-bold text-red-600 text-lg mt-1" id="high-intense-day">--</div>
                                <div class="text-xs text-stone-400 font-mono" id="high-intense-val">--</div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-xl border border-amber-100 flex flex-col items-center text-center shadow-sm">
                                <div class="bg-amber-100 text-amber-500 p-2 rounded-full mb-2"><i class="ph-fill ph-steering-wheel text-xl"></i></div>
                                <span class="text-[10px] font-bold text-stone-500 uppercase">Più Ore Auto</span>
                                <div class="font-bold text-amber-600 text-lg mt-1" id="high-drive-day">--</div>
                                <div class="text-xs text-stone-400 font-mono" id="high-drive-val">--</div>
                            </div>
                        </div>

                        <!-- TRAVEL REEL / VIDEO SECTION -->
                        <div class="bg-gradient-to-r from-orange-400 to-amber-500 rounded-2xl shadow-xl p-6 text-white w-full mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i class="ph-fill ph-video-camera text-9xl"></i>
                            </div>
                            <div class="relative z-10">
                                <h3 class="text-xl font-bold flex items-center gap-2 mb-2"><i class="ph-fill ph-film-strip"></i> Travel Reel</h3>
                                <p class="text-sm text-orange-50 mb-4 pr-10">Rivivi il tuo viaggio! Guarda l'animazione del percorso sulla mappa.</p>
                                
                                <div id="map-video-container" class="w-full h-64 bg-white rounded-xl shadow-inner mb-4 hidden overflow-hidden relative group">
                                    <div id="travel-video-map" class="w-full h-full z-0"></div>
                                    
                                    <!-- Controlli Video -->
                                    <div id="video-controls" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-30 flex items-center gap-4 bg-black/60 backdrop-blur-md px-4 py-2 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                        <div class="flex gap-1 bg-white/20 rounded-lg p-1">
                                            <button onclick="setVideoSpeed(0.5)" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-white/30 transition-colors speed-btn" id="btn-speed-05">0.5x</button>
                                            <button onclick="setVideoSpeed(1)" class="text-[10px] font-bold px-2 py-1 rounded bg-white text-black transition-colors speed-btn" id="btn-speed-1">1x</button>
                                            <button onclick="setVideoSpeed(2)" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-white/30 transition-colors speed-btn" id="btn-speed-2">2x</button>
                                        </div>
                                        <div class="w-px h-6 bg-white/30"></div>
                                        <button onclick="toggleVideoFullscreen()" class="hover:text-orange-300 transition-colors" title="Schermo Intero">
                                            <i class="ph-bold ph-arrows-out text-xl"></i>
                                        </button>
                                    </div>

                                    <div id="video-overlay-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-black/50 z-20 hidden">
                                        <div class="text-white font-bold text-lg" id="video-status-text">Caricamento mappa...</div>
                                    </div>
                                </div>

                                <button onclick="playTravelVideo()" id="play-video-btn" class="bg-white text-orange-500 hover:bg-orange-50 font-bold py-2 px-6 rounded-xl shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                                    <i class="ph-fill ph-play-circle text-2xl"></i> Avvia Animazione
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 5: SPESE LISTA (Tab 3) -->
            <div id="expenses-view" class="absolute inset-0 flex flex-col hidden bg-stone-50 z-10">
                <!-- Header Colonne Lista - ADDED ID -->
                <div id="expenses-header" class="bg-white p-3 shadow-sm border-b border-stone-200 z-20 flex justify-between text-[10px] uppercase font-bold text-stone-400 max-w-4xl mx-auto w-full">
                    <span class="w-1/3">Voce</span>
                    <div class="flex gap-4 w-2/3 justify-end pr-14">
                        <span>Euro (€)</span>
                        <span id="expenses-header-usd">USD ($)</span> <!-- ADDED ID -->
                    </div>
                </div>

                <!-- Lista Spese -->
                <div class="flex-grow overflow-y-auto p-4 custom-scroll pb-40 w-full" id="expenses-list-container">
                    <div id="loading-expenses" class="hidden flex justify-center mt-10"><div class="loader border-t-emerald-400"></div></div>
                    <div id="empty-expenses" class="hidden flex flex-col items-center justify-center mt-10 text-stone-400">
                        <i class="ph ph-receipt text-5xl mb-3 text-stone-300"></i>
                        <p class="text-sm">Nessuna spesa registrata.</p>
                    </div>
                    <div id="expenses-list" class="space-y-2 max-w-4xl mx-auto"></div>
                </div>

                <!-- Input Bar (Fixed Bottom) -->
                <div class="absolute bottom-12 left-0 w-full bg-white p-2 border-t border-stone-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                    <div class="max-w-4xl mx-auto flex flex-col gap-2">
                        <!-- Row 1: Inputs -->
                        <div class="flex gap-2 items-center">
                            <div class="flex-grow flex gap-1">
                                <input type="text" id="expense-name-input" class="w-1/2 p-2 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs" placeholder="Voce spesa..." autocomplete="off">
                                <input type="text" id="expense-link-input" class="w-1/2 p-2 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs" placeholder="Link (opz.)" autocomplete="off">
                            </div>
                            
                            <!-- Moltiplicatore (Qtà) -->
                            <div class="relative w-12 flex-shrink-0">
                                <label class="absolute -top-2 left-1 text-[8px] text-stone-400 font-bold bg-white px-1">Qtà</label>
                                <input type="number" id="expense-qty-input" min="1" max="20" value="1" class="w-full p-2 text-center rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-bold text-stone-600">
                            </div>

                            <div class="relative w-16 flex-shrink-0">
                                <input type="number" step="0.01" id="expense-amount-input" class="w-full p-2 pl-5 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-mono" placeholder="0">
                                <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">€</span>
                            </div>

                            <div id="expenses-input-usd" class="relative w-16 flex-shrink-0"> <!-- ADDED ID -->
                                <input type="number" step="0.01" id="expense-amount-usd-input" class="w-full p-2 pl-5 rounded-lg border border-stone-200 focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 outline-none text-xs font-mono bg-stone-50" placeholder="0">
                                <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">$</span>
                            </div>

                            <button id="add-expense-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-lg shadow-md active:scale-95 transition-transform flex-shrink-0">
                                <i class="ph ph-plus text-lg font-bold"></i>
                            </button>
                        </div>
                        
                        <!-- Row 2: Categories (New) -->
                        <div class="flex gap-3 text-[10px] font-bold text-stone-500 overflow-x-auto pb-1">
                             <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="new-expense-cat" value="Pernottamenti" class="accent-emerald-500"> Pernottamenti</label>
                             <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="new-expense-cat" value="Attrazioni" class="accent-emerald-500"> Attrazioni</label>
                             <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="new-expense-cat" value="Pass e Tasse" class="accent-emerald-500"> Pass e Tasse</label>
                             <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="new-expense-cat" value="Altro" class="accent-emerald-500" checked> Altro</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: BUDGET / TOTALI (Tab 4) -->
            <div id="budget-view" class="absolute inset-0 flex flex-col hidden bg-stone-50 z-10 p-6 overflow-y-auto pb-24">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-stone-200 max-w-4xl mx-auto w-full">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-3 bg-emerald-100 rounded-full text-emerald-600"><i class="ph-fill ph-wallet text-2xl"></i></div>
                        <div>
                            <h2 class="text-2xl font-bold text-stone-800">Totale Spese</h2>
                            <p class="text-xs text-stone-400">Riepilogo finanziario</p>
                        </div>
                    </div>

                    <!-- Totale Euro -->
                    <div class="mb-4">
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-wider">Totale in Euro</span>
                        <div class="text-4xl font-black text-emerald-600 mt-1" id="total-expenses">0.00 <span class="text-2xl">€</span></div>
                    </div>

                    <!-- Totale Dollari (CONDITIONAL) -->
                    <div id="budget-total-usd" class="mb-6 pb-6 border-b border-stone-100"> <!-- ADDED ID -->
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-wider">Totale in Dollari</span>
                        <div class="text-2xl font-bold text-stone-600 mt-1 font-mono" id="total-expenses-usd">0.00 $</div>
                    </div>

                    <!-- Dettaglio Categorie (NEW) -->
                    <div class="mb-6 border-b border-stone-100 pb-6">
                        <h3 class="text-sm font-bold text-stone-600 mb-3 uppercase">Spese per Categoria</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Pernottamenti</span><span id="cat-total-Pernottamenti" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Attrazioni</span><span id="cat-total-Attrazioni" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Pass e Tasse</span><span id="cat-total-Pass e Tasse" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                            <div class="flex justify-between text-xs items-center p-2 bg-stone-50 rounded-lg"><span>Altro</span><span id="cat-total-Altro" class="font-mono font-bold text-stone-700">0.00 €</span></div>
                        </div>
                    </div>

                    <!-- Tasso Cambio (CONDITIONAL) -->
                    <div id="budget-exchange-rate"> <!-- ADDED ID -->
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-2">Tasso di Cambio Attuale</label>
                        <div class="flex items-center gap-3 bg-stone-50 p-3 rounded-xl border border-stone-200">
                            <span class="font-bold text-stone-700">1 € = </span>
                            <input type="number" step="0.01" id="global-exchange-rate" class="w-24 p-2 text-center font-mono font-bold text-lg border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400" value="1.05">
                            <span class="font-bold text-stone-700">$</span>
                        </div>
                        <p class="text-[10px] text-stone-400 mt-2 text-center">Modifica il tasso per aggiornare tutti i valori in $.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: Dettaglio Giorno -->
            <div id="notes-view" class="absolute inset-0 flex flex-col hidden bg-white z-30">
                <div class="flex-grow overflow-y-auto custom-scroll" id="notes-list-container">
                    <div id="day-detail-content" class="p-4 bg-white border-b border-stone-100 shadow-sm pb-24 max-w-4xl mx-auto"></div>
                </div>
                <div class="p-3 bg-stone-100 border-t border-stone-200 flex gap-2 items-center z-20">
                    <div class="max-w-4xl mx-auto w-full flex gap-2">
                        <input type="text" id="note-input" class="flex-grow p-3 rounded-xl border-none focus:ring-2 focus:ring-orange-400 shadow-sm text-stone-700" placeholder="Aggiungi una nota..." autocomplete="off">
                        <button id="add-note-btn" class="bg-orange-400 hover:bg-orange-500 text-white p-3 rounded-xl shadow-md active:scale-95 transition-transform">
                            <i class="ph ph-paper-plane-right text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM TAB BAR (Navigation) -->
        <nav id="bottom-nav" class="bg-white border-t border-stone-200 fixed bottom-0 w-full z-20 flex justify-center items-center h-auto min-h-[3rem] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] hidden pb-safe">
            <div class="flex w-full">
                <button onclick="switchTab('days')" id="tab-days" class="flex flex-col items-center justify-center w-1/4 py-1 text-orange-500 transition-colors">
                    <i class="ph-fill ph-calendar-blank text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Diario</span>
                </button>
                
                <button onclick="switchTab('summary')" id="tab-summary" class="flex flex-col items-center justify-center w-1/4 py-1 text-stone-400 hover:text-stone-600 transition-colors">
                    <i class="ph-bold ph-chart-pie-slice text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Riepilogo</span>
                </button>

                <button onclick="switchTab('expenses')" id="tab-expenses" class="flex flex-col items-center justify-center w-1/4 py-1 text-stone-400 hover:text-emerald-600 transition-colors">
                    <i class="ph-bold ph-receipt text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Spese</span>
                </button>

                <button onclick="switchTab('budget')" id="tab-budget" class="flex flex-col items-center justify-center w-1/4 py-1 text-stone-400 hover:text-emerald-600 transition-colors">
                    <i class="ph-bold ph-wallet text-xl mb-0.5"></i>
                    <span class="text-[9px] font-bold uppercase tracking-wider">Totali</span>
                </button>
            </div>
        </nav>

        <!-- Debug Footer -->
        <footer class="bg-stone-50 text-[10px] text-stone-400 p-1 text-center border-t select-all">
            App ID: <span id="debug-app-id" class="font-mono">loading...</span>
        </footer>

        <!-- MODAL LOGS -->
        <div id="logs-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl flex flex-col overflow-hidden h-[70vh]">
                <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                    <h3 class="text-lg font-bold text-stone-800 flex items-center gap-2"><i class="ph-fill ph-shield-check text-green-500"></i> Registro Accessi</h3>
                    <button onclick="document.getElementById('logs-modal').classList.add('hidden')" class="p-2 hover:bg-stone-200 rounded-full text-stone-500"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-4" id="logs-list">
                    <div class="text-center text-stone-400 text-sm mt-10">Caricamento...</div>
                </div>
            </div>
        </div>

        <!-- MODALE UNICO -->
        <div id="day-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm sm:p-4">
            <div class="bg-white w-full h-[95vh] sm:h-auto sm:max-h-[90vh] sm:max-w-2xl sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col overflow-hidden mx-auto">
                <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                    <h3 id="modal-title" class="text-lg font-bold text-stone-800">Pianifica Giornata</h3>
                    <button onclick="closeModal()" class="p-2 hover:bg-stone-200 rounded-full text-stone-500"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-4 custom-scroll" id="modal-body">
                    <div class="space-y-3 mb-6">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Data</label>
                                <input type="date" id="day-date-input" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg focus:ring-1 focus:ring-orange-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Stato</label>
                                <input type="text" id="day-name-input" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg focus:ring-1 focus:ring-orange-400 outline-none" placeholder="Es. California">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Descrizione Generale</label>
                            <textarea id="day-desc-input" rows="2" class="w-full p-2 bg-stone-50 border border-stone-200 rounded-lg resize-none focus:ring-1 focus:ring-orange-400 outline-none" placeholder="Obiettivi della giornata..."></textarea>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-orange-500 uppercase flex items-center gap-1"><i class="ph ph-flag-checkered"></i> Tappe & Percorso</label>
                            <!-- NEW TOGGLE -->
                            <label class="flex items-center gap-1 cursor-pointer">
                                <span class="text-[10px] font-bold text-stone-400">USA MIGLIA</span>
                                <input type="checkbox" id="use-miles-toggle" class="form-checkbox h-4 w-4 text-orange-500 rounded border-gray-300 focus:ring-orange-500" checked>
                            </label>
                        </div>
                        <div id="stages-container" class="space-y-4 mb-4"></div>
                        <button onclick="addStageUI()" class="w-full py-3 bg-orange-50 border-2 border-dashed border-orange-200 rounded-xl text-orange-500 font-bold hover:bg-orange-100 transition-colors flex items-center justify-center gap-2">
                            <i class="ph ph-plus-circle text-xl"></i> Aggiungi Tappa
                        </button>
                    </div>

                    <div class="bg-stone-800 text-white rounded-xl p-4 shadow-lg">
                        <h4 class="text-xs font-bold text-stone-400 uppercase mb-3 border-b border-stone-700 pb-1">Riepilogo Stimato</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><p class="text-stone-400 text-xs">Ore Auto Totali</p><p id="sum-drive-time" class="font-mono text-lg font-bold text-amber-400">0h 00m</p></div>
                            <div><p class="text-stone-400 text-xs">Durata Giornata</p><p id="sum-day-time" class="font-mono text-lg font-bold">0h 00m</p></div>
                            <div id="sum-miles-container"><p class="text-stone-400 text-xs">Totale Miglia</p><p id="sum-miles" class="font-mono font-bold">0 mi</p></div>
                            <div><p class="text-stone-400 text-xs">Totale Km</p><p id="sum-km" class="font-mono font-bold text-green-400">0 km</p></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-stone-100 bg-white flex justify-end gap-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-stone-500 hover:bg-stone-100 rounded-lg transition-colors">Annulla</button>
                    <button id="confirm-save-btn" class="px-6 py-2 bg-orange-400 text-white rounded-lg font-bold shadow-md hover:bg-orange-500 flex items-center gap-2 transition-transform active:scale-95">
                        <i class="ph ph-floppy-disk"></i> Salva Tutto
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, query, where, getDocs, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // CONFIGURAZIONE PERSONALE
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCGKOOLOXRU5-kKlROBjBt3n9QLOoh0pEA",
            authDomain: "mio-diario-viaggi.firebaseapp.com",
            projectId: "mio-diario-viaggi",
            storageBucket: "mio-diario-viaggi.firebasestorage.app",
            messagingSenderId: "826682465160",
            appId: "1:826682465160:web:f92ba804c99ad3e651b83d"
        };
        const appId = 'travel-planner-v1'; 
        // =================================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Update Debug Footer safely
        const debugAppIdEl = document.getElementById('debug-app-id');
        if(debugAppIdEl) debugAppIdEl.textContent = appId;

        // --- State ---
        let currentAuthUser = null;
        let activeSecretKey = null;
        let daysColName = null;
        let notesColName = null;
        let logsColName = null; 
        let expensesColName = null; 
        let currentDayId = null;
        let editingDayId = null;
        let unsubscribeDays = null;
        let unsubscribeNotes = null;
        let unsubscribeAllNotes = null; // NEW: Listener for all notes
        let unsubscribeExpenses = null; 
        let currentStages = []; 
        let cachedDays = []; 
        let cachedGlobalNotes = []; // NEW: Cache for all notes
        let cachedExpenses = []; 
        let activityChart = null; 
        let currentExchangeRate = 1.05; // Default
        let globalShowMiles = true; 
        let globalShowUSD = true; // NEW STATE

        // --- Helpers ---
        const generateColNames = (key) => {
            const safe = key.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            return safe.length < 3 ? null : { 
                days: `days_${safe}`, 
                notes: `notes_${safe}`, 
                logs: `logs_${safe}`, 
                expenses: `expenses_${safe}`, 
                display: key.trim().toUpperCase() 
            };
        };

        const timeToMins = (t) => {
            if(!t) return 0;
            const [h, m] = t.split(':').map(Number);
            return (h * 60) + m;
        };

        const minsToHHMM = (m) => {
            let mins = m % 1440;
            if (mins < 0) mins += 1440;
            const h = Math.floor(mins / 60);
            const min = mins % 60;
            return `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
        };

        const minsToTimeStr = (m) => {
            if(m < 0) return "--";
            const h = Math.floor(m / 60);
            const min = m % 60;
            return `${h}h ${min.toString().padStart(2, '0')}m`;
        };

        const getMapsUrl = (input) => {
            if (!input) return '';
            let text = input.trim();
            if (/^https?:\/\//i.test(text)) return text;
            if (/^(www\.|maps\.)/i.test(text) || text.includes('google.com/maps')) {
                return 'https://' + text;
            }
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(text)}`;
        };
        
        // --- LOGS LOGIC ---
        const getDeviceType = () => {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "Tablet";
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated/.test(ua)) return "Mobile";
            return "Desktop/Laptop";
        };

        const logAccess = async () => {
             if(!logsColName) return;
             
             let locationStr = "Posizione non disponibile";
             
             try {
                 // Try fetching location, but don't block execution if it fails
                 const res = await fetch('https://ipapi.co/json/');
                 if(res.ok) {
                     const data = await res.json();
                     if(data.city) locationStr = `${data.city}, ${data.country_name}`;
                 }
             } catch(e) {
                 // Ignore network errors for location service (CORS/Adblock)
                 console.log("Location service unavailable, skipping.");
             }

             try {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', logsColName), {
                     timestamp: serverTimestamp(),
                     device: getDeviceType(),
                     userAgent: navigator.userAgent,
                     location: locationStr 
                 });
             } catch(e) { console.error("Logging failed", e); }
        };

        const showLogs = () => {
            if(!logsColName) return;
            const modal = document.getElementById('logs-modal');
            const list = document.getElementById('logs-list');
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="flex justify-center p-4"><div class="loader w-6 h-6 border-t-orange-500"></div></div>';

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', logsColName), orderBy('timestamp', 'desc'), limit(20));
            getDocs(q).then(snap => {
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p class="text-center text-stone-400 text-sm">Nessun accesso registrato.</p>';
                    return;
                }
                snap.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate() : new Date();
                    const formattedDate = date.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    
                    const locationDisplay = data.location || 'N/D';

                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center py-3 border-b border-stone-100 last:border-0";
                    item.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-stone-700 flex items-center gap-1">
                                ${data.device || 'Sconosciuto'} 
                                <span class="text-[10px] font-normal text-stone-500 bg-stone-100 px-1 rounded ml-1 flex items-center gap-0.5"><i class="ph-bold ph-map-pin"></i> ${data.location || 'N/D'}</span>
                            </span>
                            <span class="text-[10px] text-stone-400 truncate w-40">${data.userAgent}</span>
                        </div>
                        <span class="text-xs font-mono text-orange-500 bg-orange-50 px-2 py-1 rounded">${formattedDate}</span>
                    `;
                    list.appendChild(item);
                });
            });
        };

        if(document.getElementById('logs-btn')) document.getElementById('logs-btn').onclick = showLogs;


        // --- CHART LOGIC ---
        const updateSummaryChart = () => {
            if (!cachedDays || cachedDays.length === 0) return;

            const labels = [];
            const driveData = []; // Pure numbers for chart
            const restData = [];  // Pure numbers for chart
            const metaData = [];  // Stores raw hours for tooltip

            let maxDriveVal = 0;
            let maxDriveLabel = '--';
            let maxIntenseVal = 0;
            let maxIntenseLabel = '--';

            const sortedDays = [...cachedDays].sort((a,b) => a.chronoId - b.chronoId);

            sortedDays.forEach(day => {
                labels.push(`Giorno ${day.chronoId}`);
                
                let dayDriveMins = 0;
                let dayDurationMins = 0;

                if (day.stages && day.stages.length > 0) {
                    day.stages.forEach(s => {
                        if (!s.isVisit) dayDriveMins += parseInt(s.driveTime || 0);
                    });

                    const sortedStages = [...day.stages].sort((a,b) => timeToMins(a.start) - timeToMins(b.start));
                    const start = timeToMins(sortedStages[0].start);
                    let end = 0;
                    
                    // FIXED: Logic for last stage end time calculation
                    const lastStage = sortedStages[sortedStages.length - 1];
                    if (lastStage.isVisit) {
                         // If last is visit, end = start + pause
                         end = timeToMins(lastStage.start) + timeToMins(lastStage.pause);
                    } else {
                         // If driving, use end time
                         end = timeToMins(lastStage.end);
                    }
                    
                    if (end < start) end += 1440; // Handle midnight crossing

                    dayDurationMins = end - start;
                }

                // Check Highlights
                if (dayDriveMins > maxDriveVal) {
                    maxDriveVal = dayDriveMins;
                    maxDriveLabel = `Giorno ${day.chronoId}`;
                }
                if (dayDurationMins > maxIntenseVal) {
                    maxIntenseVal = dayDurationMins;
                    maxIntenseLabel = `Giorno ${day.chronoId}`;
                }

                // Calculate proportions for 100% stacked chart
                const driveHours = (dayDriveMins / 60).toFixed(1);
                const totalHours = (dayDurationMins / 60).toFixed(1);
                
                let driveP = 0;
                if (dayDurationMins > 0) {
                    driveP = (dayDriveMins / dayDurationMins) * 100;
                } else if (dayDriveMins > 0) {
                    driveP = 100; // Edge case
                }
                
                if (driveP > 100) driveP = 100;
                if (driveP < 0) driveP = 0;
                
                const restP = 100 - driveP;

                driveData.push(driveP);
                restData.push(restP);
                metaData.push({ drive: driveHours, total: totalHours, pct: Math.round(driveP) });
            });

            // Update Highlights DOM (Safe Checks)
            const highIntenseDay = document.getElementById('high-intense-day');
            const highIntenseVal = document.getElementById('high-intense-val');
            const highDriveDay = document.getElementById('high-drive-day');
            const highDriveVal = document.getElementById('high-drive-val');

            if(highIntenseDay) highIntenseDay.textContent = maxIntenseLabel;
            if(highIntenseVal) highIntenseVal.textContent = minsToTimeStr(maxIntenseVal);
            if(highDriveDay) highDriveDay.textContent = maxDriveLabel;
            if(highDriveVal) highDriveVal.textContent = minsToTimeStr(maxDriveVal);

            const canvas = document.getElementById('activityChart');
            if(!canvas) return; 

            const ctx = canvas.getContext('2d');

            if (activityChart) {
                activityChart.destroy();
            }

            activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ore Guida',
                            data: driveData,
                            backgroundColor: '#fb923c', // orange-400
                            borderRadius: 4,
                            stack: 'Stack 0',
                            barPercentage: 0.6,
                            categoryPercentage: 0.9
                        },
                        {
                            label: 'Resto Giornata',
                            data: restData,
                            backgroundColor: '#d6d3d1', // stone-300
                            borderRadius: 4,
                            stack: 'Stack 0', 
                            barPercentage: 0.6,
                            categoryPercentage: 0.9
                        }
                    ]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', axis: 'y', intersect: false },
                    plugins: {
                        legend: { display: false }, 
                        tooltip: { 
                            mode: 'index', 
                            intersect: false, 
                            position: 'nearest',
                            callbacks: {
                                label: function(context) {
                                    const meta = metaData[context.dataIndex];
                                    if (!meta) return '';
                                    if (context.datasetIndex === 0) {
                                        return `Guida: ${meta.drive}h (${meta.pct}%)`;
                                    } else {
                                        return `Totale Giornata: ${meta.total}h`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true, 
                            min: 0, 
                            max: 100, 
                            title: { display: true, text: 'Percentuale Giornata (%)' }, 
                            grid: { color: '#f5f5f4' },
                            ticks: { callback: function(value) { return value + "%" } }
                        },
                        y: { 
                            stacked: true, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        };

        // --- GLOBAL SETTINGS TOGGLE LOGIC ---
        const milesToggle = document.getElementById('global-miles-toggle');
        if(milesToggle) {
            milesToggle.addEventListener('change', (e) => {
                globalShowMiles = e.target.checked;
                localStorage.setItem(`showMiles_${activeSecretKey}`, globalShowMiles);
                updateGlobalVisibility();
                if(cachedDays.length > 0) renderDaysUI(); 
            });
        }

        const usdToggle = document.getElementById('global-usd-toggle');
        if(usdToggle) {
            usdToggle.addEventListener('change', (e) => {
                globalShowUSD = e.target.checked;
                localStorage.setItem(`showUSD_${activeSecretKey}`, globalShowUSD);
                updateGlobalVisibility();
                if(cachedExpenses.length > 0) renderExpensesList();
            });
        }

        const updateGlobalVisibility = () => {
            // Miles visibility
            const milesCard = document.getElementById('card-miles-container');
            if(milesCard) milesCard.style.display = globalShowMiles ? 'flex' : 'none';
            const sumMilesContainer = document.getElementById('sum-miles-container');
            if(sumMilesContainer) sumMilesContainer.style.display = globalShowMiles ? 'block' : 'none';

            // USD visibility
            const expensesHeaderUsd = document.getElementById('expenses-header-usd');
            if(expensesHeaderUsd) expensesHeaderUsd.style.display = globalShowUSD ? 'block' : 'none';

            const expensesInputUsd = document.getElementById('expenses-input-usd');
            if(expensesInputUsd) expensesInputUsd.style.display = globalShowUSD ? 'block' : 'none';

            const budgetTotalUsd = document.getElementById('budget-total-usd');
            if(budgetTotalUsd) budgetTotalUsd.style.display = globalShowUSD ? 'block' : 'none';

            const budgetRate = document.getElementById('budget-exchange-rate');
            if(budgetRate) budgetRate.style.display = globalShowUSD ? 'block' : 'none';
        }

        // --- EXPENSES LOGIC ---
        const rateInput = document.getElementById('global-exchange-rate');
        rateInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if(!isNaN(val) && val > 0) {
                currentExchangeRate = val;
                localStorage.setItem(`rate_${activeSecretKey}`, val);
                renderExpensesList();
            }
        });

        const loadExpenses = () => {
            const list = document.getElementById('expenses-list');
            const loading = document.getElementById('loading-expenses');
            const empty = document.getElementById('empty-expenses');
            const header = document.getElementById('expenses-header');
            
            loading.classList.remove('hidden'); list.innerHTML = '';
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', expensesColName), orderBy('createdAt', 'desc'));
            
            unsubscribeExpenses = onSnapshot(q, (snapshot) => {
                loading.classList.add('hidden');
                
                cachedExpenses = [];
                snapshot.forEach(docSnap => {
                    cachedExpenses.push({ id: docSnap.id, ...docSnap.data() });
                });

                if(cachedExpenses.length === 0) { 
                    empty.classList.remove('hidden'); 
                    if(header) header.classList.add('hidden');
                    updateTotalExpenses(0);
                    list.innerHTML = '';
                    return; 
                }
                
                empty.classList.add('hidden');
                if(header) header.classList.remove('hidden');
                renderExpensesList();

            }, (err) => { console.error(err); loading.classList.add('hidden'); });
        };

        const renderExpensesList = () => {
            const list = document.getElementById('expenses-list');
            list.innerHTML = '';
            let totalEur = 0;
            // NEW: Init category sums
            const catSums = { 'Pernottamenti': 0, 'Attrazioni': 0, 'Pass e Tasse': 0, 'Altro': 0 };

            cachedExpenses.forEach((data, index) => { // ADDED index
                const qty = data.qty || 1; 
                const amountEur = parseFloat(data.amount || 0);
                const amountUsd = amountEur * currentExchangeRate;
                totalEur += (amountEur * qty);

                // Accumulate Category
                const cat = data.category || 'Altro';
                if(catSums[cat] !== undefined) catSums[cat] += (amountEur * qty);
                else catSums['Altro'] += (amountEur * qty);

                const qtyBadge = qty > 1 
                    ? `<span class="text-[10px] bg-stone-100 text-stone-500 font-bold px-1.5 py-0.5 rounded ml-1 border border-stone-200">x${qty}</span>` 
                    : '';

                const usdDisplay = globalShowUSD 
                    ? `<span class="font-mono text-stone-400 w-16 text-xs flex items-center justify-end">${amountUsd.toFixed(2)} $</span>` 
                    : '';

                // NEW: Add link icon if link exists
                let linkHtml = '';
                if (data.link) {
                    let safeLink = data.link.trim();
                    if (!/^https?:\/\//i.test(safeLink)) {
                        safeLink = 'http://' + safeLink;
                    }
                    linkHtml = `<a href="${safeLink}" target="_blank" class="text-stone-400 hover:text-blue-500 ml-1" title="Apri link"><i class="ph-bold ph-link"></i></a>`;
                }

                const catLabel = cat !== 'Altro' ? `<span class="text-[9px] text-stone-400 bg-stone-100 px-1 rounded ml-1">${cat}</span>` : '';

                // NEW: Sorting Buttons Logic
                const upBtn = index > 0 
                    ? `<button onclick="moveExpenseUp('${data.id}')" class="text-stone-300 hover:text-orange-500 p-0.5 leading-none"><i class="ph-bold ph-caret-up"></i></button>` 
                    : `<span class="w-3 h-3"></span>`;
                const downBtn = index < cachedExpenses.length - 1
                    ? `<button onclick="moveExpenseDown('${data.id}')" class="text-stone-300 hover:text-orange-500 p-0.5 leading-none"><i class="ph-bold ph-caret-down"></i></button>`
                    : `<span class="w-3 h-3"></span>`;

                const row = document.createElement('div');
                row.className = "flex items-center justify-between p-3 bg-white border border-stone-200 rounded-xl shadow-sm hover:shadow-md transition-shadow group";
                row.id = `row-${data.id}`;
                
                // MODIFIED: Layout to include arrows next to name
                row.innerHTML = `
                    <div class="flex-grow pr-2 flex items-start gap-3">
                        <div class="flex flex-col justify-center items-center gap-0.5 mt-0.5 bg-stone-50 rounded border border-stone-100 p-0.5 flex-shrink-0">
                            ${upBtn}
                            ${downBtn}
                        </div>
                        <div class="font-bold text-stone-700 text-sm break-words pt-1">
                            ${data.name}
                            ${linkHtml}
                            ${catLabel}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex gap-4 text-right">
                            <span class="font-mono font-bold text-emerald-600 w-16 flex justify-end items-center">${amountEur.toFixed(2)} € ${qtyBadge}</span>
                            ${usdDisplay}
                        </div>
                        <div class="flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                            <button onclick="enableEditMode('${data.id}', '${data.name.replace(/'/g, "\\'")}', ${amountEur}, ${qty}, '${data.link ? data.link.replace(/'/g, "\\'") : ''}')" class="p-1.5 text-stone-400 hover:text-emerald-500 rounded hover:bg-emerald-50"><i class="ph-bold ph-pencil-simple"></i></button>
                            <button onclick="deleteExpense('${data.id}')" class="p-1.5 text-stone-400 hover:text-red-500 rounded hover:bg-red-50"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
            updateTotalExpenses(totalEur, catSums);
        };

        // NEW: Move Expense Up (Swaps createdAt with previous item)
        window.moveExpenseUp = async (id) => {
            const index = cachedExpenses.findIndex(e => e.id === id);
            if (index > 0) {
                const curr = cachedExpenses[index];
                const prev = cachedExpenses[index - 1];
                
                try {
                    const batch = writeBatch(db);
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', expensesColName);
                    
                    // Swap creation timestamps to reorder in the query
                    batch.update(doc(colRef, curr.id), { createdAt: prev.createdAt });
                    batch.update(doc(colRef, prev.id), { createdAt: curr.createdAt });
                    
                    await batch.commit();
                } catch(e) { console.error("Error moving up", e); }
            }
        };

        // NEW: Move Expense Down (Swaps createdAt with next item)
        window.moveExpenseDown = async (id) => {
            const index = cachedExpenses.findIndex(e => e.id === id);
            if (index < cachedExpenses.length - 1) {
                const curr = cachedExpenses[index];
                const next = cachedExpenses[index + 1];
                
                try {
                    const batch = writeBatch(db);
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', expensesColName);
                    
                    batch.update(doc(colRef, curr.id), { createdAt: next.createdAt });
                    batch.update(doc(colRef, next.id), { createdAt: curr.createdAt });
                    
                    await batch.commit();
                } catch(e) { console.error("Error moving down", e); }
            }
        };

        const updateTotalExpenses = (totalEur, catSums) => {
            const totalEl = document.getElementById('total-expenses');
            const totalElUsd = document.getElementById('total-expenses-usd');
            if(totalEl) totalEl.innerHTML = `${totalEur.toFixed(2)} <span class="text-2xl">€</span>`;
            if(totalElUsd) totalElUsd.textContent = `${(totalEur * currentExchangeRate).toFixed(2)} $`;

            // Update Categories
            if (catSums) {
                for (const [key, val] of Object.entries(catSums)) {
                    const el = document.getElementById(`cat-total-${key}`);
                    if (el) el.textContent = `${val.toFixed(2)} €`;
                }
            }
        };

        // Auto Conversion Logic for Input Bar
        const eurInput = document.getElementById('expense-amount-input');
        const usdInput = document.getElementById('expense-amount-usd-input');

        eurInput.addEventListener('input', () => {
            const eurVal = parseFloat(eurInput.value);
            if (!isNaN(eurVal)) {
                usdInput.value = (eurVal * currentExchangeRate).toFixed(2);
            } else {
                usdInput.value = '';
            }
        });

        usdInput.addEventListener('input', () => {
            const usdVal = parseFloat(usdInput.value);
            if (!isNaN(usdVal)) {
                eurInput.value = (usdVal / currentExchangeRate).toFixed(2);
            } else {
                eurInput.value = '';
            }
        });

        window.addExpense = async () => {
            const nameIn = document.getElementById('expense-name-input');
            const linkIn = document.getElementById('expense-link-input'); // NEW
            const qtyIn = document.getElementById('expense-qty-input');
            // Get Category
            const catIn = document.querySelector('input[name="new-expense-cat"]:checked');
            
            const name = nameIn.value.trim();
            const link = linkIn.value.trim(); // NEW
            const amount = parseFloat(eurInput.value); 
            const qty = parseInt(qtyIn.value) || 1;
            const category = catIn ? catIn.value : 'Altro';

            if(!name || isNaN(amount)) return;
            
            nameIn.value = ''; 
            linkIn.value = ''; // NEW
            eurInput.value = '';
            usdInput.value = '';
            qtyIn.value = '1'; 
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', expensesColName), {
                    name, link, amount, qty, category, createdAt: serverTimestamp()
                });
            } catch(e) { console.error(e); alert("Errore aggiunta spesa"); }
        };
        document.getElementById('add-expense-btn').addEventListener('click', window.addExpense);

        window.deleteExpense = (id) => {
            if(confirm("Eliminare questa spesa?")) {
                deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', expensesColName, id));
            }
        };

        // Modified enableEditMode to accept link
        window.enableEditMode = (id, currentName, currentAmountEur, currentQty, currentLink) => {
            const row = document.getElementById(`row-${id}`);
            if(!row) return;
            
            const currentAmountUsd = (currentAmountEur * currentExchangeRate).toFixed(2);
            const usdInputDisplay = globalShowUSD ? 'block' : 'none';

            // Modified layout to include link input
            row.innerHTML = `
                <div class="flex gap-2 w-full items-center flex-wrap sm:flex-nowrap bg-stone-50 p-2 rounded">
                    <div class="flex-grow flex gap-1 w-full sm:w-auto">
                        <input type="text" id="edit-name-${id}" value="${currentName}" class="w-1/2 p-2 rounded border border-stone-300 text-sm focus:border-emerald-400 focus:outline-none" placeholder="Voce">
                        <input type="text" id="edit-link-${id}" value="${currentLink || ''}" class="w-1/2 p-2 rounded border border-stone-300 text-sm focus:border-emerald-400 focus:outline-none" placeholder="Link">
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <div class="relative w-12 flex-shrink-0">
                            <input type="number" id="edit-qty-${id}" value="${currentQty}" min="1" class="w-full p-2 text-center rounded border border-stone-300 text-sm font-bold text-stone-600 focus:border-emerald-400 focus:outline-none">
                        </div>
                        <div class="relative w-20">
                            <input type="number" step="0.01" id="edit-eur-${id}" value="${currentAmountEur}" oninput="syncEditCurrency('${id}', 'eur')" class="w-full p-2 pl-5 rounded border border-stone-300 text-sm font-mono focus:border-emerald-400 focus:outline-none">
                            <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">€</span>
                        </div>
                        <div class="relative w-20" style="display: ${usdInputDisplay}">
                            <input type="number" step="0.01" id="edit-usd-${id}" value="${currentAmountUsd}" oninput="syncEditCurrency('${id}', 'usd')" class="w-full p-2 pl-5 rounded border border-stone-300 text-sm font-mono focus:border-emerald-400 focus:outline-none bg-stone-100">
                            <span class="absolute left-1.5 top-1/2 -translate-y-1/2 text-stone-400 text-[10px]">$</span>
                        </div>
                    </div>
                    <div class="flex gap-1 ml-auto">
                        <button onclick="saveExpenseEdit('${id}')" class="p-2 bg-emerald-500 text-white rounded hover:bg-emerald-600 shadow-sm"><i class="ph-bold ph-check"></i></button>
                        <button onclick="cancelExpenseEdit('${id}', '${currentName.replace(/'/g, "\\'")}', ${currentAmountEur}, ${currentQty}, '${currentLink ? currentLink.replace(/'/g, "\\'") : ''}')" class="p-2 text-stone-400 hover:bg-stone-200 rounded"><i class="ph-bold ph-x"></i></button>
                    </div>
                </div>
            `;
        };

        window.syncEditCurrency = (id, source) => {
            const eurInput = document.getElementById(`edit-eur-${id}`);
            const usdInput = document.getElementById(`edit-usd-${id}`);
            
            if (source === 'eur') {
                const val = parseFloat(eurInput.value);
                if(!isNaN(val)) usdInput.value = (val * currentExchangeRate).toFixed(2);
                else usdInput.value = '';
            } else {
                const val = parseFloat(usdInput.value);
                if(!isNaN(val)) eurInput.value = (val / currentExchangeRate).toFixed(2);
                else eurInput.value = '';
            }
        };

        window.saveExpenseEdit = async (id) => {
            const newName = document.getElementById(`edit-name-${id}`).value.trim();
            const newLink = document.getElementById(`edit-link-${id}`).value.trim(); // NEW
            const newAmountEur = parseFloat(document.getElementById(`edit-eur-${id}`).value);
            const newQty = parseInt(document.getElementById(`edit-qty-${id}`).value) || 1;
            
            if(!newName || isNaN(newAmountEur)) return;

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', expensesColName, id), {
                    name: newName, link: newLink, amount: newAmountEur, qty: newQty
                });
            } catch(e) { console.error(e); alert("Errore modifica"); }
        };
        
        window.cancelExpenseEdit = (id, name, amountEur, qty, link) => {
             const amountUsd = amountEur * currentExchangeRate;
             const row = document.getElementById(`row-${id}`);
             const qtyBadge = qty > 1 
                    ? `<span class="text-[10px] bg-stone-100 text-stone-500 font-bold px-1.5 py-0.5 rounded ml-1 border border-stone-200">x${qty}</span>` 
                    : '';
             const usdDisplay = globalShowUSD 
                    ? `<span class="font-mono text-stone-400 w-16 text-xs flex items-center justify-end">${amountUsd.toFixed(2)} $</span>` 
                    : '';
             
             // NEW: restore link icon logic
             let linkHtml = '';
             if (link) {
                let safeLink = link.trim();
                if (!/^https?:\/\//i.test(safeLink)) {
                    safeLink = 'http://' + safeLink;
                }
                linkHtml = `<a href="${safeLink}" target="_blank" class="text-stone-400 hover:text-blue-500 ml-1" title="Apri link"><i class="ph-bold ph-link"></i></a>`;
             }

             row.innerHTML = `
                <div class="flex-grow pr-2">
                    <div class="font-bold text-stone-700 text-sm break-words">
                        ${name}
                        ${linkHtml}
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex gap-4 text-right">
                        <span class="font-mono font-bold text-emerald-600 w-16 flex justify-end items-center">${amountEur.toFixed(2)} € ${qtyBadge}</span>
                        ${usdDisplay}
                    </div>
                    <div class="flex gap-1">
                        <button onclick="enableEditMode('${id}', '${name.replace(/'/g, "\\'")}', ${amountEur}, ${qty}, '${link ? link.replace(/'/g, "\\'") : ''}')" class="p-1.5 text-stone-400 hover:text-emerald-500 rounded hover:bg-emerald-50"><i class="ph-bold ph-pencil-simple"></i></button>
                        <button onclick="deleteExpense('${id}')" class="p-1.5 text-stone-400 hover:text-red-500 rounded hover:bg-red-50"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
             `;
        };


        // --- TAB NAVIGATION LOGIC ---
        window.switchTab = (tabName) => {
            const daysView = document.getElementById('days-view');
            const summaryView = document.getElementById('summary-view');
            const expensesView = document.getElementById('expenses-view'); 
            const budgetView = document.getElementById('budget-view'); 
            
            const tabDays = document.getElementById('tab-days');
            const tabSummary = document.getElementById('tab-summary');
            const tabExpenses = document.getElementById('tab-expenses');
            const tabBudget = document.getElementById('tab-budget'); 

            const resetTabs = () => {
                [tabDays, tabSummary, tabExpenses, tabBudget].forEach(t => {
                    t.classList.add('text-stone-400');
                    t.classList.remove('text-orange-500', 'text-emerald-600');
                    t.querySelector('i').classList.add('ph-bold');
                    t.querySelector('i').classList.remove('ph-fill');
                });
                [daysView, summaryView, expensesView, budgetView].forEach(v => v.classList.add('hidden'));
            };
            
            resetTabs();

            if (tabName === 'days') {
                daysView.classList.remove('hidden');
                // SCROLL RESET
                document.getElementById('days-list-container').scrollTop = 0;
                
                tabDays.classList.remove('text-stone-400');
                tabDays.classList.add('text-orange-500');
                tabDays.querySelector('i').classList.remove('ph-bold');
                tabDays.querySelector('i').classList.add('ph-fill');
            } else if (tabName === 'summary') {
                summaryView.classList.remove('hidden');
                // SCROLL RESET
                summaryView.querySelector('.custom-scroll').scrollTop = 0;

                tabSummary.classList.remove('text-stone-400');
                tabSummary.classList.add('text-orange-500'); 
                tabSummary.querySelector('i').classList.remove('ph-bold');
                tabSummary.querySelector('i').classList.add('ph-fill');
                setTimeout(updateSummaryChart, 100);
            } else if (tabName === 'expenses') {
                expensesView.classList.remove('hidden');
                // SCROLL RESET
                document.getElementById('expenses-list-container').scrollTop = 0;

                tabExpenses.classList.remove('text-stone-400');
                tabExpenses.classList.add('text-emerald-600'); 
                tabExpenses.querySelector('i').classList.remove('ph-bold');
                tabExpenses.querySelector('i').classList.add('ph-fill');
                // Ensure listener is active
                if(!unsubscribeExpenses && expensesColName) loadExpenses();
            } else if (tabName === 'budget') {
                budgetView.classList.remove('hidden');
                // SCROLL RESET
                budgetView.scrollTop = 0;

                tabBudget.classList.remove('text-stone-400');
                tabBudget.classList.add('text-emerald-600'); 
                tabBudget.querySelector('i').classList.remove('ph-bold');
                tabBudget.querySelector('i').classList.add('ph-fill');
                // Ensure listener is active so totals are correct
                if(!unsubscribeExpenses && expensesColName) loadExpenses();
            }
        };

        // --- EXPORT LOGIC ---
        document.getElementById('export-btn').onclick = async () => {
            if (!daysColName || !notesColName) return;
            const exportBtn = document.getElementById('export-btn');
            exportBtn.innerHTML = '<div class="loader w-4 h-4 border-t-white border-white"></div>';
            
            try {
                const daysSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', daysColName));
                const daysData = daysSnap.docs.map(d => ({ ...d.data(), _id: d.id })); 
                const notesSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', notesColName));
                const notesData = notesSnap.docs.map(d => d.data());
                
                // Fetch Expenses too
                const expSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', expensesColName));
                const expData = expSnap.docs.map(d => d.data());

                const backupData = {
                    key: activeSecretKey,
                    timestamp: new Date().toISOString(),
                    days: daysData,
                    notes: notesData,
                    expenses: expData 
                };

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `travel_backup_${activeSecretKey}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            } catch (error) {
                console.error("Export failed:", error);
                alert("Errore durante l'export dei dati.");
            } finally {
                exportBtn.innerHTML = '<i class="ph ph-download-simple text-xl"></i>';
            }
        };

        // --- UI Modal Logic ---
        window.addStageUI = (data = null) => {
            if (data) {
                currentStages.push(data);
            } else {
                let defaultStart = '';
                if (currentStages.length > 0) {
                    const lastStage = currentStages[currentStages.length - 1];
                    // Logic change: Check if last stage was Visit to calculate default start
                    if (lastStage.isVisit && lastStage.start && lastStage.pause) {
                         const s = timeToMins(lastStage.start);
                         const p = timeToMins(lastStage.pause);
                         defaultStart = minsToHHMM(s + p);
                    } else if (lastStage.end) {
                         defaultStart = lastStage.end;
                    }
                }
                const stage = {
                    id: Date.now(),
                    name: '', desc: '',
                    start: defaultStart, end: '', pause: '00:00',
                    miles: 0, km: 0, driveTime: 0, mapsLink: '',
                    isVisit: false 
                };
                currentStages.push(stage);
            }
            renderStages();
            calculateTotals();
        };

        window.removeStage = (id) => {
            currentStages = currentStages.filter(s => s.id !== id);
            renderStages();
            calculateTotals();
        };

        // NEW: Helper to shift time preserving duration
        const shiftStageTime = (stage, newStart) => {
            if(!newStart || stage.start === newStart) return;
            
            const oldStartMins = timeToMins(stage.start);
            const newStartMins = timeToMins(newStart);
            const diff = newStartMins - oldStartMins;
            
            stage.start = newStart;
            
            // If it has an end time (Drive), shift it to maintain duration
            if(stage.end) {
                const oldEndMins = timeToMins(stage.end);
                let newEndMins = oldEndMins + diff;
                // Handle day wrap simply by mod 1440
                if (newEndMins < 0) newEndMins += 1440;
                stage.end = minsToHHMM(newEndMins);
            }
        };

        // NEW: Move Stage Up with Time Snap
        window.moveStageUp = (id) => {
            const index = currentStages.findIndex(s => s.id === id);
            if (index > 0) {
                const prevStage = currentStages[index-1];
                const currStage = currentStages[index];
                
                // 1. Capture the start time slot of the upper element (the slot we are moving into)
                const slotStartTime = prevStage.start;
                
                // 2. Swap
                currentStages[index-1] = currStage;
                currentStages[index] = prevStage;
                
                // 3. Snap the moved-up stage to the slot start
                shiftStageTime(currStage, slotStartTime);
                
                // 4. Cascade from the new index of the moved-up stage (index-1)
                recalculateCascade(index-1);
                
                renderStages();
                calculateTotals();
            }
        };

        // NEW: Move Stage Down with Time Snap
        window.moveStageDown = (id) => {
            const index = currentStages.findIndex(s => s.id === id);
            if (index < currentStages.length - 1) {
                const currStage = currentStages[index];
                const nextStage = currentStages[index+1];
                
                // 1. The one coming up (nextStage) should take the start time of the current slot
                const slotStartTime = currStage.start;
                
                // 2. Swap
                currentStages[index] = nextStage;
                currentStages[index+1] = currStage;
                
                // 3. Snap the moved-up stage (nextStage is now at index)
                shiftStageTime(nextStage, slotStartTime);
                
                // 4. Cascade from the new upper stage (index)
                recalculateCascade(index);
                
                renderStages();
                calculateTotals();
            }
        };

        window.updateStageField = (id, field, value) => {
            const index = currentStages.findIndex(s => s.id === id);
            const stage = currentStages[index];
            
            if(stage) {
                if (field === 'isVisit') {
                    stage.isVisit = value; 
                    if (stage.isVisit) {
                         stage.miles = 0;
                         stage.km = 0;
                         stage.driveTime = 0;
                    }
                } else {
                    stage[field] = value;
                }

                if(!stage.isVisit) {
                    if(field === 'start' || field === 'end' || field === 'pause') {
                        const s = timeToMins(stage.start);
                        const e = timeToMins(stage.end);
                        const p = timeToMins(stage.pause);
                        let diff = e - s; 
                        if(diff < 0) diff += 1440; 
                        stage.driveTime = Math.max(0, diff - p);
                    }
                    if(field === 'miles') {
                         stage.km = (parseFloat(value) * 1.60934).toFixed(1);
                    }
                    if(field === 'km') {
                         stage.miles = (parseFloat(value) / 1.60934).toFixed(1);
                    }
                } 

                if (['start', 'end', 'pause', 'isVisit'].includes(field)) {
                    recalculateCascade(index);
                }

                renderStages(); 
                calculateTotals();
            }
        };

        const recalculateCascade = (changedIndex) => {
            if (changedIndex >= currentStages.length - 1) return;
            for (let i = changedIndex; i < currentStages.length - 1; i++) {
                const currentStage = currentStages[i];
                const nextStage = currentStages[i+1];
                
                let targetStartMins = 0;
                let shouldUpdate = false;

                // Logic requested by user
                if (currentStage.isVisit) {
                    // If Visit: Next Start = Current Start + Current Pause
                    const s = timeToMins(currentStage.start);
                    const p = timeToMins(currentStage.pause);
                    targetStartMins = s + p;
                    shouldUpdate = true;
                } else {
                    // If Driving: Next Start = Current End (Existing Logic)
                    if (currentStage.end) {
                        targetStartMins = timeToMins(currentStage.end);
                        shouldUpdate = true;
                    }
                }

                if (shouldUpdate) {
                    const newNextStart = minsToHHMM(targetStartMins);
                    
                    if (nextStage.start !== newNextStart) {
                        // Calculate current duration of next stage to shift it
                        const nextStartMins = timeToMins(nextStage.start);
                        const nextEndMins = timeToMins(nextStage.end);
                        
                        let durationMins = 0;
                        if(nextStage.end) {
                             durationMins = nextEndMins - nextStartMins;
                             if (durationMins < 0) durationMins += 1440;
                        }

                        // Apply new start
                        nextStage.start = newNextStart;

                        // Shift end if it existed
                        if(nextStage.end) {
                            let newNextEndMins = targetStartMins + durationMins;
                            nextStage.end = minsToHHMM(newNextEndMins);
                        }
                    }
                }
            }
            renderStages(); 
        };

        const calculateTotals = () => {
            let totalDrive = 0, totalMiles = 0, totalKm = 0, dayDuration = 0;
            currentStages.forEach(s => {
                if (!s.isVisit) {
                    totalDrive += (s.driveTime || 0);
                    totalMiles += parseFloat(s.miles || 0);
                    totalKm += parseFloat(s.km) || 0;
                }
            });
            if(currentStages.length > 0) {
                const sorted = [...currentStages].sort((a,b) => timeToMins(a.start) - timeToMins(b.start));
                const first = sorted[0];
                const last = sorted[sorted.length - 1];

                const f = timeToMins(first.start);
                let l = 0;

                if (last.isVisit) {
                    l = timeToMins(last.start) + timeToMins(last.pause);
                } else {
                    l = timeToMins(last.end);
                }

                if (l < f) l += 1440; // Handle midnight crossing

                dayDuration = Math.max(0, l - f);
            }
            // Update UI totals immediately in modal
            document.getElementById('sum-drive-time').textContent = minsToTimeStr(totalDrive);
            document.getElementById('sum-day-time').textContent = minsToTimeStr(dayDuration);
            document.getElementById('sum-miles').textContent = totalMiles.toFixed(1) + ' mi';
            document.getElementById('sum-km').textContent = totalKm.toFixed(1) + ' km';
        };

        const renderStages = () => {
            const container = document.getElementById('stages-container');
            // Remove local useMiles check, use globalShowMiles instead
            container.innerHTML = '';
            currentStages.forEach((stage, index) => {
                const div = document.createElement('div');
                div.className = "bg-stone-50 border border-stone-200 rounded-lg p-3 relative group";
                
                const autoDetailsClass = stage.isVisit ? 'hidden' : 'grid';
                const milesInputDisplay = globalShowMiles ? 'block' : 'none'; // Use global state

                let mapButtonHtml = '';
                if (stage.mapsLink) {
                    const safeUrl = getMapsUrl(stage.mapsLink);
                    mapButtonHtml = `
                        <a href="${safeUrl}" target="_blank" class="block mt-3 w-full py-2 bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-200 rounded-lg text-center text-sm font-bold transition-colors flex items-center justify-center gap-2">
                            <i class="ph-fill ph-map-pin"></i> Vedi su Google Maps
                        </a>
                    `;
                }

                let pauseDisplay = stage.pause && stage.pause !== '00:00' ? `<span class="flex items-center gap-1 text-amber-500 font-bold"><i class="ph-bold ph-coffee"></i> ${stage.pause.replace(':', 'h ')}m</span>` : '<span class="text-stone-300 flex items-center gap-1"><i class="ph ph-coffee"></i> --</span>';
                
                // FIXED: Variable s -> stage
                let typeIcon = stage.isVisit 
                    ? `<span class="text-orange-600 font-bold flex items-center gap-1 text-xs bg-orange-50 px-2 py-0.5 rounded-full border border-orange-100"><i class="ph-fill ph-ticket"></i> VISITA</span>` 
                    : `<span class="flex items-center gap-1 text-green-700 font-medium text-xs"><i class="ph-bold ph-car"></i> ${minsToTimeStr(stage.driveTime)}</span>`;

                let kmDisplay = stage.isVisit 
                    ? '' 
                    : `<div class="font-mono text-stone-400 text-xs">${parseFloat(stage.km).toFixed(0)} km</div>`;

                let milesDisplay = (globalShowMiles && !s.isVisit) ? `<div class="font-mono text-stone-400 text-xs">${s.miles} mi</div>` : ''; 

                // MODIFIED: More visible Up/Down Buttons
                const upBtn = index > 0 
                    ? `<button onclick="moveStageUp(${stage.id})" class="w-8 h-8 flex items-center justify-center bg-white border border-stone-200 rounded-lg text-stone-500 hover:text-orange-500 hover:border-orange-300 hover:bg-orange-50 transition-all shadow-sm" title="Sposta Su"><i class="ph-bold ph-arrow-up"></i></button>`
                    : `<div class="w-8 h-8"></div>`; // spacer
                
                const downBtn = index < currentStages.length - 1
                    ? `<button onclick="moveStageDown(${stage.id})" class="w-8 h-8 flex items-center justify-center bg-white border border-stone-200 rounded-lg text-stone-500 hover:text-orange-500 hover:border-orange-300 hover:bg-orange-50 transition-all shadow-sm" title="Sposta Giù"><i class="ph-bold ph-arrow-down"></i></button>`
                    : `<div class="w-8 h-8"></div>`; // spacer

                div.innerHTML = `
                    <div class="absolute top-2 right-2 flex items-center gap-2">
                        <div class="flex gap-1 mr-2">
                            ${upBtn}
                            ${downBtn}
                        </div>
                        <button onclick="removeStage(${stage.id})" class="w-8 h-8 flex items-center justify-center bg-red-50 hover:bg-red-100 text-red-500 border border-red-100 rounded-lg transition-colors shadow-sm" title="Elimina Tappa"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                    <div class="text-xs font-bold text-stone-400 mb-2 flex justify-between items-center pr-28">
                        <span>TAPPA ${index + 1}</span>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" ${stage.isVisit ? 'checked' : ''} onchange="updateStageField(${stage.id}, 'isVisit', this.checked)" class="form-checkbox h-3 w-3 text-orange-500 rounded border-gray-300 focus:ring-orange-500">
                            <span class="text-[10px] uppercase font-bold text-orange-600">Visita (No Auto)</span>
                        </label>
                    </div>
                    <div class="grid grid-cols-1 gap-2 mb-2">
                        <input type="text" value="${stage.name}" onchange="updateStageField(${stage.id}, 'name', this.value)" placeholder="Nome Tappa" class="w-full p-2 text-sm border border-stone-200 rounded bg-white font-bold text-stone-800 focus:border-orange-400 focus:outline-none">
                        <input type="text" value="${stage.desc}" onchange="updateStageField(${stage.id}, 'desc', this.value)" placeholder="Descrizione breve" class="w-full p-2 text-sm border border-stone-200 rounded bg-white text-stone-600 focus:border-orange-400 focus:outline-none">
                        <div class="relative">
                            <i class="ph ph-map-pin absolute left-3 top-1/2 -translate-y-1/2 text-stone-400"></i>
                            <input type="text" value="${stage.mapsLink || ''}" onchange="updateStageField(${stage.id}, 'mapsLink', this.value)" placeholder="Incolla link Google Maps" class="w-full p-2 pl-9 text-xs border border-stone-200 rounded bg-white text-orange-500 focus:ring-1 focus:ring-orange-400 focus:outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <div><label class="text-[10px] uppercase text-stone-500 font-bold">Partenza</label><input type="time" value="${stage.start}" onchange="updateStageField(${stage.id}, 'start', this.value)" class="w-full p-1 text-sm border border-stone-200 rounded bg-white text-stone-700"></div>
                        <div><label class="text-[10px] uppercase text-stone-500 font-bold">Arrivo</label><input type="time" value="${stage.end}" onchange="updateStageField(${stage.id}, 'end', this.value)" class="w-full p-1 text-sm border border-stone-200 rounded bg-white text-stone-700"></div>
                        <div><label class="text-[10px] uppercase text-stone-500 font-bold">Sosta (hh:mm)</label><input type="time" value="${stage.pause}" onchange="updateStageField(${stage.id}, 'pause', this.value)" class="w-full p-1 text-sm border border-stone-200 rounded bg-white text-center text-stone-700"></div>
                    </div>
                    
                    <div class="${autoDetailsClass} grid-cols-4 gap-2 items-center bg-white p-2 rounded border border-stone-200 transition-all duration-300">
                        <div class="col-span-1" style="display: ${milesInputDisplay}"><label class="text-[10px] uppercase text-stone-400">Miglia</label><input type="number" step="0.1" value="${stage.miles}" onchange="updateStageField(${stage.id}, 'miles', this.value)" class="w-full text-sm font-bold border-b border-stone-200 focus:outline-none text-orange-500"></div>
                        <div class="col-span-${globalShowMiles ? '1' : '2'} text-center border-l border-stone-100">
                            <label class="text-[10px] uppercase text-stone-400">Km</label>
                            <input type="number" step="0.1" value="${stage.km}" onchange="updateStageField(${stage.id}, 'km', this.value)" class="w-full text-sm font-bold border-b border-transparent focus:border-stone-200 focus:outline-none text-stone-600 text-center bg-transparent">
                        </div>
                        <div class="col-span-2 text-right"><label class="text-[10px] uppercase text-stone-400">Ore Auto</label><div class="text-sm font-bold text-green-600">${minsToTimeStr(stage.driveTime || 0)}</div></div>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        window.openModal = (dayData) => {
            document.getElementById('day-modal').classList.remove('hidden');
            if(dayData) {
                editingDayId = dayData.id;
                document.getElementById('modal-title').textContent = "Modifica Giornata";
                document.getElementById('day-date-input').value = dayData.dateString || '';
                document.getElementById('day-name-input').value = dayData.title || '';
                document.getElementById('day-desc-input').value = dayData.description || '';
                currentStages = dayData.stages || [];
            } else {
                editingDayId = null;
                document.getElementById('modal-title').textContent = "Nuova Giornata";
                
                // --- LOGICA DATA DI DEFAULT AL GIORNO SUCCESSIVO ---
                if (cachedDays.length > 0) {
                    const lastDateStr = cachedDays[cachedDays.length - 1].dateString;
                    if (lastDateStr) {
                        const nextDate = new Date(lastDateStr);
                        nextDate.setDate(nextDate.getDate() + 1);
                        document.getElementById('day-date-input').value = nextDate.toISOString().split('T')[0];
                    } else {
                        document.getElementById('day-date-input').valueAsDate = new Date();     
                    }
                } else {
                    document.getElementById('day-date-input').valueAsDate = new Date();
                }

                document.getElementById('day-name-input').value = '';
                document.getElementById('day-desc-input').value = '';
                currentStages = [];
            }
            renderStages();
            // Removed local toggle listener since it's global now
            calculateTotals();
        };
        window.closeModal = () => document.getElementById('day-modal').classList.add('hidden');

        document.getElementById('confirm-save-btn').addEventListener('click', async () => {
            const dateStr = document.getElementById('day-date-input').value;
            const title = document.getElementById('day-name-input').value;
            const desc = document.getElementById('day-desc-input').value;
            if(!dateStr && !title) { alert("Inserisci Data o Titolo"); return; }
            const stagesClean = currentStages.map(s => ({
                id: s.id, name: s.name, desc: s.desc, start: s.start, end: s.end, pause: s.pause,
                miles: s.miles, km: s.km, driveTime: s.driveTime, mapsLink: s.mapsLink || '', isVisit: s.isVisit || false
            }));
            const payload = { dateString: dateStr, title: title, description: desc, stages: stagesClean, updatedAt: serverTimestamp() };
            try {
                if(editingDayId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', daysColName, editingDayId), payload);
                else { payload.createdAt = serverTimestamp(); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', daysColName), payload); }
                closeModal();
            } catch(e) { console.error(e); alert("Errore Salvataggio"); }
        });

        // --- Auth & Init ---
        const login = async () => {
            const key = document.getElementById('secret-key-input').value;
            const names = generateColNames(key);
            if(!names) { document.getElementById('login-error').textContent = "Chiave non valida (min 3 chars)."; document.getElementById('login-error').classList.remove('hidden'); return; }
            document.getElementById('login-btn').classList.add('hidden');
            document.getElementById('auth-loader').classList.remove('hidden');
            try {
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                activeSecretKey = names.display;
                daysColName = names.days;
                notesColName = names.notes;
                logsColName = names.logs; 
                expensesColName = names.expenses; // Set expenses collection
                
                document.getElementById('app-id-display').textContent = appId.substring(0, 8); 
                document.getElementById('current-key-display').textContent = activeSecretKey;
                document.getElementById('login-view').classList.add('hidden');
                
                document.getElementById('days-view').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden'); 
                
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('export-btn').classList.remove('hidden');
                document.getElementById('logs-btn').classList.remove('hidden'); 

                // RESTORE RATE FROM LOCALSTORAGE
                const savedRate = localStorage.getItem(`rate_${activeSecretKey}`);
                if(savedRate) {
                    currentExchangeRate = parseFloat(savedRate);
                    document.getElementById('global-exchange-rate').value = currentExchangeRate;
                }

                // RESTORE MILES PREFERENCE
                const savedMiles = localStorage.getItem(`showMiles_${activeSecretKey}`);
                if (savedMiles !== null) {
                    globalShowMiles = (savedMiles === 'true');
                    document.getElementById('global-miles-toggle').checked = globalShowMiles;
                }

                // RESTORE USD PREFERENCE (NEW)
                const savedUSD = localStorage.getItem(`showUSD_${activeSecretKey}`);
                if (savedUSD !== null) {
                    globalShowUSD = (savedUSD === 'true');
                    document.getElementById('global-usd-toggle').checked = globalShowUSD;
                }

                updateGlobalVisibility();
                logAccess(); 
                
                // NEW: Load notes in background first, then days, or parallel
                // Better to start both listeners
                loadGlobalNotes();
                loadDays();
            } catch(e) { 
                console.error(e);
                document.getElementById('login-error').textContent = "Errore di accesso: " + e.message;
                document.getElementById('login-error').classList.remove('hidden');
            } 
            finally { document.getElementById('login-btn').classList.remove('hidden'); document.getElementById('auth-loader').classList.add('hidden'); }
        };
        document.getElementById('login-btn').addEventListener('click', login);
        
        document.getElementById('secret-key-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        document.getElementById('logout-btn').addEventListener('click', () => location.reload());

        // --- View Logic ---
        
        // NEW FUNCTION: Fetch all notes for dashboard
        const loadGlobalNotes = () => {
            const q = collection(db, 'artifacts', appId, 'public', 'data', notesColName);
            unsubscribeAllNotes = onSnapshot(q, (snapshot) => {
                cachedGlobalNotes = [];
                snapshot.forEach(d => cachedGlobalNotes.push({id: d.id, ...d.data()}));
                // When notes update, re-render the list if days are already loaded
                if(cachedDays.length > 0) renderDaysUI();
            });
        };

        const loadDays = () => {
            const loading = document.getElementById('loading-days');
            const empty = document.getElementById('empty-days');
            loading.classList.remove('hidden'); empty.classList.add('hidden'); 
            
            const q = collection(db, 'artifacts', appId, 'public', 'data', daysColName);
            
            unsubscribeDays = onSnapshot(q, (snapshot) => {
                loading.classList.add('hidden'); 
                
                if(snapshot.empty) { 
                    empty.classList.remove('hidden'); 
                    document.getElementById('days-list').innerHTML = ''; // Clear list if empty
                    return; 
                }
                empty.classList.add('hidden');
                
                const days = [];
                snapshot.forEach(d => days.push({id: d.id, ...d.data()}));
                
                days.sort((a, b) => {
                    const dateA = a.dateString || '9999-99-99';
                    const dateB = b.dateString || '9999-99-99';
                    return dateA.localeCompare(dateB);
                });

                cachedDays = days; 
                renderDaysUI(); // Extracted rendering logic

            }, (error) => { console.error(error); loading.classList.add('hidden'); });
        };

        // NEW FUNCTION: Extracted UI Rendering for Days List
        const renderDaysUI = () => {
            const list = document.getElementById('days-list');
            list.innerHTML = '';
            
            cachedDays.forEach((d, i) => d.chronoId = i + 1);
            
            let gDrive = 0, gMiles = 0, gKm = 0;
            let visitedStagesCount = 0; 
            const statesSet = new Set();

            // FIXED: Added 'i' index to callback
            cachedDays.forEach((day, i) => {
                if(day.title) {
                    const parts = day.title.split('-').map(s => s.trim().toUpperCase());
                    parts.forEach(s => {
                        if(s) statesSet.add(s);
                    });
                }

                // Check for notes for this day
                const dayNotes = cachedGlobalNotes.filter(n => n.dayId === day.id);
                // Sort notes by timestamp if available? Optional. Firestore doesn't guarantee order in snapshot array unless queried.
                // In-memory sort:
                dayNotes.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                let notesHtml = '';
                if(dayNotes.length > 0) {
                   notesHtml = '<div class="mt-3 pt-2 border-t border-stone-100 space-y-1">';
                   dayNotes.forEach(n => {
                       notesHtml += `<div class="text-xs text-stone-600 bg-yellow-50 p-2 rounded border border-yellow-100 flex items-start gap-2">
                           <i class="ph-fill ph-note text-yellow-500 mt-0.5 flex-shrink-0"></i>
                           <span>${n.text}</span>
                       </div>`;
                   });
                   notesHtml += '</div>';
                }

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-stone-200 hover:shadow-md transition-all cursor-pointer relative group";
                let dateStr = day.dateString ? new Date(day.dateString).toLocaleDateString('it-IT', {weekday: 'short', day: 'numeric', month: 'short'}) : 'N/D';
                if(dateStr !== 'N/D') dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

                let totKm = 0;
                let dayMiles = 0; 
                let visitCount = 0; 
                let tripCount = 0; 

                if (day.stages) {
                    day.stages.forEach(s => {
                        if (s.isVisit) {
                            visitedStagesCount++;
                            visitCount++;
                        } else {
                            tripCount++;
                            const stageKm = parseFloat(s.km || 0);
                            const stageMiles = parseFloat(s.miles || 0);
                            const stageDrive = parseInt(s.driveTime || 0);
                            totKm += stageKm; 
                            gKm += stageKm;
                            gMiles += stageMiles;
                            gDrive += stageDrive;
                            dayMiles += stageMiles; 
                        }
                    });
                }

                // COSTRUZIONE LISTA TAPPE ESPANSA (MODIFICA RICHIESTA)
                let stagesExpandedHtml = '';
                if (day.stages && day.stages.length > 0) {
                    stagesExpandedHtml = '<div class="mt-3 border-t border-stone-100 pt-2 space-y-2">';
                    day.stages.forEach((s, idx) => {
                         const typeIcon = s.isVisit 
                            ? `<span class="bg-orange-100 text-orange-600 p-1 rounded-full text-[10px] flex-shrink-0"><i class="ph-fill ph-ticket"></i></span>` 
                            : `<span class="bg-green-100 text-green-600 p-1 rounded-full text-[10px] flex-shrink-0"><i class="ph-bold ph-car"></i></span>`;
                         
                         const timeDisplay = s.start ? `<span class="font-mono text-[10px] text-stone-500 bg-stone-50 border border-stone-200 px-1 rounded ml-auto flex-shrink-0">${s.start}</span>` : '';

                         stagesExpandedHtml += `
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-stone-400 font-mono w-4 flex-shrink-0 text-right">${idx+1}.</span>
                                ${typeIcon}
                                <span class="text-sm font-bold text-stone-700 leading-tight">${s.name}</span>
                                ${timeDisplay}
                            </div>
                         `;
                    });
                    stagesExpandedHtml += '</div>';
                } else {
                    stagesExpandedHtml = '<div class="mt-3 text-xs text-stone-400 italic">Nessuna tappa inserita.</div>';
                }

                // NEW: Pulsanti Su/Giù per i Giorni
                const upBtnDay = i > 0 
                    ? `<button onclick="event.stopPropagation(); moveDayUp('${day.id}')" class="p-1 hover:bg-stone-100 rounded text-stone-400 hover:text-orange-500 transition-colors"><i class="ph-bold ph-caret-up text-lg"></i></button>`
                    : `<div class="w-7 h-7"></div>`; // spacer
                
                const downBtnDay = i < cachedDays.length - 1
                    ? `<button onclick="event.stopPropagation(); moveDayDown('${day.id}')" class="p-1 hover:bg-stone-100 rounded text-stone-400 hover:text-orange-500 transition-colors"><i class="ph-bold ph-caret-down text-lg"></i></button>`
                    : `<div class="w-7 h-7"></div>`; // spacer

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2 gap-2">
                        <!-- Pulsanti Spostamento -->
                        <div class="flex flex-col gap-0 border border-stone-100 rounded-lg bg-stone-50/50 p-0.5 flex-shrink-0">
                            ${upBtnDay}
                            ${downBtnDay}
                        </div>

                        <div class="flex-grow pr-2">
                            <span class="text-[10px] font-black text-orange-500 uppercase tracking-widest">GIORNO ${day.chronoId}</span>
                            <h3 class="font-bold text-stone-800 text-lg leading-tight mb-1">${day.title || 'Stato non indicato'}</h3>
                        </div>
                        <div class="bg-stone-100 text-stone-600 px-2 py-1 rounded text-xs font-bold text-center min-w-[60px] flex-shrink-0">${dateStr}</div>
                    </div>
                    <p class="text-sm text-stone-600 mb-2">${day.description || ''}</p>
                    
                    ${stagesExpandedHtml}

                    <div class="flex items-center gap-3 text-xs font-bold text-black border-t border-stone-100 pt-2 mt-3 overflow-x-auto whitespace-nowrap scrollbar-hide">
                        <span class="flex items-center gap-1"><i class="ph-fill ph-flag-checkered text-orange-600"></i> ${visitCount} Tappe</span>
                        ${tripCount > 0 ? `<span class="flex items-center gap-1"><i class="ph-fill ph-car text-orange-600"></i> ${tripCount} Road Trip</span>` : ''}
                        <span class="flex items-center gap-1"><i class="ph-fill ph-road-horizon text-orange-600"></i> ${totKm.toFixed(0)} km</span>
                        ${globalShowMiles ? `<span class="flex items-center gap-1 text-stone-400 font-mono">(${dayMiles.toFixed(0)} mi)</span>` : ''}
                    </div>
                    ${notesHtml}
                `;
                card.onclick = () => openDayDetail(day);
                list.appendChild(card);
            });

            // Update stats logic
            const elSummDrive = document.getElementById('summ-view-drive');
            if(elSummDrive) elSummDrive.textContent = minsToTimeStr(gDrive);
            const elSummMiles = document.getElementById('summ-view-miles');
            if(elSummMiles) elSummMiles.textContent = `${gMiles.toFixed(0)} mi`;
            const elSummKm = document.getElementById('summ-view-km');
            if(elSummKm) elSummKm.textContent = `${gKm.toFixed(0)} km`;
            
            const elStates = document.getElementById('summ-view-states');
            if(elStates) elStates.textContent = statesSet.size;
            const elStages = document.getElementById('summ-view-stages');
            if(elStages) elStages.textContent = visitedStagesCount;

            updateSummaryChart();
        };
        
        // NEW: Logica Spostamento Giorni (Scambio Date)
        window.moveDayUp = async (id) => {
            const index = cachedDays.findIndex(d => d.id === id);
            if (index > 0) {
                const currentDay = cachedDays[index];
                const prevDay = cachedDays[index - 1];
                
                // Swap dates
                const dateCurrent = currentDay.dateString;
                const datePrev = prevDay.dateString;
                
                try {
                    const batch = writeBatch(db);
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', daysColName);
                    
                    batch.update(doc(colRef, currentDay.id), { dateString: datePrev });
                    batch.update(doc(colRef, prevDay.id), { dateString: dateCurrent });
                    
                    await batch.commit();
                } catch(e) { console.error("Error moving day up", e); alert("Errore spostamento"); }
            }
        };

        window.moveDayDown = async (id) => {
            const index = cachedDays.findIndex(d => d.id === id);
            if (index < cachedDays.length - 1) {
                const currentDay = cachedDays[index];
                const nextDay = cachedDays[index + 1];
                
                // Swap dates
                const dateCurrent = currentDay.dateString;
                const dateNext = nextDay.dateString;
                
                try {
                    const batch = writeBatch(db);
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', daysColName);
                    
                    batch.update(doc(colRef, currentDay.id), { dateString: dateNext });
                    batch.update(doc(colRef, nextDay.id), { dateString: dateCurrent });
                    
                    await batch.commit();
                } catch(e) { console.error("Error moving day down", e); alert("Errore spostamento"); }
            }
        };

        const openDayDetail = (day) => {
            currentDayId = day.id;
            document.getElementById('days-view').classList.add('hidden');
            document.getElementById('notes-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.add('hidden'); 
            
            document.getElementById('header-title').textContent = `GIORNO ${day.chronoId} - ${day.title || ''}`;
            
            const detailContainer = document.getElementById('day-detail-content');
            let totMiles = 0, totKm = 0, totDrive = 0, dayDur = 0;
            const stages = day.stages || [];
            stages.forEach(s => { 
                if(!s.isVisit) {
                    totMiles += parseFloat(s.miles || 0); 
                    totKm += parseFloat(s.km || 0); 
                    totDrive += (s.driveTime || 0); 
                }
            });
            if(stages.length > 0) {
                 const sorted = [...stages].sort((a,b) => timeToMins(a.start) - timeToMins(b.start));
                 const f = timeToMins(sorted[0].start);
                 let l = 0; 
                 
                 const lastStage = sorted[sorted.length - 1];
                 if (lastStage.isVisit) {
                     // NEW LOGIC: If last is visit, end = start + pause
                     l = timeToMins(lastStage.start) + timeToMins(lastStage.pause);
                 } else {
                     l = timeToMins(lastStage.end);
                 }
                 
                 if(l < f) l += 1440; 
                 if(l > f) dayDur = l - f;
            }

            let stagesHtml = '';
            stages.forEach((s, idx) => {
                // MODIFICA: Logica Anteprima Mappa
                const safeUrl = getMapsUrl(s.mapsLink);
                
                let pauseDisplay = s.pause && s.pause !== '00:00' ? `<span class="flex items-center gap-1 text-amber-500 font-bold"><i class="ph-bold ph-coffee"></i> ${s.pause.replace(':', 'h ')}m</span>` : '<span class="text-stone-300 flex items-center gap-1"><i class="ph ph-coffee"></i> --</span>';
                
                let typeIcon = s.isVisit 
                    ? `<span class="text-orange-600 font-bold flex items-center gap-1 text-xs bg-orange-50 px-2 py-0.5 rounded-full border border-orange-100"><i class="ph-fill ph-ticket"></i> VISITA</span>` 
                    : `<span class="flex items-center gap-1 text-green-700 font-medium text-xs"><i class="ph-bold ph-car"></i> ${minsToTimeStr(s.driveTime)}</span>`;

                let kmDisplay = s.isVisit 
                    ? '' 
                    : `<div class="font-mono text-stone-400 text-xs">${parseFloat(s.km).toFixed(0)} km</div>`;

                let milesDisplay = (globalShowMiles && !s.isVisit) ? `<div class="font-mono text-stone-400 text-xs">${s.miles} mi</div>` : ''; 

                // NEW: Use Button Instead of Iframe Preview
                let mapButtonHtml = '';
                if (s.mapsLink) {
                    const safeUrl = getMapsUrl(s.mapsLink);
                    mapButtonHtml = `
                        <a href="${safeUrl}" target="_blank" class="block mt-3 w-full py-2 bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-200 rounded-lg text-center text-sm font-bold transition-colors flex items-center justify-center gap-2">
                            <i class="ph-fill ph-map-pin"></i> Vedi su Google Maps
                        </a>
                    `;
                }

                stagesHtml += `
                    <div class="border-b border-stone-100 last:border-0">
                        <div class="p-3 bg-white hover:bg-stone-50 cursor-pointer flex flex-col gap-2" onclick="document.getElementById('stage-detail-${idx}').classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('rotate-180')">
                            <div class="flex justify-between items-start">
                                <div class="font-bold text-stone-800 text-sm flex items-center gap-1"><span class="text-orange-500 mr-1">${idx + 1}.</span> ${s.name}</div>
                                <div class="text-xs text-stone-500 font-mono bg-stone-100 px-2 py-1 rounded">${s.start} <span class="text-stone-300">➜</span> ${s.end}</div>
                            </div>
                            <div class="flex items-center justify-between text-xs text-stone-500 mt-1">
                                <div class="flex gap-3 items-center">
                                    ${typeIcon}
                                    ${pauseDisplay}
                                </div>
                                <div class="text-right">
                                    ${kmDisplay}
                                    ${milesDisplay}
                                </div>
                            </div>
                            <div class="flex justify-center -mt-2 opacity-50"><i class="chevron ph-bold ph-caret-down text-stone-400 transition-transform duration-200 rotate-180"></i></div>
                        </div>
                        <div id="stage-detail-${idx}" class="bg-stone-50 p-4 text-sm text-stone-700 border-t border-stone-100 shadow-inner">
                            <div class="mb-2"><span class="text-[10px] uppercase font-bold text-stone-400">Descrizione</span><p class="mt-1">${s.desc || '<span class="italic text-stone-400">Nessuna descrizione.</span>'}</p></div>
                            ${!s.isVisit ? `<div class="flex gap-4 text-xs font-mono text-stone-500 border-t border-stone-200 pt-2 mt-2">
                                ${globalShowMiles ? `<div>Miglia: <span class="font-bold text-stone-800">${s.miles}</span></div>` : ''}
                                <div>Km esatti: <span class="font-bold text-stone-800">${s.km}</span></div>
                            </div>` : ''}
                            ${mapButtonHtml} 
                        </div>
                    </div>`;
            });

            // Adjust grid columns based on miles visibility
            const gridCols = globalShowMiles ? 'grid-cols-4' : 'grid-cols-3';
            const milesStat = globalShowMiles ? `<div><div class="text-[10px] text-stone-400 uppercase">Miglia</div><div class="font-bold text-sm sm:text-base">${totMiles.toFixed(1)}</div></div>` : '';

            // NEW: Add formatted date display logic
            let dateDisplay = 'Data non impostata';
            if(day.dateString) {
                const d = new Date(day.dateString);
                dateDisplay = d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            // MODIFICA: Aggiunti pulsanti Modifica/Elimina in cima alla vista dettaglio e DATA
            detailContainer.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-2">
                    <div class="text-lg font-bold text-orange-500">${dateDisplay}</div>
                    <div class="flex gap-2">
                        <button onclick="editDayFromDetail('${day.id}')" class="px-3 py-1.5 bg-orange-50 text-orange-600 border border-orange-100 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-orange-100 transition-colors"><i class="ph-bold ph-pencil-simple"></i> Modifica</button>
                        <button onclick="deleteDayFromDetail('${day.id}')" class="px-3 py-1.5 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-red-100 transition-colors"><i class="ph-bold ph-trash"></i> Elimina</button>
                    </div>
                </div>
                <div class="mb-4"><p class="text-stone-600 text-sm italic border-l-4 border-orange-400 pl-3 py-1 bg-orange-50/50 rounded-r">${day.description || 'Nessuna descrizione generale.'}</p></div>
                
                <div class="mb-6">
                     <h4 class="text-xs font-bold text-stone-400 uppercase mb-2 flex items-center gap-2">
                        <i class="ph ph-note"></i> Note
                    </h4>
                    <div id="loading-notes" class="hidden flex justify-center py-2"><div class="loader w-4 h-4 border-t-orange-400"></div></div>
                    <div id="empty-notes" class="hidden text-center py-2 text-stone-400 text-xs italic">Nessuna nota aggiunta.</div>
                    <ul id="notes-list" class="space-y-2"></ul>
                </div>

                <div class="bg-gradient-to-r from-stone-800 to-stone-900 text-white rounded-xl p-4 shadow-lg mb-6">
                    <div class="grid ${gridCols} gap-2 text-center divide-x divide-stone-700">
                        <div><div class="text-[10px] text-stone-400 uppercase">Auto</div><div class="font-bold text-amber-400 text-sm sm:text-base">${minsToTimeStr(totDrive)}</div></div>
                        <div><div class="text-[10px] text-stone-400 uppercase">Durata</div><div class="font-bold text-sm sm:text-base">${minsToTimeStr(dayDur)}</div></div>
                        ${milesStat}
                        <div><div class="text-[10px] text-stone-400 uppercase">Km</div><div class="font-bold text-green-400 text-sm sm:text-base">${totKm.toFixed(1)}</div></div>
                    </div>
                </div>
                <h4 class="text-xs font-bold text-stone-400 uppercase mb-2">Piano di Viaggio (Clicca per espandere)</h4>
                <div class="rounded-lg border border-stone-200 bg-white overflow-hidden shadow-sm">${stagesHtml || '<div class="p-4 text-center text-stone-400 text-xs">Nessuna tappa inserita.</div>'}</div>
            `;
            loadNotes(day.id);
            // SCROLL RESET FOR DETAIL VIEW
            document.getElementById('notes-list-container').scrollTop = 0;
        };

        // NEW HELPERS FOR DETAIL VIEW EDIT/DELETE
        window.editDayFromDetail = (id) => {
            const day = cachedDays.find(d => d.id === id);
            if(day) openModal(day);
        };

        window.deleteDayFromDetail = async (id) => {
            if(confirm('Eliminare questa giornata e tutti i suoi dati?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', daysColName, id));
                    document.getElementById('back-btn').click(); // Return to list
                } catch(e) {
                    console.error(e);
                    alert("Errore durante l'eliminazione");
                }
            }
        };

        document.getElementById('back-btn').onclick = () => {
            document.getElementById('days-view').classList.remove('hidden');
            document.getElementById('notes-view').classList.add('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden'); // Show Nav back
            document.getElementById('header-title').textContent = "Travel Planner";
            if(unsubscribeNotes) unsubscribeNotes();
            // SCROLL RESET FOR DAYS LIST
            document.getElementById('days-list-container').scrollTop = 0;
        };

        const loadNotes = (dayId) => {
            const list = document.getElementById('notes-list'); 
            const loader = document.getElementById('loading-notes');
            const empty = document.getElementById('empty-notes');
            
            if(!list) return; 

            list.innerHTML = '';
            loader.classList.remove('hidden');
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', notesColName), where('dayId', '==', dayId));
            unsubscribeNotes = onSnapshot(q, (snapshot) => {
                loader.classList.add('hidden'); 
                list.innerHTML = '';
                const notes = []; 
                snapshot.forEach(d => notes.push({id: d.id, ...d.data()}));
                notes.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                if(notes.length === 0) empty.classList.remove('hidden');
                else empty.classList.add('hidden');
                
                notes.forEach(n => {
                    const li = document.createElement('li'); 
                    li.className = "bg-yellow-100 p-3 rounded-lg text-sm text-stone-800 flex justify-between group shadow-sm border border-yellow-200";
                    li.innerHTML = `<span>${n.text}</span> <button class="text-stone-400 hover:text-red-600 opacity-0 group-hover:opacity-100" onclick="deleteNote('${n.id}')"><i class="ph ph-trash"></i></button>`;
                    list.appendChild(li);
                });
                window.deleteNote = (id) => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', notesColName, id));
            }, () => loader.classList.add('hidden'));
        };

        document.getElementById('add-note-btn').onclick = async () => {
            const txt = document.getElementById('note-input').value.trim();
            if(!txt || !currentDayId) return;
            document.getElementById('note-input').value = '';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', notesColName), { dayId: currentDayId, text: txt, createdAt: serverTimestamp() });
        };
        
        // --- TRAVEL REEL (VIDEO) LOGIC ---
        let mapInstance = null;
        let carMarker = null;
        let routePolyline = null;
        let isPlaying = false;
        let animInterval = null; // Store interval ID globally for clearing
        let videoSpeed = 1; // Default speed
        
        // Icona Auto Custom
        const carIcon = L.divIcon({
            html: '<div class="bg-orange-500 text-white p-1 rounded-full shadow-lg border-2 border-white flex items-center justify-center w-8 h-8"><i class="ph-fill ph-car-profile text-lg"></i></div>',
            className: 'car-icon-div',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        // Delay helper
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        
        // Functions for UI controls
        window.setVideoSpeed = (speed) => {
            videoSpeed = speed;
            // Update UI
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-black');
                btn.classList.add('hover:bg-white/30', 'text-white'); // Reset active style
            });
            
            // Set active
            const btnId = speed === 0.5 ? 'btn-speed-05' : (speed === 2 ? 'btn-speed-2' : 'btn-speed-1');
            const activeBtn = document.getElementById(btnId);
            if(activeBtn) {
                activeBtn.classList.remove('hover:bg-white/30', 'text-white');
                activeBtn.classList.add('bg-white', 'text-black');
            }
        };
        
        window.toggleVideoFullscreen = () => {
            const container = document.getElementById('map-video-container');
            const isFakeFullscreen = container.classList.contains('fixed');

            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else if (isFakeFullscreen) {
                 // Exit Fake Fullscreen
                 container.classList.remove('fixed', 'inset-0', 'z-[60]', 'h-screen', 'w-screen', 'rounded-none');
                 container.classList.add('h-64', 'rounded-xl', 'mb-4');
                 if(mapInstance) setTimeout(() => { mapInstance.invalidateSize(); }, 100);
            } else {
                // Try Native Fullscreen
                container.requestFullscreen().catch(err => {
                    console.warn("Native fullscreen failed, using CSS fallback:", err);
                    // Enter Fake Fullscreen
                    container.classList.remove('h-64', 'rounded-xl', 'mb-4');
                    container.classList.add('fixed', 'inset-0', 'z-[60]', 'h-screen', 'w-screen', 'rounded-none');
                    if(mapInstance) setTimeout(() => { mapInstance.invalidateSize(); }, 100);
                });
            }
        };

        // Listen for fullscreen change to resize map
        document.addEventListener('fullscreenchange', () => {
             if(mapInstance) {
                 setTimeout(() => { mapInstance.invalidateSize(); }, 100);
             }
        });

        window.playTravelVideo = async () => {
            const container = document.getElementById('map-video-container');
            const overlay = document.getElementById('video-overlay-msg');
            const statusText = document.getElementById('video-status-text');
            const btn = document.getElementById('play-video-btn');

            if (isPlaying) return;
            isPlaying = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            container.classList.remove('hidden');
            
            // Init map if needed
            if (!mapInstance) {
                mapInstance = L.map('travel-video-map', { zoomControl: false }).setView([41.9028, 12.4964], 5);
                L.control.zoom({ position: 'bottomright' }).addTo(mapInstance); 
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(mapInstance);
            }

            // Reset
            if (carMarker) mapInstance.removeLayer(carMarker);
            if (routePolyline) mapInstance.removeLayer(routePolyline);
            overlay.classList.remove('hidden');
            statusText.textContent = "Analisi tappe...";

            // 1. Gather all locations sequentially
            const allStages = [];
            cachedDays.sort((a,b) => a.chronoId - b.chronoId).forEach(day => {
                 if(day.stages) day.stages.forEach(s => {
                     if (s.name) {
                         let query = s.name;
                         if (day.title) query += `, ${day.title}`;
                         allStages.push({ query: query, name: s.name });
                     }
                 });
            });

            if (allStages.length < 2) {
                statusText.textContent = "Aggiungi almeno 2 tappe per il video!";
                setTimeout(() => { overlay.classList.add('hidden'); isPlaying = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }, 2000);
                return;
            }

            // 2. Geocode (Nominatim) - Sequential to be polite
            const coords = [];
            statusText.textContent = `Geocoding 0/${allStages.length}...`;
            
            for (let i = 0; i < allStages.length; i++) {
                const stage = allStages[i];
                statusText.textContent = `Trovo: ${stage.name}...`;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(stage.query)}&limit=1`);
                    if(res.ok) {
                        const data = await res.json();
                        if(data && data.length > 0) {
                            coords.push([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
                        }
                    }
                } catch(e) { console.error(e); }
                await sleep(800); // Polite delay
            }

            if (coords.length < 2) {
                statusText.textContent = "Impossibile trovare coordinate sufficienti.";
                setTimeout(() => { overlay.classList.add('hidden'); isPlaying = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }, 2000);
                return;
            }

            // 3. Routing (OSRM) - Use road network
            statusText.textContent = "Calcolo percorso stradale...";
            let pathPoints = [];

            const osrmCoords = coords.map(c => `${c[1]},${c[0]}`).join(';');
            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${osrmCoords}?overview=full&geometries=geojson`;

            try {
                const routeRes = await fetch(osrmUrl);
                if (routeRes.ok) {
                    const routeData = await routeRes.json();
                    if (routeData.routes && routeData.routes.length > 0) {
                        pathPoints = routeData.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    }
                }
            } catch(e) {
                console.warn("OSRM failed, falling back to straight lines");
            }
            
            // Fallback to straight lines if OSRM fails or returns empty
            if (pathPoints.length === 0) {
                 if (coords.length > 1) {
                    for (let i = 0; i < coords.length - 1; i++) {
                        const start = coords[i];
                        const end = coords[i+1];
                        const steps = 100; 
                        for (let j = 0; j <= steps; j++) {
                            const lat = start[0] + (end[0] - start[0]) * (j / steps);
                            const lng = start[1] + (end[1] - start[1]) * (j / steps);
                            pathPoints.push([lat, lng]);
                        }
                    }
                } else if (coords.length === 1) {
                    pathPoints.push(coords[0]);
                }
            }

            // Pre-calculate cumulative distances for fluid animation
            let totalDist = 0;
            const dists = [0]; // Cumulative distances at each point
            for (let i = 0; i < pathPoints.length - 1; i++) {
                const p1 = L.latLng(pathPoints[i]);
                const p2 = L.latLng(pathPoints[i+1]);
                const d = p1.distanceTo(p2);
                totalDist += d;
                dists.push(totalDist);
            }

            // 4. Setup Map & Animation
            statusText.textContent = "Pronti a partire!";
            await sleep(500);
            overlay.classList.add('hidden');

            // Draw route
            routePolyline = L.polyline(pathPoints, { color: '#fb923c', weight: 4, opacity: 0.8 }).addTo(mapInstance);
            
            // Set initial view
            mapInstance.setView(pathPoints[0], 10); 
            
            // Init Car
            carMarker = L.marker(pathPoints[0], { icon: carIcon }).addTo(mapInstance);

            // AGGIUNTA PAUSA INIZIALE PER VISUALIZZARE PARTENZA
            await sleep(2000);

            // Animate using Distance interpolation for fluidity
            const duration = 80000; // 80 seconds
            const intervalTime = 20; // 50fps
            const baseDistPerStep = totalDist / (duration / intervalTime);
            let traveled = 0;

            if (animInterval) clearInterval(animInterval);

            animInterval = setInterval(() => {
                // Apply speed multiplier
                traveled += baseDistPerStep * videoSpeed;
                
                if (traveled >= totalDist) {
                    // End
                    carMarker.setLatLng(pathPoints[pathPoints.length - 1]);
                    clearInterval(animInterval);
                    isPlaying = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }

                // Find current segment index based on distance
                // Simple linear search is okay for this scale, can be optimized with binary search if needed
                let idx = 0;
                for (let i = 0; i < dists.length - 1; i++) {
                    if (traveled >= dists[i] && traveled < dists[i+1]) {
                        idx = i;
                        break;
                    }
                }

                // Interpolate within segment
                const segmentLen = dists[idx+1] - dists[idx];
                const segmentProgress = traveled - dists[idx];
                const percent = segmentLen === 0 ? 0 : segmentProgress / segmentLen;
                
                const p1 = pathPoints[idx];
                const p2 = pathPoints[idx+1];
                const lat = p1[0] + (p2[0] - p1[0]) * percent;
                const lng = p1[1] + (p2[1] - p1[1]) * percent;
                const pos = [lat, lng];

                carMarker.setLatLng(pos);
                
                // Update view without forcing zoom level (keeps user zoom)
                // Only pan if car is getting close to edge? Or just setView every frame?
                // setView every frame at 50fps might be heavy but usually smooth on modern browsers
                mapInstance.setView(pos, mapInstance.getZoom(), { animate: false }); 
            }, intervalTime);
        };
    </script>
</body>
</html>
